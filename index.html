<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Premium Vape Store</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        :root {
            --primary: #00FF41;
            --primary-glow: rgba(0, 255, 65, 0.4);
            --bg-dark: #000000;
            --card-bg: rgba(10, 10, 10, 0.7);
            --border: rgba(255, 255, 255, 0.05);
        }

        body {
            background-color: var(--bg-dark);
            color: #ffffff;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ª–æ–∞–¥–µ—Ä (–ê–±—Å–æ–ª—é—Ç–Ω—ã–π —Ñ–∏–∫—Å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏) */
        #initial-loader {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s ease;
        }

        .loader-bar {
            width: 140px;
            height: 2px;
            background: rgba(255,255,255,0.05);
            position: relative;
            overflow: hidden;
        }

        .loader-progress {
            position: absolute;
            height: 100%;
            width: 40%;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
            animation: loading 1.5s infinite ease-in-out;
        }

        @keyframes loading {
            0% { left: -40%; }
            100% { left: 100%; }
        }

        #bg-canvas {
            position: fixed;
            inset: 0;
            z-index: -1;
        }

        /* Premium Glass 3.0 */
        .premium-card {
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .premium-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, transparent 100%);
            pointer-events: none;
        }

        .primary-glow-text {
            text-shadow: 0 0 15px var(--primary-glow);
        }

        .primary-bg { background: var(--primary); }
        .primary-text { color: var(--primary); }
        
        .category-tab {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .category-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .sheet-up { transform: translateY(0); transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .sheet-down { transform: translateY(100%); transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="initial-loader">
        <div class="loader-bar"><div class="loader-progress"></div></div>
        <div class="mt-4 text-[9px] tracking-[0.5em] uppercase font-bold opacity-30">Authenticating...</div>
    </div>

    <canvas id="bg-canvas"></canvas>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vape-ultra-premium';

        const ADMIN_ID = 1262669099;

        const THEMES = [
            { name: 'Toxic Green', color: '#00FF41', glow: 'rgba(0, 255, 65, 0.4)' },
            { name: 'Ice Blue', color: '#00F0FF', glow: 'rgba(0, 240, 255, 0.4)' },
            { name: 'Magma Red', color: '#FF3E00', glow: 'rgba(255, 62, 0, 0.4)' }
        ];

        const SEED_DATA = [
            { name: "HQD Cuvie Plus", price: 950, emoji: "üíé", category: "Disposable", desc: "1200 –∑–∞—Ç—è–∂–µ–∫ | Premium Edition" },
            { name: "Elf Bar BC5000", price: 1450, emoji: "üîã", category: "Disposable", desc: "5000 –∑–∞—Ç—è–∂–µ–∫ | Type-C" },
            { name: "Lost Mary OS5000", price: 1350, emoji: "üîã", category: "Disposable", desc: "Mesh Coil | Intense Flavor" },
            { name: "Vaporesso XROS 3", price: 3400, emoji: "üõ†Ô∏è", category: "Pod Systems", desc: "Top Fill | Airflow Control" },
            { name: "Smoant Santi", price: 2400, emoji: "‚ö°", category: "Pod Systems", desc: "ANT Chip | 1100mAh" },
            { name: "Maxwells Shoria", price: 800, emoji: "üß™", category: "Liquids", desc: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è —Ö–≤–æ—è –∏ —è–≥–æ–¥—ã" },
            { name: "Husky White", price: 650, emoji: "üê∫", category: "Liquids", desc: "Double Ice | 20mg Strong" },
            { name: "XROS Cartridge", price: 400, emoji: "üì¶", category: "Accessory", desc: "0.6 / 0.8 Ohm | 2ml" },
            { name: "Waka SoPro 10k", price: 2200, emoji: "üî•", category: "Disposable", desc: "10000 Puffs | Boost Mode" }
        ];

        // --- Cyber Fluid Background Engine ---
        const initCyberFluid = (color) => {
            const canvas = document.getElementById('bg-canvas');
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // Geometry - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å–µ—Ç–∫–∞
            const geometry = new THREE.PlaneGeometry(20, 20, 64, 64);
            const material = new THREE.MeshStandardMaterial({
                color: new THREE.Color(color),
                wireframe: true,
                transparent: true,
                opacity: 0.15,
                emissive: new THREE.Color(color),
                emissiveIntensity: 0.5
            });

            const mesh = new THREE.Mesh(geometry, material);
            mesh.rotation.x = -Math.PI / 3;
            scene.add(mesh);

            const light = new THREE.PointLight(color, 2, 50);
            light.position.set(0, 5, 5);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x111111));

            let time = 0;
            const animate = () => {
                requestAnimationFrame(animate);
                time += 0.005;
                const pos = geometry.attributes.position.array;
                for (let i = 0; i < pos.length; i += 3) {
                    const x = pos[i];
                    const y = pos[i + 1];
                    pos[i + 2] = Math.sin(x * 0.5 + time) * Math.cos(y * 0.5 + time) * 0.8;
                }
                geometry.attributes.position.needsUpdate = true;
                renderer.render(scene, camera);
            };
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            return { material, light };
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [products, setProducts] = useState(SEED_DATA);
            const [cart, setCart] = useState({});
            const [activeCategory, setActiveCategory] = useState("–í—Å–µ");
            const [themeIndex, setThemeIndex] = useState(0);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isCartOpen, setIsCartOpen] = useState(false);
            const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
            const [view, setView] = useState('catalog');
            const engineRef = useRef(null);
            const tg = window.Telegram?.WebApp;

            useEffect(() => {
                engineRef.current = initCyberFluid(THEMES[0].color);
                
                // Safety Break for Loader: –£–¥–∞–ª—è–µ–º –ª–æ–∞–¥–µ—Ä —á–µ—Ä–µ–∑ 2.5 —Å–µ–∫—É–Ω–¥—ã –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
                const safetyTimeout = setTimeout(() => {
                    const ldr = document.getElementById('initial-loader');
                    if(ldr) { ldr.style.opacity = '0'; setTimeout(() => ldr.remove(), 800); }
                }, 2500);

                if (tg) {
                    tg.expand();
                    tg.backgroundColor = "#000000";
                    tg.headerColor = "#000000";
                    if (tg.initDataUnsafe?.user?.id === ADMIN_ID) setIsAdmin(true);
                }

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error("Auth Failed", e); }
                };
                initAuth();
                const unsubAuth = onAuthStateChanged(auth, setUser);

                return () => { clearTimeout(safetyTimeout); unsubAuth(); };
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
                return onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    } else if (isAdmin) {
                        SEED_DATA.forEach(item => addDoc(q, item));
                    }
                }, (err) => console.error("Snapshot error:", err));
            }, [user, isAdmin]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const categories = useMemo(() => ["–í—Å–µ", ...new Set(products.map(p => p.category))], [products]);
            const filteredProducts = products.filter(p => activeCategory === "–í—Å–µ" || p.category === activeCategory);

            const toggleTheme = () => {
                const next = (themeIndex + 1) % THEMES.length;
                setThemeIndex(next);
                const theme = THEMES[next];
                document.documentElement.style.setProperty('--primary', theme.color);
                document.documentElement.style.setProperty('--primary-glow', theme.glow);
                if (engineRef.current) {
                    engineRef.current.material.color.set(theme.color);
                    engineRef.current.material.emissive.set(theme.color);
                    engineRef.current.light.color.set(theme.color);
                }
                if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            };

            const totalAmount = Object.entries(cart).reduce((sum, [id, qty]) => {
                const p = products.find(x => x.id === id || x.name === id);
                return sum + (p ? p.price * qty : 0);
            }, 0);

            const cartCount = Object.values(cart).reduce((a, b) => a + b, 0);

            return React.createElement('div', { className: 'min-h-screen p-5 pb-32 max-w-xl mx-auto' },
                // Header
                React.createElement('header', { className: 'flex justify-between items-center mb-10 sticky top-0 z-50 py-4 bg-black/40 backdrop-blur-xl -mx-5 px-5' },
                    React.createElement('div', null,
                        React.createElement('h1', { className: 'text-2xl font-black italic tracking-tighter primary-glow-text' }, 'ULTRA VAPE'),
                        React.createElement('div', { className: 'flex items-center gap-2 mt-1' },
                            React.createElement('div', { className: `w-1 h-1 rounded-full ${isAdmin ? 'primary-bg animate-pulse' : 'bg-white/20'}` }),
                            React.createElement('span', { className: 'text-[8px] uppercase tracking-[0.4em] font-bold opacity-40' }, isAdmin ? 'Admin Active' : 'Premium Store')
                        )
                    ),
                    React.createElement('div', { className: 'flex gap-3' },
                        isAdmin && React.createElement('button', { 
                            onClick: () => {
                                const name = prompt("Name:");
                                if(name) addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), {
                                    name, price: 1000, emoji: "üÜï", category: "New", desc: "Added by Admin"
                                });
                            },
                            className: 'w-11 h-11 premium-card rounded-2xl flex items-center justify-center' 
                        }, React.createElement('i', { 'data-lucide': 'plus', className: 'w-5 h-5 primary-text' })),
                        React.createElement('button', { onClick: toggleTheme, className: 'w-11 h-11 premium-card rounded-2xl flex items-center justify-center' },
                            React.createElement('i', { 'data-lucide': 'palette', className: 'w-5 h-5' }))
                    )
                ),

                // Categories
                React.createElement('div', { className: 'flex gap-6 overflow-x-auto no-scrollbar mb-10 pb-2 border-b border-white/5' },
                    categories.map(cat => React.createElement('button', {
                        key: cat,
                        onClick: () => { setActiveCategory(cat); if(tg?.HapticFeedback) tg.HapticFeedback.selectionChanged(); },
                        className: `category-tab text-[10px] font-black uppercase tracking-widest whitespace-nowrap pb-2 ${activeCategory === cat ? 'active' : 'opacity-30'}`
                    }, cat))
                ),

                // Product Grid
                React.createElement('div', { className: 'grid grid-cols-2 gap-5' },
                    filteredProducts.map(p => React.createElement('div', { 
                        key: p.id || p.name,
                        className: 'premium-card rounded-[36px] p-6 flex flex-col relative overflow-hidden group'
                    },
                        isAdmin && React.createElement('button', {
                            onClick: () => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', p.id)),
                            className: 'absolute top-3 right-3 p-2 bg-red-500/10 text-red-500 rounded-full z-10'
                        }, React.createElement('i', { 'data-lucide': 'trash', className: 'w-3.5 h-3.5' })),

                        React.createElement('div', { className: 'text-5xl mb-6 text-center drop-shadow-[0_0_15px_rgba(255,255,255,0.1)]' }, p.emoji),
                        
                        React.createElement('div', { className: 'flex-grow' },
                            React.createElement('div', { className: 'text-[8px] uppercase tracking-widest primary-text font-bold mb-2' }, p.category),
                            React.createElement('h3', { className: 'font-bold text-sm leading-tight mb-2' }, p.name),
                            React.createElement('p', { className: 'text-[10px] opacity-40 leading-snug font-medium mb-4 line-clamp-2' }, p.desc)
                        ),

                        React.createElement('div', { className: 'mt-auto' },
                            React.createElement('div', { className: 'text-lg font-black mb-3 tracking-tighter' }, `${p.price} ‚ÇΩ`),
                            React.createElement('button', {
                                onClick: () => {
                                    setCart(prev => ({ ...prev, [p.id || p.name]: (prev[p.id || p.name] || 0) + 1 }));
                                    if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
                                },
                                className: 'w-full py-3.5 primary-bg text-black text-[10px] font-black uppercase rounded-2xl active:scale-95 transition-all shadow-xl shadow-black/40'
                            }, '–î–æ–±–∞–≤–∏—Ç—å')
                        )
                    ))
                ),

                // Floating Cart Button
                cartCount > 0 && React.createElement('div', { className: 'fixed bottom-10 left-5 right-5 z-[60]' },
                    React.createElement('button', {
                        onClick: () => setIsCartOpen(true),
                        className: 'w-full py-5 primary-bg text-black rounded-[28px] flex justify-between px-8 items-center shadow-2xl active:scale-95 transition-transform'
                    },
                        React.createElement('div', { className: 'flex gap-4 items-center' },
                            React.createElement('i', { 'data-lucide': 'shopping-bag', className: 'w-6 h-6' }),
                            React.createElement('span', { className: 'font-black uppercase tracking-tighter' }, '–í–∞—à –∑–∞–∫–∞–∑')
                        ),
                        React.createElement('div', { className: 'flex items-center gap-3' },
                            React.createElement('span', { className: 'bg-black/10 px-2 rounded-lg text-xs font-black' }, cartCount),
                            React.createElement('span', { className: 'font-black text-xl tracking-tighter' }, `${totalAmount} ‚ÇΩ`)
                        )
                    )
                ),

                // Cart Sheet
                React.createElement('div', { 
                    className: `fixed inset-0 bg-black/90 z-[100] transition-opacity duration-500 ${isCartOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}` ,
                    onClick: () => setIsCartOpen(false)
                },
                    React.createElement('div', { 
                        className: `fixed bottom-0 left-0 right-0 premium-card rounded-t-[50px] p-10 max-h-[85vh] overflow-y-auto z-[101] ${isCartOpen ? 'sheet-up' : 'sheet-down'}`,
                        onClick: e => e.stopPropagation()
                    },
                        React.createElement('div', { className: 'w-20 h-1 bg-white/10 rounded-full mx-auto mb-10' }),
                        React.createElement('h2', { className: 'text-3xl font-black italic mb-8' }, '–ö–û–†–ó–ò–ù–ê'),
                        
                        React.createElement('div', { className: 'space-y-4 mb-10' },
                            Object.entries(cart).map(([id, qty]) => {
                                const p = products.find(x => x.id === id || x.name === id);
                                if (!p) return null;
                                return React.createElement('div', { key: id, className: 'flex items-center justify-between bg-white/[0.02] p-5 rounded-3xl border border-white/5' },
                                    React.createElement('div', null,
                                        React.createElement('div', { className: 'text-sm font-bold' }, p.name),
                                        React.createElement('div', { className: 'text-xs primary-text font-black mt-1' }, `${p.price * qty} ‚ÇΩ`)
                                    ),
                                    React.createElement('div', { className: 'flex items-center gap-5' },
                                        React.createElement('button', { 
                                            onClick: () => setCart(prev => { const n={...prev}; if(n[id]>1) n[id]--; else delete n[id]; return n; }),
                                            className: 'w-9 h-9 rounded-xl bg-white/5 flex items-center justify-center font-bold' 
                                        }, '-'),
                                        React.createElement('span', { className: 'font-black' }, qty),
                                        React.createElement('button', { 
                                            onClick: () => setCart(prev => ({...prev, [id]: prev[id]+1})),
                                            className: 'w-9 h-9 rounded-xl bg-white/5 flex items-center justify-center font-bold' 
                                        }, '+')
                                    )
                                );
                            })
                        ),

                        React.createElement('button', {
                            onClick: () => { setIsCartOpen(false); setIsCheckoutOpen(true); },
                            className: 'w-full py-5 primary-bg text-black font-black uppercase rounded-[28px] shadow-xl'
                        }, '–ö –æ–ø–ª–∞—Ç–µ')
                    )
                ),

                // Payment Modal
                isCheckoutOpen && React.createElement('div', { className: 'fixed inset-0 bg-black z-[200] p-8 fade-in overflow-y-auto' },
                    React.createElement('button', { onClick: () => setIsCheckoutOpen(false), className: 'mb-12 opacity-30 uppercase font-black tracking-widest text-[10px]' }, '‚Üê –ù–∞–∑–∞–¥'),
                    React.createElement('h2', { className: 'text-4xl font-black italic mb-6 primary-glow-text' }, '–û–ü–õ–ê–¢–ê'),
                    React.createElement('div', { className: 'premium-card p-10 rounded-[44px] mb-8 relative overflow-hidden' },
                        React.createElement('div', { className: 'text-[10px] opacity-40 uppercase tracking-[0.3em] mb-4' }, '–°—É–º–º–∞ –∫ –ø–µ—Ä–µ–≤–æ–¥—É'),
                        React.createElement('div', { className: 'text-6xl font-black primary-text mb-12 tracking-tighter' }, `${totalAmount} ‚ÇΩ`),
                        
                        React.createElement('div', { className: 'space-y-6' },
                            React.createElement('div', { className: 'p-6 bg-white/[0.03] rounded-[32px] border border-white/10' },
                                React.createElement('div', { className: 'text-[10px] opacity-30 uppercase mb-4' }, '–†–µ–∫–≤–∏–∑–∏—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∞'),
                                React.createElement('div', { className: 'font-mono text-xl tracking-widest' }, '2204 3209 2444 1944'),
                                React.createElement('div', { className: 'text-[11px] font-bold mt-2 opacity-60' }, 'Ozon –ë–∞–Ω–∫ | –ò–≤–∞–Ω –í.')
                            ),
                            React.createElement('div', { className: 'p-6 primary-bg/10 rounded-[32px] border border-dashed primary-border' },
                                React.createElement('div', { className: 'text-[10px] primary-text uppercase mb-2 font-black' }, '–£–∫–∞–∂–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:'),
                                React.createElement('div', { className: 'text-4xl font-black tracking-[0.2em]' }, `VX-${Math.floor(1000 + Math.random() * 9000)}`)
                            )
                        )
                    ),
                    React.createElement('button', {
                        onClick: () => {
                            if(tg) tg.sendData(JSON.stringify({paid: true, total: totalAmount}));
                            setCart({}); setIsCheckoutOpen(false);
                        },
                        className: 'w-full py-6 primary-bg text-black font-black uppercase rounded-[32px] primary-shadow'
                    }, '–û–ø–ª–∞—Ç–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞')
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
