<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vape Premium Store</title>
    <!-- Tailwind & Lucide -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDocs, onSnapshot, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // CONFIGS PROVIDED BY ENVIRONMENT
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vape-premium-tma';
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Management
        let state = {
            user: null,
            isAdmin: false,
            items: [],
            cart: [],
            currentCategory: '–í—Å–µ',
            theme: 'toxic', // toxic, ice, magma
            isCartOpen: false,
            isCheckoutOpen: false,
            checkoutStep: 1,
            loading: true
        };

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // Admin Info
        const ADMIN_ID = "1262669099";
        const ADMIN_USERNAME = "Tru5tNoBody";

        // UI Helpers
        const haptic = (type = 'light') => {
            if (tg.HapticFeedback) {
                if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
                else if (type === 'error') tg.HapticFeedback.notificationOccurred('error');
                else tg.HapticFeedback.impactOccurred(type);
            }
        };

        // DOM Elements
        const $ = (id) => document.getElementById(id);

        // --- THEMES ---
        const themes = {
            toxic: { primary: '#00ff41', glow: 'rgba(0, 255, 65, 0.3)' },
            ice: { primary: '#00d4ff', glow: 'rgba(0, 212, 255, 0.3)' },
            magma: { primary: '#ff4e00', glow: 'rgba(255, 78, 0, 0.3)' }
        };

        function applyTheme(themeName) {
            state.theme = themeName;
            const theme = themes[themeName];
            document.documentElement.style.setProperty('--primary', theme.primary);
            document.documentElement.style.setProperty('--primary-glow', theme.glow);
            render();
        }

        // --- FIREBASE LOGIC ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth error", e);
            }
        }

        function checkAdmin() {
            const user = tg.initDataUnsafe?.user;
            if (user && (user.id.toString() === ADMIN_ID || user.username === ADMIN_USERNAME)) {
                state.isAdmin = true;
            } else {
                // Fallback parsing from hash if SDK is slow
                const hashData = new URLSearchParams(window.location.hash.slice(1));
                try {
                    const tgData = JSON.parse(hashData.get('tgWebAppData'));
                    if (tgData?.user?.id?.toString() === ADMIN_ID) state.isAdmin = true;
                } catch(e) {}
            }
            render();
        }

        async function seedDatabase() {
            if (!state.isAdmin) return;
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            const snapshot = await getDocs(collectionRef);
            
            if (snapshot.empty) {
                const starterItems = [
                    { name: "HQD Cuvie Plus", price: 850, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", icon: "üí®", desc: "1200 –∑–∞—Ç—è–∂–µ–∫, –ß–µ—Ä–Ω–∏–∫–∞" },
                    { name: "Elf Bar BC5000", price: 1200, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", icon: "üçì", desc: "5000 –∑–∞—Ç—è–∂–µ–∫, –ö–ª—É–±–Ω–∏–∫–∞-–ú–∞–Ω–≥–æ" },
                    { name: "Vaporesso XROS 3", price: 2900, category: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", icon: "üîã", desc: "–õ—É—á—à–∞—è POD-—Å–∏—Å—Ç–µ–º–∞ 2024" },
                    { name: "Maxwell's Shoria", price: 650, category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", icon: "üå≤", desc: "–•–≤–æ—è, –º—è—Ç–∞, –ª–µ—Å–Ω—ã–µ —è–≥–æ–¥—ã" },
                    { name: "Brusko Minican", price: 1500, category: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", icon: "üîå", desc: "–ö–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å –∏ –≤–∫—É—Å" },
                    { name: "Husky Double Ice", price: 550, category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", icon: "üßä", desc: "–ê—Ä–±—É–∑ —Å –º–æ—â–Ω—ã–º —Ö–æ–ª–æ–¥–æ–º" },
                    { name: "–ò—Å–ø–∞—Ä–∏—Ç–µ–ª—å XROS", price: 350, category: "–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏", icon: "‚öôÔ∏è", desc: "0.6 / 0.8 / 1.0 –û–º" },
                    { name: "Lost Mary OS5000", price: 1100, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", icon: "üçí", desc: "–í–∏—à–Ω—è-–ü–µ—Ä—Å–∏–∫-–õ–∏–º–æ–Ω–∞–¥" },
                    { name: "Angry Vape", price: 500, category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", icon: "üçã", desc: "–ö–∏—Å–ª–æ–µ —è–±–ª–æ–∫–æ" },
                    { name: "–°–µ—Ç–∫–∞ –¥–ª—è –º–µ—Ö–º–æ–¥–∞", price: 200, category: "–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏", icon: "üï∏Ô∏è", desc: "–ö–∞–Ω—Ç–∞–ª A1" }
                ];

                for (const item of starterItems) {
                    await addDoc(collectionRef, { ...item, createdAt: Date.now() });
                }
            }
        }

        function setupItemsListener() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            onSnapshot(q, (snapshot) => {
                state.items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.loading = false;
                render();
            }, (err) => {
                console.error("Firestore error", err);
                state.loading = false;
                render();
            });
        }

        // --- ACTIONS ---
        window.addToCart = (id) => {
            const item = state.items.find(i => i.id === id);
            const inCart = state.cart.find(i => i.id === id);
            if (inCart) {
                inCart.count++;
            } else {
                state.cart.push({ ...item, count: 1 });
            }
            haptic('medium');
            render();
        };

        window.updateCartCount = (id, delta) => {
            const item = state.cart.find(i => i.id === id);
            if (item) {
                item.count += delta;
                if (item.count <= 0) {
                    state.cart = state.cart.filter(i => i.id !== id);
                }
            }
            haptic('light');
            render();
        };

        window.deleteItem = async (id) => {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', id));
                haptic('success');
            } catch (e) {
                console.error(e);
            }
        };

        window.toggleCart = () => {
            state.isCartOpen = !state.isCartOpen;
            render();
        };

        window.startCheckout = () => {
            state.isCartOpen = false;
            state.isCheckoutOpen = true;
            state.checkoutStep = 1;
            render();
        };

        window.closeCheckout = () => {
            state.isCheckoutOpen = false;
            render();
        };

        window.submitOrder = () => {
            const orderId = `VX-${Math.floor(100 + Math.random() * 899)}`;
            const formData = {
                name: $('form-name').value,
                phone: $('form-phone').value,
                username: $('form-user').value,
                location: $('form-loc').value,
                time: $('form-time').value,
            };

            const orderData = {
                orderId,
                items: state.cart,
                total: state.cart.reduce((s, i) => s + i.price * i.count, 0),
                customer: formData,
                status: 'PAID_PENDING'
            };

            haptic('success');
            tg.sendData(JSON.stringify(orderData));
            tg.close();
        };

        window.addItem = async () => {
            const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:");
            const price = parseInt(prompt("–¶–µ–Ω–∞:"));
            const category = prompt("–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–û–¥–Ω–æ—Ä–∞–∑–∫–∏, –ñ–∏–¥–∫–æ—Å—Ç–∏, –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏):", "–ñ–∏–¥–∫–æ—Å—Ç–∏");
            if (name && price) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), {
                    name, price, category, icon: "üì¶", desc: "–ù–æ–≤–æ–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ", createdAt: Date.now()
                });
            }
        };

        // --- RENDER ENGINE ---
        function render() {
            const root = $('app');
            const totalItems = state.cart.reduce((s, i) => s + i.count, 0);
            const totalPrice = state.cart.reduce((s, i) => s + i.price * i.count, 0);

            const filteredItems = state.currentCategory === '–í—Å–µ' 
                ? state.items 
                : state.items.filter(i => i.category === state.currentCategory);

            root.innerHTML = `
                <!-- Background Blobs -->
                <div class="fixed inset-0 overflow-hidden pointer-events-none z-[-1]">
                    <div class="blob blob-1"></div>
                    <div class="blob blob-2"></div>
                </div>

                <!-- Header -->
                <header class="sticky top-0 z-40 bg-black/60 backdrop-blur-xl border-b border-white/10 px-4 py-3 flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-[var(--primary)] font-black text-xl italic tracking-tighter">VAPE PREMIUM</span>
                        <span class="text-[10px] uppercase tracking-widest text-white/40 font-bold">
                            ${state.isAdmin ? '<span class="text-[var(--primary)]">ADMIN MODE</span>' : 'Authorized Access'}
                        </span>
                    </div>
                    <div class="flex items-center gap-3">
                        ${state.isAdmin ? `
                            <button onclick="seedDatabase()" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-white/60">
                                <i data-lucide="shield"></i>
                            </button>
                            <button onclick="addItem()" class="w-10 h-10 rounded-full bg-[var(--primary)] flex items-center justify-center text-black">
                                <i data-lucide="plus"></i>
                            </button>
                        ` : ''}
                        <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-white/60">
                            <i data-lucide="palette"></i>
                        </button>
                    </div>
                </header>

                <!-- Filters -->
                <nav class="flex overflow-x-auto gap-2 p-4 no-scrollbar">
                    ${['–í—Å–µ', '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'].map(cat => `
                        <button onclick="setCategory('${cat}')" 
                                class="px-5 py-2 rounded-2xl whitespace-nowrap text-sm font-medium transition-all
                                ${state.currentCategory === cat ? 'bg-[var(--primary)] text-black shadow-[0_0_15px_var(--primary-glow)]' : 'bg-white/5 text-white/60 border border-white/5'}">
                            ${cat}
                        </button>
                    `).join('')}
                </nav>

                <!-- Product Grid -->
                <main class="grid grid-cols-2 gap-4 p-4 pb-32">
                    ${filteredItems.length === 0 ? `
                        <div class="col-span-2 py-20 text-center text-white/20 italic">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ...</div>
                    ` : filteredItems.map(item => `
                        <div class="glass flex flex-col rounded-3xl overflow-hidden border border-white/5 animate-fade-in relative">
                            ${state.isAdmin ? `
                                <button onclick="deleteItem('${item.id}')" class="absolute top-2 right-2 z-10 w-8 h-8 rounded-full bg-red-500/20 text-red-500 backdrop-blur-md flex items-center justify-center border border-red-500/30">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            ` : ''}
                            <div class="aspect-square flex items-center justify-center text-5xl bg-gradient-to-br from-white/5 to-transparent">
                                ${item.icon || 'üí®'}
                            </div>
                            <div class="p-3 flex-grow flex flex-col">
                                <h3 class="text-white font-bold leading-tight text-sm">${item.name}</h3>
                                <p class="text-white/40 text-[10px] mt-1 line-clamp-2">${item.desc || ''}</p>
                                <div class="mt-auto pt-3 flex items-center justify-between">
                                    <span class="text-[var(--primary)] font-black text-lg">${item.price}‚ÇΩ</span>
                                </div>
                                <button onclick="addToCart('${item.id}')" 
                                        class="w-full mt-2 py-2.5 rounded-xl bg-white/10 hover:bg-[var(--primary)] hover:text-black transition-all text-white font-bold text-xs uppercase tracking-wider flex items-center justify-center gap-2">
                                    <i data-lucide="shopping-cart" class="w-3.5 h-3.5"></i>
                                    –í –∫–æ—Ä–∑–∏–Ω—É
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </main>

                <!-- Floating Cart Button -->
                ${totalItems > 0 && !state.isCartOpen ? `
                    <div class="fixed bottom-6 left-4 right-4 z-50 animate-slide-up">
                        <button onclick="toggleCart()" class="w-full h-16 rounded-2xl bg-[var(--primary)] shadow-[0_10px_30px_rgba(0,0,0,0.5)] flex items-center justify-between px-6 overflow-hidden relative">
                            <div class="flex items-center gap-4">
                                <div class="w-8 h-8 rounded-full bg-black/20 flex items-center justify-center text-black font-black">${totalItems}</div>
                                <span class="text-black font-black uppercase tracking-widest text-sm">–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ—Ä–∑–∏–Ω—ã</span>
                            </div>
                            <span class="text-black font-black text-xl">${totalPrice}‚ÇΩ</span>
                        </button>
                    </div>
                ` : ''}

                <!-- Cart Bottom Sheet -->
                <div class="fixed inset-0 z-[60] transition-all duration-500 ${state.isCartOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}">
                    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleCart()"></div>
                    <div class="absolute bottom-0 left-0 right-0 bg-[#0a0a0a] rounded-t-[40px] border-t border-white/10 max-h-[85vh] flex flex-col transition-transform duration-500 ${state.isCartOpen ? 'translate-y-0' : 'translate-y-full'}">
                        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto my-4"></div>
                        <div class="px-6 py-2 flex items-center justify-between">
                            <h2 class="text-2xl font-black text-white italic">–ö–û–†–ó–ò–ù–ê</h2>
                            <button onclick="toggleCart()" class="text-white/40 font-bold uppercase text-xs">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                        <div class="flex-grow overflow-y-auto px-6 py-4">
                            ${state.cart.map(item => `
                                <div class="flex items-center gap-4 mb-4 bg-white/5 p-4 rounded-3xl border border-white/5">
                                    <div class="w-16 h-16 rounded-2xl bg-black/40 flex items-center justify-center text-3xl">${item.icon}</div>
                                    <div class="flex-grow">
                                        <h4 class="text-white font-bold">${item.name}</h4>
                                        <p class="text-[var(--primary)] font-black text-sm">${item.price}‚ÇΩ</p>
                                    </div>
                                    <div class="flex items-center gap-3 bg-black/40 px-3 py-2 rounded-xl">
                                        <button onclick="updateCartCount('${item.id}', -1)" class="text-white/60"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                        <span class="text-white font-bold w-4 text-center">${item.count}</span>
                                        <button onclick="updateCartCount('${item.id}', 1)" class="text-[var(--primary)]"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="p-6 border-t border-white/10 bg-black/40">
                            <div class="flex justify-between items-center mb-6">
                                <span class="text-white/40 font-bold">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï:</span>
                                <span class="text-3xl font-black text-[var(--primary)]">${totalPrice}‚ÇΩ</span>
                            </div>
                            <button onclick="startCheckout()" class="w-full py-5 rounded-2xl bg-[var(--primary)] text-black font-black uppercase tracking-widest shadow-[0_0_30px_var(--primary-glow)]">
                                –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Checkout Modal -->
                ${state.isCheckoutOpen ? `
                <div class="fixed inset-0 z-[70] bg-[#000] flex flex-col p-6 animate-fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="closeCheckout()" class="text-white/40"><i data-lucide="chevron-left"></i></button>
                        <h2 class="text-xl font-black italic tracking-tighter text-white">–û–§–û–†–ú–õ–ï–ù–ò–ï</h2>
                        <div class="w-6"></div>
                    </div>

                    ${state.checkoutStep === 1 ? `
                        <div class="space-y-6">
                            <div>
                                <label class="text-[10px] text-white/40 uppercase font-black ml-2 mb-2 block">–í–∞—à–µ –∏–º—è</label>
                                <input id="form-name" type="text" placeholder="–ò–≤–∞–Ω" class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-white focus:outline-none focus:border-[var(--primary)] transition-all">
                            </div>
                            <div>
                                <label class="text-[10px] text-white/40 uppercase font-black ml-2 mb-2 block">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input id="form-phone" type="tel" placeholder="+7 (999) 000-00-00" class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-white focus:outline-none focus:border-[var(--primary)]">
                            </div>
                            <div>
                                <label class="text-[10px] text-white/40 uppercase font-black ml-2 mb-2 block">Telegram @User</label>
                                <input id="form-user" type="text" placeholder="@username" value="@${tg.initDataUnsafe?.user?.username || ''}" class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-white focus:outline-none focus:border-[var(--primary)]">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] text-white/40 uppercase font-black ml-2 mb-2 block">–ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏</label>
                                    <input id="form-loc" type="text" placeholder="–ú–µ—Ç—Ä–æ..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-white focus:outline-none focus:border-[var(--primary)]">
                                </div>
                                <div>
                                    <label class="text-[10px] text-white/40 uppercase font-black ml-2 mb-2 block">–í—Ä–µ–º—è</label>
                                    <input id="form-time" type="text" placeholder="18:00" class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-white focus:outline-none focus:border-[var(--primary)]">
                                </div>
                            </div>
                            <button onclick="state.checkoutStep = 2; render();" class="w-full py-5 mt-4 rounded-2xl bg-[var(--primary)] text-black font-black uppercase tracking-widest shadow-[0_0_30px_var(--primary-glow)]">
                                –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
                            </button>
                        </div>
                    ` : `
                        <div class="space-y-6">
                            <div class="bg-white/5 p-6 rounded-3xl border border-white/10 relative overflow-hidden">
                                <div class="absolute -top-10 -right-10 w-32 h-32 bg-[var(--primary)] opacity-5 blur-[40px]"></div>
                                <div class="flex justify-between mb-4">
                                    <span class="text-white/20 font-black text-xs uppercase tracking-tighter">–°–£–ú–ú–ê</span>
                                    <span class="text-[var(--primary)] font-black text-2xl">${totalPrice}‚ÇΩ</span>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <span class="text-[10px] text-white/40 uppercase font-black block mb-1">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã Ozon</span>
                                        <div class="flex items-center gap-2">
                                            <code class="text-lg text-white font-mono tracking-wider">2204 3209 2444 1944</code>
                                            <button onclick="navigator.clipboard.writeText('2204320924441944')" class="text-[var(--primary)] ml-auto"><i data-lucide="copy" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    <div>
                                        <span class="text-[10px] text-white/40 uppercase font-black block mb-1">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</span>
                                        <p class="text-white font-bold">–ò–≤–∞–Ω –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á –†.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-blue-500/10 p-4 rounded-2xl border border-blue-500/20 text-blue-200 text-xs leading-relaxed">
                                <p><strong>–í–∞–∂–Ω–æ:</strong> –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª¬ª. –î–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.</p>
                            </div>
                            <button onclick="submitOrder()" class="w-full py-5 rounded-2xl bg-[var(--primary)] text-black font-black uppercase tracking-widest shadow-[0_0_30px_var(--primary-glow)]">
                                –Ø –æ–ø–ª–∞—Ç–∏–ª
                            </button>
                            <button onclick="state.checkoutStep = 1; render();" class="w-full py-4 text-white/40 font-bold uppercase text-xs">–ù–∞–∑–∞–¥ –∫ –¥–∞–Ω–Ω—ã–º</button>
                        </div>
                    `}
                </div>
                ` : ''}

                <!-- Loading Overlay -->
                <div id="loading" class="fixed inset-0 z-[100] bg-black flex items-center justify-center transition-opacity duration-700 ${state.loading ? 'opacity-100' : 'opacity-0 pointer-events-none'}">
                    <div class="flex flex-col items-center">
                        <div class="w-16 h-16 border-4 border-[var(--primary)] border-t-transparent rounded-full animate-spin"></div>
                        <span class="mt-4 text-[var(--primary)] font-black tracking-widest uppercase text-xs animate-pulse">Initializing...</span>
                    </div>
                </div>
            `;

            lucide.createIcons();
        }

        // --- UTILS ---
        window.setCategory = (cat) => {
            state.currentCategory = cat;
            haptic('light');
            render();
        };

        window.toggleTheme = () => {
            const keys = Object.keys(themes);
            const next = keys[(keys.indexOf(state.theme) + 1) % keys.length];
            applyTheme(next);
            haptic('medium');
        };

        // --- INIT ---
        window.onload = async () => {
            applyTheme('toxic');
            
            // Safety timeout
            setTimeout(() => {
                if (state.loading) {
                    state.loading = false;
                    render();
                }
            }, 3000);

            await initAuth();
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    state.user = user;
                    setupItemsListener();
                }
            });

            // Admin checks with delay for SDK reliability
            checkAdmin();
            setTimeout(checkAdmin, 500);
            setTimeout(checkAdmin, 2000);
        };
    </script>
    <style>
        :root {
            --primary: #00ff41;
            --primary-glow: rgba(0, 255, 65, 0.3);
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .blob {
            position: absolute;
            width: 300px;
            height: 300px;
            filter: blur(100px);
            z-index: -1;
            animation: move 20s infinite alternate ease-in-out;
            border-radius: 50%;
        }

        .blob-1 {
            background: var(--primary-glow);
            top: -50px;
            left: -50px;
        }

        .blob-2 {
            background: rgba(138, 43, 226, 0.2);
            bottom: -50px;
            right: -50px;
            animation-delay: -5s;
        }

        @keyframes move {
            from { transform: translate(0, 0) scale(1); }
            to { transform: translate(100px, 150px) scale(1.2); }
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slide-up {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        input { appearance: none; -webkit-appearance: none; }
    </style>
</head>
<body id="app">
    <!-- App will be rendered here -->
</body>
</html>
