<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sold Out Store</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        cyber: {
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: '#111111',
                            green: '#22c55e',
                            blue: '#0ea5e9',
                            orange: '#f97316',
                            red: '#ef4444'
                        }
                    },
                    animation: {
                        'vapor-float': 'float 8s ease-in-out infinite',
                        'vapor-pulse': 'pulse-glow 4s ease-in-out infinite',
                        'float-up': 'slideUp 0.4s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-out': 'slideOut 0.3s ease-out forwards',
                        'shake': 'shake 0.5s ease-in-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0) scale(1)' },
                            '50%': { transform: 'translateY(-20px) scale(1.05)' },
                        },
                        'pulse-glow': {
                            '0%, 100%': { opacity: '0.4' },
                            '50%': { opacity: '0.7' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideOut: {
                            '0%': { transform: 'translateX(0)', opacity: '1', height: 'auto' },
                            '100%': { transform: 'translateX(-100%)', opacity: '0', height: '0', margin: '0', padding: '0' }
                        },
                        shake: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '25%': { transform: 'translateX(-5px)' },
                            '75%': { transform: 'translateX(5px)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* Base Styles */
        body {
            background-color: #050505;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide Scrollbar globally mostly, but allow on specific elements for desktop */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        /* Vapor Background Elements */
        .vapor-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 50% 120%, rgba(34, 197, 94, 0.15), transparent 70%);
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .vapor-cloud {
            position: absolute;
            background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%);
            filter: blur(80px);
            border-radius: 50%;
            animation: float 10s infinite ease-in-out;
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-nav {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(30px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Neon Glows */
        .neon-text-green { text-shadow: 0 0 15px rgba(34, 197, 94, 0.6); }
        .neon-border-green { box-shadow: 0 0 15px rgba(34, 197, 94, 0.2); }

        /* Loader */
        #loader {
            position: fixed; inset: 0; z-index: 9999;
            background: #050505;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }

        /* Button Press Effect */
        .btn-press:active { transform: scale(0.96); }

        /* Clipping Fix for Category Scroll */
        .category-scroll {
            padding-top: 1rem; padding-bottom: 1rem;
            mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            overflow-x: auto;
            white-space: nowrap;
        }

        /* Desktop Scrollbar Fixes */
        @media (min-width: 768px) {
            .category-scroll {
                margin-left: 0 !important;
                margin-right: 0 !important;
                scrollbar-width: thin;
                -ms-overflow-style: auto;
                padding-bottom: 10px; 
            }
            .category-scroll::-webkit-scrollbar {
                display: block;
                height: 6px;
            }
            .category-scroll::-webkit-scrollbar-track {
                background: rgba(255,255,255,0.05);
                border-radius: 4px;
            }
            .category-scroll::-webkit-scrollbar-thumb {
                background: #22c55e;
                border-radius: 4px;
            }
            .category-scroll {
                mask-image: none;
                -webkit-mask-image: none;
            }
        }

        /* Image Upload Preview */
        .image-preview {
            width: 100%;
            height: 120px;
            border-radius: 12px;
            background-size: cover;
            background-position: center;
            border: 1px dashed rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .image-preview:hover {
            border-color: #22c55e;
            background-color: rgba(34, 197, 94, 0.05);
        }

        /* Time Selection Button Active State */
        .time-btn.active {
            background-color: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
        }
        
        /* Checkbox Custom Style */
        .admin-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-radius: 6px;
            background: rgba(255,255,255,0.05);
            cursor: pointer;
            display: grid;
            place-content: center;
        }
        .admin-checkbox::before {
            content: "";
            width: 10px;
            height: 10px;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #22c55e;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .admin-checkbox:checked::before {
            transform: scale(1);
        }
        .admin-checkbox:checked {
            border-color: #22c55e;
        }

        /* Cart item animations */
        .cart-item {
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        
        .cart-item-removing {
            animation: slideOut 0.3s ease-out forwards;
        }
        
        /* Prevent layout shift */
        #cart-items-container {
            min-height: 100px;
        }
        
        /* Order selection checkbox */
        .order-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .order-checkbox.checked {
            background-color: #ef4444;
            border-color: #ef4444;
        }
        
        /* Status badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background-color: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-approved {
            background-color: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-rejected {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Payment status badges */
        .payment-status-paid {
            background-color: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .payment-status-waiting {
            background-color: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .payment-status-pending {
            background-color: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Loading overlay for edit */
        .edit-loading {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 12px;
        }

        /* FIX –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
        .fixed-input {
            position: relative;
            z-index: 1000;
            -webkit-user-select: auto !important;
            user-select: auto !important;
            pointer-events: auto !important;
            background: rgba(0,0,0,0.6) !important;
        }

        /* FIX –¥–ª—è –∏–∫–æ–Ω–æ–∫ */
        .icon-fix {
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Payment method buttons */
        .payment-method-btn {
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .payment-method-btn.active {
            background-color: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
        }
        
        .payment-method-btn:hover:not(.active) {
            background-color: rgba(255,255,255,0.05);
        }
        
        /* Promo type buttons */
        .promo-type-btn {
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .promo-type-btn.active {
            background-color: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
        }

        /* –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–ª—è –º–æ–¥–∞–ª–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ */
        #delivery-modal .modal-content {
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –∏–Ω–ø—É—Ç—ã –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
        #delivery-modal input:focus {
            scroll-margin-top: 100px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-height: 700px) {
            #delivery-modal .modal-content {
                max-height: 75vh;
            }
        }

        /* –ì–∞—Ä–∞–Ω—Ç–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—è –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
        .input-focus-fix:focus {
            position: relative;
            z-index: 10000;
        }
    </style>
</head>
<body class="antialiased min-h-screen relative pb-24">

    <!-- Vapor Background -->
    <div class="vapor-bg">
        <div class="vapor-cloud w-96 h-96 top-0 left-[-100px] opacity-20"></div>
        <div class="vapor-cloud w-80 h-80 bottom-20 right-[-50px] bg-blue-500/10 opacity-20" style="animation-delay: 2s;"></div>
    </div>

    <!-- Safety Loader -->
<div id="loader" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-[#050505] transition-opacity duration-500">
    
    <div class="relative w-32 h-32 mb-8">
        <div class="absolute inset-0 border-4 border-white/5 rounded-full"></div>
        <div class="absolute inset-0 border-t-4 border-green-500 rounded-full animate-spin"></div>
        <div class="absolute inset-3 border-b-4 border-green-500/30 rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 2s;"></div>
        
        <div class="absolute inset-0 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-14 h-14 text-green-500 animate-pulse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/>
                <path d="M3 6h18"/>
                <path d="M16 10a4 4 0 0 1-8 0"/>
            </svg>
        </div>
    </div>

    <div class="flex flex-col items-center gap-4">
        <h1 class="text-4xl font-black italic tracking-tighter text-white uppercase leading-none drop-shadow-[0_0_15px_rgba(34,197,94,0.5)]">
            SOLD<span class="text-green-500">OUT</span>
        </h1>
        
        <div class="w-16 h-[2px] bg-white/10 rounded-full"></div>

        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-xs font-mono text-gray-500 uppercase tracking-[0.3em]">System Loading...</span>
        </div>
    </div>
</div>
    <!-- Debug Panel (Hidden by default) -->
    <div id="debug-panel" class="fixed inset-0 z-[100] bg-black/95 hidden flex-col p-4 overflow-auto font-mono text-[10px] text-green-400">
        <button onclick="document.getElementById('debug-panel').classList.add('hidden')" class="mb-4 bg-red-500 text-white p-2 rounded">CLOSE DEBUG</button>
        <h3 class="text-white text-lg font-bold mb-2">DIAGNOSTICS</h3>
        <div id="debug-content" class="whitespace-pre-wrap">Loading...</div>
        <div id="debug-warning" class="mt-4 p-3 bg-red-500/20 border border-red-500 text-red-200 rounded hidden">
            ‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï:</b> –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ (Demo Mode).<br>
            –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.
        </div>
        <button onclick="window.shop.seedDatabase()" class="mt-4 bg-green-600 text-white p-3 rounded font-bold">–í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –¢–û–í–ê–†–´</button>
        <button onclick="window.shop.testCart()" class="mt-4 bg-blue-600 text-white p-3 rounded font-bold">
            –¢–ï–°–¢ –ö–û–†–ó–ò–ù–´
        </button>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[110] glass-panel px-6 py-4 rounded-2xl flex items-center gap-4 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none shadow-2xl shadow-green-900/20 border border-green-500/20">
        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">
            <i data-lucide="check" class="w-4 h-4"></i>
        </div>
        <div>
            <h4 id="toast-title" class="text-sm font-bold text-white">–£—Å–ø–µ—à–Ω–æ</h4>
            <p id="toast-msg" class="text-xs text-gray-400">–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[70] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 relative border border-red-500/20 shadow-[0_0_50px_rgba(239,68,68,0.1)]">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-3 border border-red-500/20 shadow-[0_0_20px_rgba(239,68,68,0.1)]">
                    <i data-lucide="trash-2" class="w-8 h-8 text-red-500"></i>
                </div>
                <h2 id="confirm-title" class="text-xl font-black italic text-white">–£–î–ê–õ–ò–¢–¨ –ó–ê–ö–ê–ó–´?</h2>
                <p id="confirm-text" class="text-sm text-gray-400 mt-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="window.shop.hideConfirm()" class="py-3 bg-white/5 text-white rounded-xl font-bold text-sm hover:bg-white/10 transition-colors">–û–¢–ú–ï–ù–ê</button>
                <button onclick="window.shop.confirmAction()" class="py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl font-bold text-sm shadow-[0_0_15px_rgba(239,68,68,0.3)] transition-colors">–£–î–ê–õ–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app" class="px-4 pt-4 opacity-0 transition-opacity duration-700">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pt-2">
            <!-- –ö–ª–∏–∫ –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É —É–±—Ä–∞–Ω, –∫–∞–∫ –∏ –ø—Ä–æ—Å–∏–ª–∏ -->
            <div class="select-none">
                <h1 class="text-3xl font-black italic tracking-tighter text-white uppercase leading-none" style="text-shadow: 0 0 20px rgba(0,0,0,0.8);">
                    SOLD<span class="text-green-500 neon-text-green">OUT</span>
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <div class="h-[2px] w-4 bg-green-500"></div>
                    <p class="text-[9px] text-gray-500 tracking-[0.3em] uppercase font-bold">Premium Store</p>
                </div>
            </div>
            <div class="flex gap-3">
                <!-- Admin Add Button (Hidden by default) -->
                <button id="admin-add-btn" onclick="window.shop.toggleAddModal()" class="hidden w-10 h-10 rounded-full glass-panel flex items-center justify-center text-green-400 hover:bg-green-500 hover:text-black transition-all border border-green-500/30 shadow-[0_0_10px_rgba(34,197,94,0.2)]">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
                <div class="w-10 h-10 rounded-full glass-panel flex items-center justify-center border border-white/10 overflow-hidden">
                    <img id="user-avatar" src="" class="w-full h-full object-cover opacity-90" alt="Profile">
                </div>
            </div>
        </header>

        <!-- Dynamic Content Views -->
        <main id="main-content" class="min-h-[70vh]">
            <!-- Rendered by JS -->
        </main>

    </div>

    <!-- Bottom Navigation (Floating Island) -->
    <nav class="fixed bottom-6 left-4 right-4 h-18 glass-nav rounded-2xl flex items-center justify-around z-40 shadow-[0_10px_40px_rgba(0,0,0,0.8)] border border-white/5 py-3">
        <button onclick="window.shop.switchView('store')" class="nav-btn flex flex-col items-center gap-1.5 text-green-400 btn-press transition-colors w-1/4" data-view="store">
            <i data-lucide="store" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold tracking-wide">–ú–ê–ì–ê–ó–ò–ù</span>
        </button>
        <button onclick="window.shop.switchView('cart')" class="nav-btn flex flex-col items-center gap-1.5 text-gray-500 btn-press transition-colors relative w-1/4" data-view="cart">
            <div id="cart-badge" class="absolute top-0 right-6 w-4 h-4 bg-green-500 text-black text-[9px] font-bold rounded-full flex items-center justify-center opacity-0 transition-all shadow-[0_0_10px_rgba(34,197,94,0.6)]">0</div>
            <i data-lucide="shopping-bag" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold tracking-wide">–ö–û–†–ó–ò–ù–ê</span>
        </button>
        <button onclick="window.shop.switchView('user-orders')" class="nav-btn flex flex-col items-center gap-1.5 text-gray-500 btn-press transition-colors w-1/4" data-view="user-orders">
            <i data-lucide="package" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold tracking-wide">–ó–ê–ö–ê–ó–´</span>
        </button>
        <button onclick="window.shop.switchView('profile')" class="nav-btn flex flex-col items-center gap-1.5 text-gray-500 btn-press transition-colors w-1/4" data-view="profile">
            <i data-lucide="user" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold tracking-wide">–ü–†–û–§–ò–õ–¨</span>
        </button>
    </nav>

    <!-- Modals -->

    <!-- USER PROMO CODE MODAL -->
    <div id="user-promo-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 relative border border-green-500/20 shadow-[0_0_50px_rgba(34,197,94,0.1)]">
            <button onclick="window.shop.toggleUserPromoModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h2 class="text-xl font-black italic mb-6 text-white">–í–í–ï–°–¢–ò <span class="text-green-500">–ü–†–û–ú–û–ö–û–î</span></h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–í–∞—à –∫–æ–¥</label>
                    <input type="text" id="promo-input" placeholder="WINTER2024" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-4 text-sm font-mono focus:border-green-500 focus:shadow-[0_0_15px_rgba(34,197,94,0.2)] outline-none transition-all text-white placeholder-gray-600 uppercase">
                </div>
                
                <button onclick="window.shop.activatePromo()" class="w-full bg-green-500 hover:bg-green-400 text-black font-black italic uppercase tracking-wider py-4 rounded-xl mt-2 transition-all shadow-[0_0_20px_rgba(34,197,94,0.3)]">
                    –ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨
                </button>
            </div>
        </div>
    </div>

    <!-- ADMIN PROMO MANAGER MODAL -->
    <div id="admin-promo-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 relative border border-blue-500/20 shadow-[0_0_50px_rgba(59,130,246,0.1)] max-h-[90vh] overflow-y-auto">
            <button onclick="window.shop.toggleAdminPromoModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h2 class="text-xl font-black italic mb-6 text-white">–£–ü–†–ê–í–õ–ï–ù–ò–ï <span class="text-blue-500">–ü–†–û–ú–û</span></h2>
            
            <div class="space-y-4 mb-8">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</h3>
                
                <!-- –ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–ö–æ–¥</label>
                    <input type="text" id="new-promo-code" placeholder="SALE50" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm font-mono focus:border-blue-500 outline-none transition-all text-white placeholder-gray-600 uppercase">
                </div>
                
                <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–¢–∏–ø —Å–∫–∏–¥–∫–∏</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="promo-type-percent" onclick="window.shop.selectPromoType('percent')" class="promo-type-btn active bg-green-500/20 border-green-500 text-green-500">
                            –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –≤—Å–µ–π –∫–æ—Ä–∑–∏–Ω—ã
                        </button>
                        <button type="button" id="promo-type-fixed" onclick="window.shop.selectPromoType('fixed')" class="promo-type-btn bg-white/5 border border-white/10 text-gray-400">
                            –ù–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
                        </button>
                    </div>
                </div>
                
                <!-- –ü–æ–ª—è –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∏–¥–∏–º—ã) -->
                <div id="promo-percent-fields">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–°–∫–∏–¥–∫–∞ %</label>
                        <input type="number" id="new-promo-percent" placeholder="10" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-blue-500 outline-none transition-all text-white placeholder-gray-600">
                    </div>
                </div>
                
                <!-- –ü–æ–ª—è –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∫–∏–¥–∫–∏ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div id="promo-fixed-fields" class="hidden">
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–°–∫–∏–¥–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä (%)</label>
                            <input type="number" id="new-promo-fixed-discount" placeholder="20" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-blue-500 outline-none transition-all text-white placeholder-gray-600">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤</label>
                            <input type="number" id="new-promo-fixed-quantity" placeholder="5" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-blue-500 outline-none transition-all text-white placeholder-gray-600">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label>
                    <input type="number" id="new-promo-limit" placeholder="100" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-blue-500 outline-none transition-all text-white placeholder-gray-600">
                </div>
                
                <button onclick="window.shop.createPromoCode()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black italic uppercase tracking-wider py-3 rounded-xl transition-all shadow-[0_0_20px_rgba(37,99,235,0.3)]">
                    –°–û–ó–î–ê–¢–¨ –ü–†–û–ú–û–ö–û–î
                </button>
            </div>

            <div class="border-t border-white/10 pt-4">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–¥—ã</h3>
                <div id="admin-promo-list" class="space-y-2">
                    <!-- Loaded via JS -->
                    <div class="text-center text-gray-600 text-xs py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Product Modal (Admin) -->
    <div id="add-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 relative border border-green-500/20 shadow-[0_0_50px_rgba(34,197,94,0.1)] max-h-[90vh] overflow-y-auto">
            <button onclick="window.shop.toggleAddModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h2 class="text-xl font-black italic mb-6 text-white">–ù–û–í–´–ô <span class="text-green-500">–¢–û–í–ê–†</span></h2>
            <div class="space-y-4">
                
                <!-- Image Upload -->
                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
                    <div id="img-preview-container" class="image-preview" onclick="document.getElementById('new-image-input').click()">
                        <div id="img-placeholder" class="flex flex-col items-center gap-2 text-gray-500">
                            <i data-lucide="image-plus" class="w-6 h-6"></i>
                            <span class="text-xs">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</span>
                        </div>
                    </div>
                    <input type="file" id="new-image-input" accept="image/*" class="hidden" onchange="window.shop.handleImageSelect(this)">
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="new-name" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 focus:shadow-[0_0_15px_rgba(34,197,94,0.2)] outline-none transition-all text-white placeholder-gray-600">
                </div>
                <div>
                     <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–¶–µ–Ω–∞ (RUB)</label>
                    <input type="number" id="new-price" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 focus:shadow-[0_0_15px_rgba(34,197,94,0.2)] outline-none transition-all text-white placeholder-gray-600">
                </div>
                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="new-cat" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 outline-none text-gray-300 appearance-none">
                        <option value="–û–¥–Ω–æ—Ä–∞–∑–∫–∏">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</option>
                        <option value="Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞">Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
                        <option value="–ñ–∏–¥–∫–æ—Å—Ç–∏">–ñ–∏–¥–∫–æ—Å—Ç–∏</option>
                        <option value="–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</option>
                        <option value="–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞">–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
                    </select>
                </div>
                <button onclick="window.shop.addProduct()" class="w-full bg-green-500 hover:bg-green-400 text-black font-black italic uppercase tracking-wider py-4 rounded-xl mt-2 transition-all shadow-[0_0_20px_rgba(34,197,94,0.3)]">
                    –î–û–ë–ê–í–ò–¢–¨
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal (Admin) -->
    <div id="edit-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 relative border border-green-500/20 shadow-[0_0_50px_rgba(34,197,94,0.1)] max-h-[90vh] overflow-y-auto">
            <button onclick="window.shop.toggleEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h2 class="text-xl font-black italic mb-6 text-white">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï <span class="text-green-500">–¢–û–í–ê–†–ê</span></h2>
            <div class="space-y-4" id="edit-form-container">
                
                <!-- Image Upload -->
                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
                    <div id="edit-img-preview-container" class="image-preview relative" onclick="document.getElementById('edit-image-input').click()">
                        <div id="edit-img-placeholder" class="flex flex-col items-center gap-2 text-gray-500">
                            <i data-lucide="image-plus" class="w-6 h-6"></i>
                            <span class="text-xs">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</span>
                        </div>
                    </div>
                    <input type="file" id="edit-image-input" accept="image/*" class="hidden" onchange="window.shop.handleEditImageSelect(this)">
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="edit-name" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 focus:shadow-[0_0_15px_rgba(34,197,94,0.2)] outline-none transition-all text-white placeholder-gray-600">
                </div>
                <div>
                     <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–¶–µ–Ω–∞ (RUB)</label>
                    <input type="number" id="edit-price" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 focus:shadow-[0_0_15px_rgba(34,197,94,0.2)] outline-none transition-all text-white placeholder-gray-600">
                </div>
                <div>
                    <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="edit-cat" class="fixed-input w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 outline-none text-gray-300 appearance-none">
                        <option value="–û–¥–Ω–æ—Ä–∞–∑–∫–∏">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</option>
                        <option value="Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞">Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
                        <option value="–ñ–∏–¥–∫–æ—Å—Ç–∏">–ñ–∏–¥–∫–æ—Å—Ç–∏</option>
                        <option value="–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</option>
                        <option value="–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞">–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
                    </select>
                </div>
                <button onclick="window.shop.updateProduct()" class="w-full bg-green-500 hover:bg-green-400 text-black font-black italic uppercase tracking-wider py-4 rounded-xl mt-2 transition-all shadow-[0_0_20px_rgba(34,197,94,0.3)]">
                    –°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø
                </button>
            </div>
        </div>
    </div>

    <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø DELIVERY INFO MODAL (Step 1) -->
    <div id="delivery-modal" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-md hidden flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 border-t border-green-500/30 animate-float-up shadow-[0_-10px_50px_rgba(0,0,0,0.8)]">
            <!-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π -->
            <div class="modal-content max-h-[85vh] overflow-y-auto -webkit-overflow-scrolling-touch scroll-behavior-smooth" id="delivery-modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black italic text-white">–î–ê–ù–ù–´–ï <span class="text-green-500">–î–û–°–¢–ê–í–ö–ò</span></h2>
                    <button onclick="document.getElementById('delivery-modal').classList.add('hidden')" class="text-gray-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>

                <div class="space-y-4 pb-10">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–í–∞—à–µ –§–ò–û</label>
                        <input type="text" id="del-name" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ" 
                               class="fixed-input input-focus-fix w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 outline-none transition-all text-white placeholder-gray-700"
                               oninput="this.value = this.value.replace(/[0-9]/g, '')">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-2">
                            <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                            <input type="tel" id="del-phone" placeholder="+7 999 000 00 00" maxlength="12" 
                                   class="fixed-input input-focus-fix w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 outline-none transition-all text-white placeholder-gray-700">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–í–æ–∑—Ä–∞—Å—Ç</label>
                            <input type="number" id="del-age" placeholder="18+" 
                                   class="fixed-input input-focus-fix w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 outline-none transition-all text-white placeholder-gray-700 text-center" min="18" max="99">
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">–í–∞—à Telegram (@username)</label>
                        <input type="text" id="del-contact" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: @username" 
                               class="fixed-input input-focus-fix w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 outline-none transition-all text-white placeholder-gray-700">
                    </div>

                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 block">üìç –ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏</label>
                        <input type="text" id="del-place" placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä" 
                               class="fixed-input input-focus-fix w-full bg-black/60 border border-white/10 rounded-xl p-3 text-sm focus:border-green-500 outline-none transition-all text-white placeholder-gray-700">
                    </div>

                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest mb-2 block">‚è∞ –í—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á–∏</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="window.shop.selectTime('6:00 - 12:00', this)" class="time-btn w-full bg-white/5 border border-white/10 py-3 rounded-xl text-xs font-bold text-gray-400 hover:text-white transition-all">
                                6:00 - 12:00
                            </button>
                            <button onclick="window.shop.selectTime('14:00 - 20:00', this)" class="time-btn w-full bg-white/5 border border-white/10 py-3 rounded-xl text-xs font-bold text-gray-400 hover:text-white transition-all">
                                14:00 - 20:00
                            </button>
                        </div>
                    </div>

                    <button onclick="window.shop.proceedToPayment()" class="w-full bg-green-500 hover:bg-green-400 text-black font-black italic uppercase tracking-wider py-4 rounded-xl mt-4 transition-all shadow-[0_0_20px_rgba(34,197,94,0.3)] flex items-center justify-center gap-2">
                        –ö –û–ü–õ–ê–¢–ï <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL (Step 2) -->
    <div id="checkout-modal" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-md hidden flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 border-t border-green-500/30 animate-float-up shadow-[0_-10px_50px_rgba(0,0,0,0.8)]">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-3 border border-green-500/20 shadow-[0_0_20px_rgba(34,197,94,0.1)]">
                    <i data-lucide="credit-card" class="w-8 h-8 text-green-500"></i>
                </div>
                <h2 class="text-2xl font-black italic text-white">–û–ü–õ–ê–¢–ê</h2>
                <p id="order-id-display" class="text-xs text-green-400 font-mono mt-1 tracking-widest">–ö–æ–¥ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: GENERATING...</p>
            </div>

            <div class="bg-black/40 rounded-xl p-5 border border-white/5 mb-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-green-500/10 blur-2xl rounded-full pointer-events-none"></div>
                <div class="flex justify-between items-center mb-3">
                    <span class="text-gray-400 text-xs uppercase tracking-wider">–°—É–º–º–∞</span>
                    <span id="checkout-total" class="text-2xl font-bold text-white neon-text-green">0 ‚ÇΩ</span>
                </div>
                
                <div id="checkout-discount-row" class="hidden flex justify-between items-center mb-3 text-green-400 text-xs">
                    <span class="uppercase tracking-wider">–°–∫–∏–¥–∫–∞ (PROMO)</span>
                    <span id="checkout-discount-val">-0 ‚ÇΩ</span>
                </div>

                <!-- Payment Method Selection -->
                <div class="mb-4">
                    <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="window.shop.selectPaymentMethod('now')" class="payment-method-btn bg-white/5 border border-white/10 py-3 rounded-xl text-xs font-bold text-gray-400 hover:text-white transition-all">
                            –û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å
                        </button>
                        <button onclick="window.shop.selectPaymentMethod('on_delivery')" class="payment-method-btn bg-white/5 border border-white/10 py-3 rounded-xl text-xs font-bold text-gray-400 hover:text-white transition-all">
                            –û–ø–ª–∞—Ç–∏—Ç—å –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏
                        </button>
                    </div>
                </div>

                <!-- Bank Details (Only for "–û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å") -->
                <div id="bank-details-section" class="hidden">
                    <div class="h-px bg-white/10 my-4"></div>
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-lg bg-blue-600 flex items-center justify-center text-[10px] font-black text-white shadow-lg shadow-blue-900/40">OZON</div>
                        <div class="flex-grow">
                            <p class="text-sm text-white font-mono tracking-wider font-bold">2204 3209 2444 1944</p>
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest">–ò–≤–∞–Ω –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á –†.</p>
                            <p class="text-[10px] text-green-400 mt-1">üìå –í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–µ—Ä–µ–≤–æ–¥—É —É–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –∑–∞–∫–∞–∑–∞</p>
                        </div>
                        <button onclick="window.shop.copyBank()" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition-all">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Payment Button (Changes based on method) -->
            <button id="payment-action-btn" onclick="window.shop.handlePaymentAction()" class="w-full bg-gradient-to-r from-green-600 to-green-500 text-black font-black italic uppercase tracking-wider py-4 rounded-xl shadow-[0_0_20px_rgba(34,197,94,0.3)] active:scale-95 transition-transform flex items-center justify-center gap-2">
                <span>–í–´–ë–ï–†–ò–¢–ï –°–ü–û–°–û–ë –û–ü–õ–ê–¢–´</span>
            </button>
            
            <button onclick="window.shop.closeCheckoutModal()" class="w-full py-4 text-xs font-bold text-gray-500 uppercase tracking-widest hover:text-white transition-colors">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <!-- ORDER DETAIL MODAL (Admin) -->
    <div id="order-detail-modal" class="fixed inset-0 z-[60] bg-black/95 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('order-detail-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div id="order-detail-content">
                <!-- Content Injected via JS -->
            </div>
        </div>
    </div>

    <!-- USER ORDER DETAIL MODAL -->
    <div id="user-order-detail-modal" class="fixed inset-0 z-[60] bg-black/95 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('user-order-detail-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div id="user-order-detail-content">
                <!-- Content Injected via JS -->
            </div>
        </div>
    </div>

    <script type="module">
        // ---------------------------------------------------------
        // 1. FIREBASE MODULAR V10 IMPORTS
        // ---------------------------------------------------------
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            writeBatch,
            getDocs,
            where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, 
            signInAnonymously,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCJ9Uwi9GHAU7LF6t-Wln0NBsIE4uQ6nVw",
            authDomain: "qury-60cce.firebaseapp.com",
            projectId: "qury-60cce",
            storageBucket: "qury-60cce.firebasestorage.app",
            messagingSenderId: "637838162144",
            appId: "1:637838162144:web:478a50cdff764519a6b885",
            measurementId: "G-2NLYNP5WQZ"
        };

        // –ö–ª—é—á–µ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∂–µ—Å—Ç–∫–æ –∑–∞–¥–∞–µ–º APP_ID
        const APP_ID = 'qury-60cce';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const ADMIN_ID = "1262669099";

        // ---------------------------------------------------------
        // 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–£–¢–ï–ô
        // ---------------------------------------------------------
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
        const getProductsRef = () => collection(db, 'artifacts', APP_ID, 'public', 'data', 'products');
        const getPromocodesRef = () => collection(db, 'artifacts', APP_ID, 'public', 'data', 'promocodes');
        const getOrdersRef = () => collection(db, 'artifacts', APP_ID, 'public', 'data', 'orders');
        
        const getUserProfileRef = (uid) => doc(db, 'artifacts', APP_ID, 'users', uid, 'profile', 'data');
        const getUserCartRef = (uid) => doc(db, 'artifacts', APP_ID, 'users', uid, 'cart', 'current');
        const getUserOrdersRef = (uid) => collection(db, 'artifacts', APP_ID, 'users', uid, 'orders');
        const getUserOrderRef = (uid, orderId) => doc(db, 'artifacts', APP_ID, 'users', uid, 'orders', orderId);
        const getPublicOrderRef = (orderId) => doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', orderId);
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã
        const getProductDocRef = (id) => doc(db, 'artifacts', APP_ID, 'public', 'data', 'products', id);
        const getPromoDocRef = (id) => doc(db, 'artifacts', APP_ID, 'public', 'data', 'promocodes', id);

        // ---------------------------------------------------------
        // 3. MOCK DATA
        // ---------------------------------------------------------
        
        const MOCK_PRODUCTS = [
            { name: "Neon Pod X", price: 2500, category: "Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", image: "zap", createdAt: 1700000000000 },
            { name: "Cyber Bar 9000", price: 1200, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", image: "battery-charging", createdAt: 1700000000001 },
            { name: "Toxic Sludge 30ml", price: 600, category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", image: "droplet", createdAt: 1700000000002 },
            { name: "Mech Mod Pro", price: 5000, category: "Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", image: "cpu", createdAt: 1700000000003 },
            { name: "Frost Berry Ice", price: 1300, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", image: "snowflake", createdAt: 1700000000004 },
            { name: "Magma Core Coil", price: 300, category: "–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ", image: "circle-dot", createdAt: 1700000000005 },
            { name: "Blue Raz 50mg", price: 650, category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", image: "droplet", createdAt: 1700000000006 },
            { name: "Vapor Storm Kit", price: 3200, category: "Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", image: "wind", createdAt: 1700000000007 },
            { name: "Mango Bomb", price: 1250, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", image: "bomb", createdAt: 1700000000008 },
            { name: "Cotton Wick Premium", price: 150, category: "–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ", image: "scroll", createdAt: 1700000000009 },
        ];

        // Safety Loader Timeout
        setTimeout(() => {
            const loader = document.getElementById('loader');
            if (loader && loader.style.display !== 'none') {
                console.warn("Loader forced close via timeout");
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
                document.getElementById('app').classList.remove('opacity-0');
            }
        }, 3500);

        // ---------------------------------------------------------
        // 4. CORE APPLICATION LOGIC
        // ---------------------------------------------------------

        window.shop = {
            state: {
                user: null,
                products: [],
                cart: {},
                currentCategory: '–í—Å–µ',
                isAdmin: false,
                debugClicks: 0,
                pendingImage: null,
                pendingEditImage: null,
                listenerUnsubscribe: null,
                deliveryTime: null,
                ordersListenerUnsubscribe: null,
                editingProductId: null,
                cartListenerUnsubscribe: null,
                isCartView: false,
                cartRendering: false,
                firebaseUid: null,
                isProcessingOrder: false,
                confirmCallback: null,
                adminOrders: [],
                activePromo: null,
                adminPromoUnsubscribe: null,
                deliveryInfo: null,
                currentTotal: 0,
                currentOrderId: null,
                activePromoListener: null,
                modalInputFixInitialized: false,
                adminSelectionMode: false,
                selectedAdminOrders: new Set(),
                adminFabRendered: false,
                paymentMethod: null,
                paymentStatus: 'pending',
                promoType: 'percent',
                categoryOrder: ['–û–¥–Ω–æ—Ä–∞–∑–∫–∏', 'Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'],
                // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                userOrders: [],
                userOrdersListenerUnsubscribe: null,
                userOrdersSelectionMode: false,
                selectedUserOrders: new Set()
            },

            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–ì–ê –° –ö–õ–ê–í–ò–ê–¢–£–†–û–ô ---
            initKeyboardFix: function() {
                const ensureInputVisible = (inputElement) => {
                    if (!inputElement) return;
                    
                    setTimeout(() => {
                        inputElement.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center', 
                            inline: 'nearest'
                        });
                        
                        setTimeout(() => {
                            const modalContent = document.getElementById('delivery-modal-content');
                            if (modalContent) {
                                const inputRect = inputElement.getBoundingClientRect();
                                const containerRect = modalContent.getBoundingClientRect();
                                
                                if (inputRect.top < containerRect.top || inputRect.bottom > containerRect.bottom) {
                                    const scrollAmount = inputRect.top - containerRect.top - 100;
                                    modalContent.scrollBy({ top: scrollAmount, behavior: 'smooth' });
                                }
                            }
                        }, 50);
                    }, 200);
                };

                const setupDeliveryInputHandlers = () => {
                    const inputs = document.querySelectorAll('#delivery-modal input');
                    inputs.forEach(input => {
                        input.removeEventListener('focus', this.handleInputFocus);
                        input.addEventListener('focus', (e) => {
                            ensureInputVisible(e.target);
                        });
                    });
                };

                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const target = mutation.target;
                            if (target.id === 'delivery-modal' && !target.classList.contains('hidden')) {
                                setTimeout(setupDeliveryInputHandlers, 100);
                            }
                        }
                    });
                });

                const deliveryModal = document.getElementById('delivery-modal');
                if (deliveryModal) {
                    observer.observe(deliveryModal, { attributes: true });
                }
            },

            // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–∫—Å–∞ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ ---
            initModalInputFix: function() {
                if (this.state.modalInputFixInitialized) return;
                
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const target = mutation.target;
                            if (target.id && target.classList.contains('hidden') === false) {
                                setTimeout(() => {
                                    const inputs = target.querySelectorAll('input:not([type="file"]), select, textarea');
                                    if (inputs.length > 0) {
                                        inputs[0].focus();
                                    }
                                }, 100);
                            }
                        }
                    });
                });

                const modals = document.querySelectorAll('[id$="-modal"]');
                modals.forEach(modal => {
                    observer.observe(modal, { attributes: true });
                });

                this.state.modalInputFixInitialized = true;
            },

            // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
            compressImage: function(file, maxWidth = 800, quality = 0.7) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob((blob) => {
                                const newReader = new FileReader();
                                newReader.readAsDataURL(blob);
                                newReader.onload = (e) => {
                                    resolve(e.target.result);
                                };
                            }, 'image/jpeg', quality);
                        };
                        img.onerror = reject;
                    };
                    reader.onerror = reject;
                });
            },

            // --- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ ---
            selectPromoType: function(type) {
                this.state.promoType = type;
                const percentBtn = document.getElementById('promo-type-percent');
                const fixedBtn = document.getElementById('promo-type-fixed');
                const percentFields = document.getElementById('promo-percent-fields');
                const fixedFields = document.getElementById('promo-fixed-fields');
                
                if (type === 'percent') {
                    percentBtn.classList.add('active', 'bg-green-500/20', 'border-green-500', 'text-green-500');
                    percentBtn.classList.remove('bg-white/5', 'text-gray-400');
                    fixedBtn.classList.remove('active', 'bg-green-500/20', 'border-green-500', 'text-green-500');
                    fixedBtn.classList.add('bg-white/5', 'text-gray-400');
                    percentFields.classList.remove('hidden');
                    fixedFields.classList.add('hidden');
                } else {
                    fixedBtn.classList.add('active', 'bg-green-500/20', 'border-green-500', 'text-green-500');
                    fixedBtn.classList.remove('bg-white/5', 'text-gray-400');
                    percentBtn.classList.remove('active', 'bg-green-500/20', 'border-green-500', 'text-green-500');
                    percentBtn.classList.add('bg-white/5', 'text-gray-400');
                    fixedFields.classList.remove('hidden');
                    percentFields.classList.add('hidden');
                }
            },

            // --- Parse User Data from ANYWHERE ---
            parseUser: () => {
                const tg = window.Telegram.WebApp;
                
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    return { source: 'initDataUnsafe', user: tg.initDataUnsafe.user };
                }

                try {
                    const hash = window.location.hash.substring(1);
                    const params = new URLSearchParams(hash);
                    let tgWebAppData = params.get('tgWebAppData');
                    
                    if (!tgWebAppData) {
                        const search = new URLSearchParams(window.location.search);
                        tgWebAppData = search.get('tgWebAppData');
                    }

                    if (tgWebAppData) {
                        const dataParams = new URLSearchParams(decodeURIComponent(tgWebAppData));
                        const userJson = dataParams.get('user');
                        if (userJson) {
                             return { source: 'url_hash', user: JSON.parse(decodeURIComponent(userJson)) };
                        }
                    }
                } catch(e) {}

                const storedUser = localStorage.getItem('vape_user_identity');
                if (storedUser) {
                    return { source: 'local_storage', user: JSON.parse(storedUser) };
                }

                const guestId = Math.floor(Math.random() * 1000000) + 9000000;
                const newGuest = {
                    id: guestId,
                    first_name: "–ì–æ—Å—Ç—å",
                    last_name: `#${guestId.toString().substr(-4)}`,
                    username: "guest_" + guestId,
                    photo_url: ""
                };
                localStorage.setItem('vape_user_identity', JSON.stringify(newGuest));
                return { source: 'generated_guest', user: newGuest };
            },

            // --- Save User Profile to Firebase ---
            saveUserProfile: async (tgUser) => {
                try {
                    const uid = window.shop.state.firebaseUid;
                    if (!uid) {
                        console.log("No UID for profile save");
                        return;
                    }
                    
                    const userRef = getUserProfileRef(uid);
                    await setDoc(userRef, {
                        telegramId: tgUser.id,
                        firstName: tgUser.first_name,
                        lastName: tgUser.last_name || '',
                        username: tgUser.username || '',
                        photoUrl: tgUser.photo_url || '',
                        lastSeen: new Date().toISOString()
                    }, { merge: true });
                    
                    console.log("‚úÖ User profile saved");
                } catch (e) {
                    console.error("‚ùå Failed to save user profile:", e);
                }
            },

            // --- Save Cart to Firebase for user ---
            saveCartToFirebase: async () => {
                try {
                    const uid = window.shop.state.firebaseUid;
                    if (!uid) {
                        console.log("No UID for cart save");
                        return;
                    }
                    
                    const cartRef = getUserCartRef(uid);
                    await setDoc(cartRef, {
                        items: window.shop.state.cart,
                        updatedAt: new Date().toISOString()
                    });
                    
                    console.log("‚úÖ Cart saved to Firebase");
                } catch (e) {
                    console.error("‚ùå Failed to save cart:", e);
                }
            },

            // --- Load Cart from Firebase for user ---
            loadCartFromFirebase: async () => {
                try {
                    const uid = window.shop.state.firebaseUid;
                    if (!uid) {
                        console.log("No UID for cart load");
                        return;
                    }
                    
                    const cartRef = getUserCartRef(uid);
                    const cartDoc = await getDoc(cartRef);
                    
                    if (cartDoc.exists()) {
                        const cartData = cartDoc.data();
                        if (cartData.items) {
                            window.shop.state.cart = cartData.items;
                            window.shop.updateCartBadge();
                            console.log("‚úÖ Cart loaded from Firebase");
                        }
                    }
                } catch (e) {
                    console.error("‚ùå Failed to load cart:", e);
                }
            },

            // --- Setup realtime cart listener ---
            setupCartListener: () => {
                if (window.shop.state.cartListenerUnsubscribe) {
                    window.shop.state.cartListenerUnsubscribe();
                }
                
                const uid = window.shop.state.firebaseUid;
                if (!uid) return;
                
                const cartRef = getUserCartRef(uid);
                
                window.shop.state.cartListenerUnsubscribe = onSnapshot(cartRef, (doc) => {
                    if (doc.exists()) {
                        const cartData = doc.data();
                        if (cartData.items) {
                            window.shop.state.cart = cartData.items;
                            window.shop.updateCartBadge();
                            
                            if (window.shop.state.isCartView && !window.shop.state.cartRendering) {
                                setTimeout(() => {
                                    window.shop.updateCartView();
                                }, 50);
                            }
                        }
                    }
                }, (error) => {
                    console.error("‚ùå Cart listener error:", error);
                });
            },

            init: async () => {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tg.setHeaderColor('#050505');
                tg.setBackgroundColor('#050505');

                console.log("Telegram WebApp initialized");

                // --- ROBUST USER PARSING ---
                const parsed = window.shop.parseUser();
                let tgUser = parsed.user;
                
                window.shop.state.user = tgUser;
                window.shop.state.isAdmin = (String(tgUser.id) === ADMIN_ID);
                console.log("Is admin?", window.shop.state.isAdmin);

                // Setup Avatar
                const avatarUrl = tgUser.photo_url || `https://ui-avatars.com/api/?name=${tgUser.first_name}&background=22c55e&color=000&bold=true`;
                document.getElementById('user-avatar').src = avatarUrl;
                
                // Admin Button Visibility
                if (window.shop.state.isAdmin) {
                    document.getElementById('admin-add-btn').classList.remove('hidden');
                } else {
                    document.getElementById('admin-add-btn').classList.add('hidden');
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–∫—Å–∞ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
                window.shop.initModalInputFix();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–∫—Å–∞ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–í–ê–ñ–ù–û!)
                window.shop.initKeyboardFix();
                
                // Phone Input Masking Listener
                const phoneInput = document.getElementById('del-phone');
                if (phoneInput) {
                    phoneInput.addEventListener('input', (e) => {
                        let val = e.target.value.replace(/\D/g, '');
                        
                        if (val.length > 0 && val[0] !== '7') {
                             val = '7' + val;
                        }
                        if (val.length > 11) val = val.substring(0,11);

                        if (val.length > 0) {
                            e.target.value = '+' + val;
                        } else {
                            e.target.value = '';
                        }
                    });
                    
                    phoneInput.addEventListener('focus', (e) => {
                        if(!e.target.value) e.target.value = '+7';
                    });
                }

                // Age validation listener
                const ageInput = document.getElementById('del-age');
                if (ageInput) {
                    ageInput.addEventListener('input', (e) => {
                        const age = parseInt(e.target.value);
                        if (age < 18) {
                            ageInput.classList.add('border-red-500');
                        } else {
                            ageInput.classList.remove('border-red-500');
                        }
                    });
                }

                // --- PROPER AUTHENTICATION FLOW ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("‚úÖ Firebase user authenticated:", user.uid);
                        window.shop.state.firebaseUid = user.uid;
                        
                        await window.shop.saveUserProfile(tgUser);
                        await window.shop.loadCartFromFirebase();
                        window.shop.setupCartListener();
                        window.shop.initRealtimeListener();
                        
                        window.shop.showToast(`–í—Ö–æ–¥: ${tgUser.first_name}`, "–°–∏—Å—Ç–µ–º–∞");
                        
                        const loader = document.getElementById('loader');
                        loader.style.opacity = '0';
                        setTimeout(() => {
                            loader.style.display = 'none';
                            document.getElementById('app').classList.remove('opacity-0');
                            window.shop.switchView('store');
                        }, 500);
                    } else {
                        console.log("‚ö†Ô∏è No Firebase user, signing in anonymously...");
                        try {
                            await signInAnonymously(auth);
                        } catch (e) {
                            console.error("‚ùå Anonymous auth failed:", e);
                            const loader = document.getElementById('loader');
                            loader.style.opacity = '0';
                            setTimeout(() => {
                                loader.style.display = 'none';
                                document.getElementById('app').classList.remove('opacity-0');
                                window.shop.switchView('store');
                            }, 500);
                        }
                    }
                });
                
                // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Initial auth failed:", e);
                }
                
                setTimeout(() => { 
                    if(window.lucide) {
                        window.lucide.createIcons();
                    }
                }, 100);
            },

            // --- REALTIME SYNC ---
            initRealtimeListener: () => {
                if (window.shop.state.listenerUnsubscribe) {
                    window.shop.state.listenerUnsubscribe();
                }

                const q = query(getProductsRef());
                
                window.shop.state.listenerUnsubscribe = onSnapshot(q, async (snapshot) => {
                    if (snapshot.empty) {
                        console.log("üì≠ DB Empty - no products");
                        window.shop.state.products = [];
                        window.shop.renderStore();
                        return; 
                    }

                    let dbProducts = [];
                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        dbProducts.push({ 
                            id: docSnap.id, 
                            ...data,
                            createdAt: data.createdAt ? 
                                (data.createdAt.toMillis ? data.createdAt.toMillis() : data.createdAt) : 
                                0
                        });
                    });
                    
                    const catOrder = ['–û–¥–Ω–æ—Ä–∞–∑–∫–∏', 'Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'];
                    
                    dbProducts.sort((a, b) => {
                        let indexA = catOrder.indexOf(a.category);
                        let indexB = catOrder.indexOf(b.category);
                    
                        if (indexA === -1) indexA = 999;
                        if (indexB === -1) indexB = 999;
                    
                        if (indexA !== indexB) {
                            return indexA - indexB;
                        }
                    
                        const tA = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt || 0);
                        const tB = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt || 0);
                        return tB - tA;
                    });
                    
                    console.log("üîÑ Realtime Update Received:", dbProducts.length);
                    window.shop.state.products = dbProducts;
                    
                    window.shop.updateCartBadge();
                    
                    if (document.querySelector('.nav-btn.text-green-400[data-view="store"]')) {
                        window.shop.renderStore();
                    }
                    
                    if (window.shop.state.isCartView) {
                        window.shop.updateCartView();
                    }
                    
                    if(window.lucide) window.lucide.createIcons();
                    
                }, (error) => {
                    console.error("‚ùå Products listener error:", error);
                    window.shop.showToast("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏", "–í–Ω–∏–º–∞–Ω–∏–µ");
                });
            },

            seedDatabase: async () => {
                try {
                    window.shop.showConfirm(
                        "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã",
                        "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
                        async () => {
                            window.shop.showToast("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...", "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è");

                            const batch = writeBatch(db);
                            const colRef = getProductsRef();
                            
                            const snapshot = await getDocs(colRef);
                            snapshot.forEach(docSnap => {
                                batch.delete(docSnap.ref);
                            });
                            
                            MOCK_PRODUCTS.forEach(item => {
                                const docRef = doc(colRef);
                                batch.set(docRef, { 
                                    ...item, 
                                    createdAt: serverTimestamp() 
                                });
                            });

                            await batch.commit();
                            window.shop.showToast("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", "–£—Å–ø–µ—à–Ω–æ");
                        }
                    );
                } catch (e) {
                    console.error("Seeding failed", e);
                    window.shop.showToast("–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", "–°–±–æ–π");
                }
            },

            // --- Custom Confirm Modal Methods ---
            showConfirm: function(title, text, callback) {
                document.getElementById('confirm-title').innerText = title;
                document.getElementById('confirm-text').innerText = text;
                document.getElementById('confirm-modal').classList.remove('hidden');
                this.state.confirmCallback = callback;
            },

            hideConfirm: function() {
                document.getElementById('confirm-modal').classList.add('hidden');
                this.state.confirmCallback = null;
            },

            confirmAction: function() {
                if (this.state.confirmCallback) {
                    const callback = this.state.confirmCallback;
                    this.hideConfirm();
                    callback();
                }
            },

            toggleDebug: () => {
                window.shop.state.debugClicks++;
                if (window.shop.state.debugClicks >= 5) {
                    const panel = document.getElementById('debug-panel');
                    const content = document.getElementById('debug-content');
                    panel.classList.remove('hidden');
                    
                    const info = {
                        "DETECTED_USER_ID": window.shop.state.user?.id,
                        "IS_ADMIN_BOOL": window.shop.state.isAdmin,
                        "FIREBASE_AUTH": auth.currentUser ? auth.currentUser.uid : 'Not authenticated',
                        "FIREBASE_UID": window.shop.state.firebaseUid,
                        "PRODUCTS_COUNT": window.shop.state.products.length,
                        "CART_ITEMS": window.shop.state.cart
                    };
                    
                    content.innerText = JSON.stringify(info, null, 2);
                    window.shop.state.debugClicks = 0;
                }
            },

            // --- UI Rendering ---
            switchView: (viewName) => {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const icon = btn.querySelector('svg') || btn.querySelector('i');
                    const text = btn.querySelector('span');
                    
                    if (btn.dataset.view === viewName) {
                        btn.classList.add('text-green-400');
                        btn.classList.remove('text-gray-500');
                        if(text) text.classList.add('text-green-400');
                    } else {
                        btn.classList.remove('text-green-400');
                        btn.classList.add('text-gray-500');
                        if(text) text.classList.remove('text-green-400');
                    }
                });

                const main = document.getElementById('main-content');
                main.innerHTML = '';
                main.style.opacity = '0';

                window.shop.state.isCartView = (viewName === 'cart');

                // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª–µ–π –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
                if (viewName !== 'user-orders' && window.shop.state.userOrdersListenerUnsubscribe) {
                    window.shop.state.userOrdersListenerUnsubscribe();
                    window.shop.state.userOrdersListenerUnsubscribe = null;
                }

                setTimeout(() => {
                    if (viewName === 'store') window.shop.renderStore(main);
                    else if (viewName === 'cart') window.shop.renderCart(main);
                    else if (viewName === 'profile') window.shop.renderProfile(main);
                    else if (viewName === 'admin-orders') window.shop.renderAdminOrders(main);
                    else if (viewName === 'user-orders') window.shop.renderUserOrders(main);
                    
                    main.style.opacity = '1';
                    
                    if(window.lucide) window.lucide.createIcons();
                }, 50);
            },

            setupCategoryScroll: () => {
                const scrollContainer = document.querySelector('.category-scroll');
                if (scrollContainer) {
                    scrollContainer.addEventListener('wheel', (evt) => {
                        evt.preventDefault();
                        scrollContainer.scrollLeft += evt.deltaY;
                    });
                }
            },

            renderStore: (container = document.getElementById('main-content')) => {
                if (!container) return;
                
                const categories = ['–í—Å–µ', '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', 'Pod-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'];
                let catHTML = `<div class="category-scroll flex gap-3 overflow-x-auto mx-[-1rem] px-4 mb-4 pb-2">`;
                categories.forEach(cat => {
                    const isActive = window.shop.state.currentCategory === cat;
                    const activeClass = isActive 
                        ? 'bg-green-500 text-black shadow-[0_0_20px_rgba(34,197,94,0.4)] scale-105' 
                        : 'bg-white/5 text-gray-400 border border-white/10 hover:bg-white/10';
                    catHTML += `
                        <button onclick="window.shop.filterCategory('${cat}')" 
                                class="whitespace-nowrap px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-[0.1em] transition-all duration-300 ${activeClass}">
                            ${cat}
                        </button>`;
                });
                catHTML += `</div>`;

                let gridHTML = `<div id="store-view" class="grid grid-cols-2 gap-3 pb-24">`;
                
                const filtered = window.shop.state.products.filter(p => {
                    const categoryMatch = window.shop.state.currentCategory === '–í—Å–µ' || p.category === window.shop.state.currentCategory;
                    
                    if (window.shop.state.isAdmin) {
                        return categoryMatch;
                    } else {
                        return categoryMatch && !p.isHidden;
                    }
                });

                if (filtered.length === 0) {
                     gridHTML += `<div class="col-span-2 text-center text-gray-500 py-10">
                        <i data-lucide="package-open" class="w-12 h-12 mx-auto mb-2 opacity-50 icon-fix"></i>
                        <p>–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                        ${window.shop.state.isAdmin ? '<p class="text-xs text-gray-600 mt-2">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä –≤ –º–µ–Ω—é –∞–¥–º–∏–Ω–∞ (+)</p>' : ''}
                      </div>`;
                } else {
                    filtered.forEach((p, index) => {
                        let imageContent;
                        if (p.image && (p.image.startsWith('data:image') || p.image.includes('http'))) {
                            imageContent = `<img src="${p.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">`;
                        } else {
                            imageContent = `<i data-lucide="${p.image || 'box'}" class="w-16 h-16 text-gray-600 group-hover:text-green-400 group-hover:scale-110 transition-all duration-300 icon-fix"></i>`;
                        }

                        const hiddenStyle = p.isHidden ? 'opacity-60 grayscale border-red-500/30' : '';
                        const hiddenBadge = p.isHidden ? `<div class="absolute top-2 left-2 z-20 bg-black/60 text-red-400 text-[8px] font-bold px-2 py-1 rounded backdrop-blur-sm border border-red-500/20">–°–ö–†–´–¢</div>` : '';
                        
                        const visibilityIcon = p.isHidden ? 'eye-off' : 'eye';
                        const visibilityColor = p.isHidden ? 'text-gray-400 hover:text-white' : 'text-blue-400 hover:text-white';

                        gridHTML += `
                        <div class="glass-panel rounded-2xl p-2.5 flex flex-col relative group overflow-hidden h-auto ${hiddenStyle}">
                            ${window.shop.state.isAdmin ? `
                                ${hiddenBadge}
                                <div class="absolute top-2 right-2 z-20 flex gap-1">
                                    <button onclick="window.shop.toggleHiddenProduct('${p.id}')" class="w-8 h-8 flex items-center justify-center bg-black/50 rounded-full ${visibilityColor} hover:bg-blue-600 transition-all backdrop-blur-sm">
                                        <i data-lucide="${visibilityIcon}" class="w-4 h-4 icon-fix"></i>
                                    </button>
                                    
                                    <button onclick="window.shop.editProduct('${p.id}')" class="w-8 h-8 flex items-center justify-center bg-black/50 rounded-full text-green-500 hover:bg-green-500 hover:text-white transition-all backdrop-blur-sm">
                                        <i data-lucide="edit" class="w-4 h-4 icon-fix"></i>
                                    </button>
                                    
                                    <button onclick="window.shop.deleteProduct('${p.id}')" class="w-8 h-8 flex items-center justify-center bg-black/50 rounded-full text-red-500 hover:bg-red-500 hover:text-white transition-all backdrop-blur-sm">
                                        <i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i>
                                    </button>
                                </div>
                            ` : ''}
                            
                            <div class="aspect-[3/4] bg-white/5 rounded-xl mb-3 flex items-center justify-center relative overflow-hidden group-hover:bg-white/10 transition-colors w-full">
                                <div class="absolute inset-0 bg-gradient-to-tr from-green-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none z-10"></div>
                                ${imageContent}
                            </div>
                            
                            <div class="flex-grow flex flex-col justify-between">
                                <div>
                                    <h3 class="text-xs font-bold text-gray-100 leading-tight mb-1 line-clamp-2 h-[2.5em]">${p.name}</h3>
                                    <p class="text-[9px] text-gray-500 uppercase tracking-widest mb-2 border-l-2 border-green-500/50 pl-2">${p.category}</p>
                                </div>
                                
                                <div class="flex items-end justify-between mt-1">
                                    <div class="flex flex-col">
                                        <span class="text-[9px] text-gray-500">–¶–µ–Ω–∞</span>
                                        <span class="text-green-400 font-bold text-sm tracking-wide neon-text-green">${p.price} ‚ÇΩ</span>
                                    </div>
                                    <button onclick="window.shop.addToCart('${p.id}')" 
                                            class="w-8 h-8 rounded-lg bg-green-500 text-black flex items-center justify-center transition-all btn-press shadow-[0_0_10px_rgba(34,197,94,0.4)] hover:scale-110"
                                            ${p.isHidden ? 'disabled style="opacity:0.5; filter:grayscale(1);"' : ''}>
                                        <i data-lucide="plus" class="w-5 h-5 icon-fix"></i>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    });
                }
                gridHTML += `</div>`;
                container.innerHTML = catHTML + gridHTML;
                
                window.shop.setupCategoryScroll();
                
                if(window.lucide) window.lucide.createIcons();
            },

            renderCart: (container) => {
                window.shop.state.cartRendering = true;
                
                const cartIds = Object.keys(window.shop.state.cart);
                const products = window.shop.state.products.filter(p => cartIds.includes(p.id));
                let total = 0;

                if (products.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-[60vh] text-gray-500">
                            <div class="w-24 h-24 rounded-full bg-white/5 flex items-center justify-center mb-6 shadow-inner shadow-black/50">
                                <i data-lucide="shopping-cart" class="w-10 h-10 opacity-30 icon-fix"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
                            <p class="text-xs text-gray-500 mb-6">–°–∞–º–æ–µ –≤—Ä–µ–º—è –≤—ã–±—Ä–∞—Ç—å —á—Ç–æ-—Ç–æ —Ç–æ–ø–æ–≤–æ–µ.</p>
                            <button onclick="window.shop.switchView('store')" class="px-8 py-3 bg-green-500 text-black font-bold rounded-xl text-xs uppercase tracking-widest hover:bg-green-400 transition-colors">–í –ö–ê–¢–ê–õ–û–ì</button>
                        </div>`;
                    
                    window.shop.state.cartRendering = false;
                    if(window.lucide) window.lucide.createIcons();
                    return;
                }

                let html = `<div class="space-y-3 pb-36 px-1" id="cart-items-container">`;
                
                products.forEach((p, idx) => {
                    const qty = window.shop.state.cart[p.id];
                    total += p.price * qty;
                    
                    let imageContent;
                    if (p.image && (p.image.startsWith('data:image') || p.image.includes('http'))) {
                        imageContent = `<img src="${p.image}" class="w-full h-full object-cover rounded-lg">`;
                    } else {
                        imageContent = `<i data-lucide="${p.image || 'box'}" class="w-6 h-6 text-gray-400 icon-fix"></i>`;
                    }

                    html += `
                        <div class="cart-item glass-panel rounded-xl p-3 flex items-center gap-4" data-product-id="${p.id}" id="cart-item-${p.id}">
                            <div class="w-14 h-14 rounded-lg bg-white/5 flex items-center justify-center border border-white/5 overflow-hidden">
                                ${imageContent}
                            </div>
                            <div class="flex-grow">
                                <h3 class="text-sm font-bold text-white">${p.name}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <p class="text-xs text-green-400 font-mono">${p.price} ‚ÇΩ</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 bg-black/40 rounded-lg p-1 border border-white/5">
                                <button onclick="window.shop.updateQty('${p.id}', -1)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 rounded-md transition-colors ${qty <= 1 ? 'opacity-30' : ''}">
                                    <i data-lucide="minus" class="w-3 h-3 icon-fix"></i>
                                </button>
                                <span class="text-sm font-bold w-6 text-center text-white cart-item-qty">${qty}</span>
                                <button onclick="window.shop.updateQty('${p.id}', 1)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 rounded-md transition-colors">
                                    <i data-lucide="plus" class="w-3 h-3 icon-fix"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });

                let finalTotal = total;
                let discountHtml = '';
                if (window.shop.state.activePromo) {
                    let discountAmount = 0;
                    
                    if (window.shop.state.activePromo.type === 'percent') {
                        discountAmount = Math.floor((total * window.shop.state.activePromo.percent) / 100);
                    } else if (window.shop.state.activePromo.type === 'fixed') {
                        const cartItems = Object.entries(window.shop.state.cart);
                        let itemsProcessed = 0;
                        
                        for (const [productId, quantity] of cartItems) {
                            const product = window.shop.state.products.find(p => p.id === productId);
                            if (product) {
                                for (let i = 0; i < quantity; i++) {
                                    if (itemsProcessed < window.shop.state.activePromo.fixed_quantity) {
                                        discountAmount += (product.price * window.shop.state.activePromo.fixed_discount) / 100;
                                        itemsProcessed++;
                                    } else {
                                        break;
                                    }
                                }
                            }
                            if (itemsProcessed >= window.shop.state.activePromo.fixed_quantity) break;
                        }
                    }
                    
                    finalTotal = total - discountAmount;
                    discountHtml = `
                        <div class="flex justify-between items-center text-green-400 text-xs mt-1">
                            <span class="uppercase tracking-widest">–ü–†–û–ú–û–ö–û–î: ${window.shop.state.activePromo.code}</span>
                            <span>-${discountAmount} ‚ÇΩ</span>
                        </div>
                    `;
                }

                html += `</div>`;
                
                html += `
                    <div class="fixed bottom-24 left-4 right-4 glass-panel p-5 rounded-3xl flex flex-col gap-2 border-t border-green-500/20 shadow-[0_0_40px_rgba(0,0,0,0.8)] z-30">
                        ${discountHtml}
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">–ò—Ç–æ–≥–æ</p>
                                <p class="text-2xl font-black text-white neon-text-green" id="cart-total">${finalTotal} <span class="text-sm align-top text-gray-500 font-normal">RUB</span></p>
                            </div>
                            <button onclick="window.shop.initCheckout(${finalTotal})" class="bg-green-500 text-black px-6 py-4 rounded-xl font-black italic text-sm shadow-[0_0_20px_rgba(34,197,94,0.3)] active:scale-95 transition-transform flex items-center gap-2">
                                –û–ü–õ–ê–¢–ò–¢–¨ <i data-lucide="arrow-right" class="w-4 h-4 icon-fix"></i>
                            </button>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                
                window.shop.state.cartRendering = false;
                if(window.lucide) window.lucide.createIcons();
            },

            updateCartView: () => {
                if (!window.shop.state.isCartView || window.shop.state.cartRendering) return;
                window.shop.renderCart(document.getElementById('main-content'));
            },

            renderProfile: (container) => {
                const u = window.shop.state.user;
                const roleColor = window.shop.state.isAdmin ? 'text-red-500' : 'text-green-500';
                const roleBg = window.shop.state.isAdmin ? 'bg-red-500' : 'bg-green-500';
                const roleName = window.shop.state.isAdmin ? '–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†' : '–ö–õ–ò–ï–ù–¢';

                let profileHtml = `
                    <div class="glass-panel rounded-3xl p-8 mb-6 flex flex-col items-center text-center relative overflow-hidden border border-white/10">
                        <div class="absolute inset-0 bg-gradient-to-b from-green-500/5 to-transparent"></div>
                        
                        <div class="w-28 h-28 rounded-full p-1 border-2 border-white/10 mb-5 relative z-10 shadow-[0_0_30px_rgba(0,0,0,0.5)]">
                            <img src="${document.getElementById('user-avatar').src}" class="w-full h-full rounded-full object-cover">
                            <div class="absolute bottom-1 right-1 w-6 h-6 ${roleBg} rounded-full border-4 border-[#111] z-20"></div>
                        </div>
                        
                        <h2 class="text-2xl font-black text-white relative z-10 italic">${u.first_name} ${u.last_name || ''}</h2>
                        <p class="text-sm text-gray-500 mb-6 relative z-10 font-mono">ID: ${u.id}</p>
                        
                        <div class="flex items-center gap-2 bg-black/60 px-5 py-2 rounded-full border border-white/10 relative z-10">
                            <div class="w-2 h-2 rounded-full ${roleBg} animate-pulse"></div>
                            <span class="text-[10px] font-black tracking-[0.2em] ${roleColor}">${roleName}</span>
                        </div>
                    </div>`;

                if (window.shop.state.isAdmin) {
                    profileHtml += `
                        <button onclick="window.shop.switchView('admin-orders')" class="w-full mb-3 bg-gradient-to-r from-red-600 to-red-500 text-white font-black italic uppercase tracking-wider py-4 rounded-xl shadow-[0_0_20px_rgba(239,68,68,0.3)] flex items-center justify-center gap-3 animate-pulse border border-red-400/50">
                            <i data-lucide="package-search" class="w-5 h-5 icon-fix"></i>
                            –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê–ú–ò
                        </button>
                    `;
                }

                profileHtml += `
                    <div class="glass-panel rounded-2xl p-1 space-y-1">
                         <div class="p-4 flex items-center gap-4 hover:bg-white/5 rounded-xl transition-colors cursor-pointer" onclick="window.shop.toggleUserPromoModal()">
                            <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-gray-400"><i data-lucide="ticket" class="w-5 h-5 icon-fix"></i></div>
                            <div class="flex-grow">
                                <h4 class="text-sm font-bold text-white">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h4>
                                <p class="text-xs text-gray-600">–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∫–∏–¥–∫–∏</p>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 icon-fix"></i>
                         </div>
                         
                         ${window.shop.state.isAdmin ? `
                             <div class="p-4 flex items-center gap-4 hover:bg-white/5 rounded-xl transition-colors cursor-pointer" onclick="window.shop.toggleAdminPromoModal()">
                                <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400"><i data-lucide="settings-2" class="w-5 h-5 icon-fix"></i></div>
                                <div class="flex-grow">
                                    <h4 class="text-sm font-bold text-white">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü—Ä–æ–º–æ</h4>
                                    <p class="text-xs text-gray-600">–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 icon-fix"></i>
                             </div>
                         ` : ''}

                         <div class="p-4 flex items-center gap-4 hover:bg-white/5 rounded-xl transition-colors cursor-pointer" onclick="window.open('https://t.me/Tru5tNoBody', '_blank')">
                            <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-gray-400"><i data-lucide="shield" class="w-5 h-5 icon-fix"></i></div>
                            <div class="flex-grow">
                                <h4 class="text-sm font-bold text-white">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h4>
                                <p class="text-xs text-gray-600">–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–æ–º</p>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 icon-fix"></i>
                         </div>
                    </div>
                `;

                container.innerHTML = profileHtml;
                
                if(window.lucide) window.lucide.createIcons();
            },

            // --- RENDER USER ORDERS (–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø) ---
            renderUserOrders: function(container) {
                const isSelectMode = this.state.userOrdersSelectionMode;
                const selectedCount = this.state.selectedUserOrders.size;

                container.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <button onclick="window.shop.switchView('profile')" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-gray-400 hover:text-white">
                                <i data-lucide="arrow-left" class="w-5 h-5 icon-fix"></i>
                            </button>
                            <h2 class="text-xl font-black italic text-white">–ú–û–ò <span class="text-green-500">–ó–ê–ö–ê–ó–´</span></h2>
                        </div>
                        <button onclick="window.shop.toggleUserOrdersSelectionMode()" 
                                class="px-3 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all border border-red-500/30 hover:bg-red-500/20 text-red-400 flex items-center gap-2 ${isSelectMode && selectedCount > 0 ? 'bg-red-500/20' : ''}">
                            ${isSelectMode ? 
                                (selectedCount > 0 ? 
                                    '<i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i> –£–î–ê–õ–ò–¢–¨' : 
                                    '<i data-lucide="x" class="w-4 h-4 icon-fix"></i> –û–¢–ú–ï–ù–ê') : 
                                '<i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i> –í–´–ë–†–ê–¢–¨'}
                        </button>
                    </div>
                    <div id="user-orders-list" class="space-y-3 pb-32">
                        <div class="text-center py-10 text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
                    </div>
                `;
                
                if (this.state.userOrdersListenerUnsubscribe) {
                    this.state.userOrdersListenerUnsubscribe();
                    this.state.userOrdersListenerUnsubscribe = null;
                }

                const uid = this.state.firebaseUid;
                if (!uid) {
                    document.getElementById('user-orders-list').innerHTML = '<div class="text-center py-10 text-gray-500">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–∫–∞–∑—ã</div>';
                    return;
                }

                const userOrdersCollection = getUserOrdersRef(uid);
                const q = query(userOrdersCollection);
                
                this.state.userOrdersListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                    this.updateUserOrdersList(snapshot);
                });

                setTimeout(() => {
                    this.renderUserOrdersFab();
                }, 50);
            },

            // --- UPDATE USER ORDERS LIST ---
            updateUserOrdersList: function(snapshot = null) {
                const list = document.getElementById('user-orders-list');
                if (!list) return;
                
                if (snapshot) {
                    if (snapshot.empty) {
                        list.innerHTML = `<div class="text-center py-10 text-gray-500">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>`;
                        this.state.userOrders = [];
                        this.renderUserOrdersFab();
                        return;
                    }

                    let docs = [];
                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        docs.push({ 
                            firestoreId: docSnap.id, 
                            ...data,
                            date: data.date ? 
                                (data.date.toDate ? data.date.toDate() : new Date(data.date)) : 
                                new Date()
                        });
                    });
                    
                    docs.sort((a, b) => b.date - a.date);
                    
                    this.state.userOrders = docs;
                }
                
                const docs = this.state.userOrders || [];
                
                let html = '';
                docs.forEach(data => {
                    const date = new Date(data.date).toLocaleString('ru-RU', { 
                        day: 'numeric', 
                        month: 'short', 
                        hour: '2-digit', 
                        minute:'2-digit' 
                    });
                    
                    const isSelected = this.state.selectedUserOrders.has(data.firestoreId);
                    
                    let statusClass = 'status-pending';
                    let statusText = '–û–ñ–ò–î–ê–ï–¢';
                    
                    if (data.status === 'approved') {
                        statusClass = 'status-approved';
                        statusText = '–ü–†–ò–ù–Ø–¢';
                    } else if (data.status === 'rejected') {
                        statusClass = 'status-rejected';
                        statusText = '–û–¢–ö–õ–û–ù–ï–ù';
                    }

                    let paymentBadge = '';
                    let paymentClass = 'payment-status-pending';
                    let paymentText = '–û–ñ–ò–î–ê–ï–¢';
                    
                    if (data.payment_method === 'now' && data.payment_status === 'paid') {
                        paymentClass = 'payment-status-paid';
                        paymentText = '–û–ü–õ–ê–ß–ï–ù–û';
                    } else if (data.payment_method === 'now' && data.payment_status === 'pending') {
                        paymentClass = 'payment-status-pending';
                        paymentText = '–ù–ï –û–ü–õ–ê–ß–ï–ù–û';
                    } else if (data.payment_method === 'on_delivery') {
                        paymentClass = 'payment-status-waiting';
                        paymentText = '–ü–†–ò –ü–û–õ–£–ß–ï–ù–ò–ò';
                    }
                    
                    paymentBadge = `<div class="${paymentClass} status-badge mt-1 text-[8px]">${paymentText}</div>`;

                    const cardStyle = isSelected 
                        ? 'border-red-500 bg-red-500/10' 
                        : `hover:bg-white/5 border-l-4 ${data.status === 'approved' ? 'border-l-green-500' : (data.status === 'rejected' ? 'border-l-red-500' : 'border-l-yellow-500')}`;

                    const clickAction = this.state.userOrdersSelectionMode 
                        ? `window.shop.toggleUserOrderSelection('${data.firestoreId}')`
                        : `window.shop.openUserOrderDetails('${data.firestoreId}')`;

                    const checkboxHtml = this.state.userOrdersSelectionMode 
                        ? `<div class="mr-3 pt-1">
                             <div class="order-checkbox ${isSelected ? 'checked' : ''}">
                                ${isSelected ? '<i data-lucide="check" class="w-3 h-3 text-white icon-fix"></i>' : ''}
                             </div>
                            </div>` 
                        : '';

                    html += `
                        <div onclick="${clickAction}" class="glass-panel rounded-xl p-4 cursor-pointer transition-all duration-200 ${cardStyle} flex mb-2">
                            ${checkboxHtml}
                            <div class="flex-grow">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex flex-col">
                                        <span class="text-[10px] text-gray-500 font-mono tracking-widest">${data.order_key || 'NO-ID'}</span>
                                        <span class="text-sm font-bold text-white">${data.delivery?.name || '–ö–ª–∏–µ–Ω—Ç'}</span>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <div class="${statusClass} status-badge">
                                            ${statusText}
                                        </div>
                                        ${paymentBadge}
                                    </div>
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="text-xs text-gray-500">${date}</div>
                                    <div class="text-green-400 font-bold font-mono">${data.total} ‚ÇΩ</div>
                                </div>
                                ${data.promo ? `<div class="text-xs text-green-400 mt-1"><i data-lucide="ticket" class="w-3 h-3 inline mr-1 icon-fix"></i>${data.promo}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                list.innerHTML = html;
                if(window.lucide) window.lucide.createIcons();
                
                this.renderUserOrdersFab();
            },

            // --- USER ORDERS SELECTION LOGIC ---
            toggleUserOrdersSelectionMode: function() {
                this.state.userOrdersSelectionMode = !this.state.userOrdersSelectionMode;
                if (!this.state.userOrdersSelectionMode) {
                    this.state.selectedUserOrders.clear();
                }
                this.updateUserOrdersList();
                this.updateUserOrdersSelectionButton();
                this.renderUserOrdersFab();
            },

            toggleUserOrderSelection: function(docId) {
                const set = this.state.selectedUserOrders;
                if (set.has(docId)) {
                    set.delete(docId);
                } else {
                    set.add(docId);
                }
                this.updateUserOrdersList();
                this.updateUserOrdersSelectionButton();
                this.renderUserOrdersFab();
            },

            updateUserOrdersSelectionButton: function() {
                const selectedCount = this.state.selectedUserOrders.size;
                const button = document.querySelector('button[onclick="window.shop.toggleUserOrdersSelectionMode()"]');
                if (button) {
                    button.innerHTML = this.state.userOrdersSelectionMode ? 
                        (selectedCount > 0 ? 
                            `<i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i> –£–î–ê–õ–ò–¢–¨` : 
                            '<i data-lucide="x" class="w-4 h-4 icon-fix"></i> –û–¢–ú–ï–ù–ê') : 
                        '<i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i> –í–´–ë–†–ê–¢–¨';
                    
                    if (this.state.userOrdersSelectionMode && selectedCount > 0) {
                        button.classList.add('bg-red-500/20');
                    } else {
                        button.classList.remove('bg-red-500/20');
                    }
                }
            },

            renderUserOrdersFab: function() {
                const isSelectMode = this.state.userOrdersSelectionMode;
                const selectedCount = this.state.selectedUserOrders.size;
                
                let fabContainer = document.getElementById('user-orders-fab');
                if (!fabContainer) {
                    fabContainer = document.createElement('div');
                    fabContainer.id = 'user-orders-fab';
                    fabContainer.className = 'fixed bottom-24 left-4 right-4 z-30';
                    document.getElementById('main-content').appendChild(fabContainer);
                }
                
                if (isSelectMode && selectedCount > 0) {
                    fabContainer.innerHTML = `
                        <button onclick="window.shop.deleteSelectedUserOrders()" class="w-full bg-red-600 hover:bg-red-500 text-white font-black italic uppercase tracking-wider py-4 rounded-xl shadow-[0_0_20px_rgba(239,68,68,0.3)] flex items-center justify-center gap-2 transition-all active:scale-95 animate-float-up">
                            <i data-lucide="trash-2" class="w-5 h-5 icon-fix"></i>
                            –£–î–ê–õ–ò–¢–¨ (${selectedCount})
                        </button>
                    `;
                    fabContainer.classList.remove('hidden');
                } else {
                    fabContainer.innerHTML = '';
                    fabContainer.classList.add('hidden');
                }
                
                if(window.lucide) window.lucide.createIcons();
            },

            deleteSelectedUserOrders: function() {
                const count = this.state.selectedUserOrders.size;
                if (count === 0) return;
                
                this.showConfirm(
                    "–£–î–ê–õ–ò–¢–¨ –í–´–ë–†–ê–ù–ù–´–ï –ó–ê–ö–ê–ó–´",
                    `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã (${count})? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`,
                    async () => {
                        this.showToast(`–£–¥–∞–ª–µ–Ω–∏–µ ${count} –∑–∞–∫–∞–∑–æ–≤...`, "–û–±—Ä–∞–±–æ—Ç–∫–∞");
                        
                        try {
                            const uid = this.state.firebaseUid;
                            const promises = Array.from(this.state.selectedUserOrders).map(id => {
                                const orderRef = getUserOrderRef(uid, id);
                                return deleteDoc(orderRef);
                            });
                            
                            await Promise.all(promises);
                            
                            this.state.userOrders = this.state.userOrders.filter(order => 
                                !this.state.selectedUserOrders.has(order.firestoreId)
                            );
                            
                            this.state.selectedUserOrders.clear();
                            this.state.userOrdersSelectionMode = false;
                            
                            this.updateUserOrdersList();
                            this.renderUserOrdersFab();
                            this.showToast("–ó–∞–∫–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã", "–£—Å–ø–µ—à–Ω–æ");
                            
                        } catch (e) {
                            console.error(e);
                            this.showToast("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "–°–±–æ–π");
                        }
                    }
                );
            },

            // --- OPEN USER ORDER DETAILS ---
            openUserOrderDetails: async function(docId) {
                try {
                    const uid = this.state.firebaseUid;
                    const orderRef = getUserOrderRef(uid, docId);
                    const docSnap = await getDoc(orderRef);
                    if (!docSnap.exists()) return;
                    
                    const data = docSnap.data();
                    const modal = document.getElementById('user-order-detail-modal');
                    const content = document.getElementById('user-order-detail-content');
                    
                    const dateObj = data.date && data.date.toDate ? data.date.toDate() : new Date(data.date);
                    const dateStr = dateObj.toLocaleString('ru-RU', { 
                        day: 'numeric', month: 'long', hour: '2-digit', minute:'2-digit' 
                    });

                    let itemsHtml = '';
                    let subtotal = 0;

                    if (data.items) {
                        for (const [key, qty] of Object.entries(data.items)) {
                             const prod = window.shop.state.products.find(p => p.id === key);
                             const name = prod ? prod.name : '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω';
                             const price = prod ? prod.price : 0;
                             const itemSum = price * qty;
                             subtotal += itemSum;

                             itemsHtml += `
                                <div class="flex justify-between text-xs py-2 border-b border-white/5 items-center">
                                    <div class="flex flex-col">
                                        <span class="text-white">${name}</span>
                                        <span class="text-[9px] text-gray-500">${price} ‚ÇΩ x ${qty} —à—Ç.</span>
                                    </div>
                                    <span class="text-gray-300 font-mono">${itemSum} ‚ÇΩ</span>
                                </div>`;
                        }
                    }

                    const realSubtotal = subtotal > 0 ? subtotal : data.total;
                    const discountAmount = realSubtotal - data.total;
                    const hasDiscount = discountAmount > 0;

                    let paymentStatusHtml = '';
                    if (data.payment_method === 'now' && data.payment_status === 'paid') {
                        paymentStatusHtml = `<div class="payment-status-paid status-badge w-full text-center mt-2">–û–ü–õ–ê–ß–ï–ù–û –û–ù–õ–ê–ô–ù</div>`;
                    } else if (data.payment_method === 'now' && data.payment_status === 'pending') {
                        paymentStatusHtml = `<div class="payment-status-pending status-badge w-full text-center mt-2">–ù–ï –û–ü–õ–ê–ß–ï–ù–û</div>`;
                    } else if (data.payment_method === 'on_delivery') {
                        paymentStatusHtml = `<div class="payment-status-waiting status-badge w-full text-center mt-2">–û–ü–õ–ê–¢–ê –ü–†–ò –ü–û–õ–£–ß–ï–ù–ò–ò</div>`;
                    }

                    let statusBadge = '';
                    if (data.status === 'approved') {
                        statusBadge = `<div class="status-approved status-badge w-full text-center mt-2">–ó–ê–ö–ê–ó –ü–†–ò–ù–Ø–¢</div>`;
                    } else if (data.status === 'rejected') {
                        statusBadge = `<div class="status-rejected status-badge w-full text-center mt-2">–ó–ê–ö–ê–ó –û–¢–ö–õ–û–ù–ï–ù</div>`;
                    } else {
                        statusBadge = `<div class="status-pending status-badge w-full text-center mt-2">–û–ñ–ò–î–ê–ï–¢ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø</div>`;
                    }

                    content.innerHTML = `
                        <div class="text-center mb-4 relative">
                            <h3 class="text-lg font-black italic text-white">–ó–ê–ö–ê–ó ${data.order_key || '...'}</h3>
                            <p class="text-xs text-gray-500 capitalize">${dateStr}</p>
                        </div>
                        
                        <div class="bg-black/40 rounded-xl p-3 mb-4 border border-white/10">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2 flex items-center gap-1"><i data-lucide="user" class="w-3 h-3 icon-fix"></i> –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</p>
                            <div class="space-y-1">
                                <p class="text-sm text-white flex justify-between"><span class="text-gray-500">–ò–º—è:</span> ${data.delivery?.name}</p>
                                <p class="text-sm text-white flex justify-between"><span class="text-gray-500">–¢–µ–ª:</span> ${data.delivery?.phone}</p>
                                <p class="text-sm text-white flex justify-between"><span class="text-gray-500">–í–æ–∑—Ä–∞—Å—Ç:</span> ${data.delivery?.age || '-'}</p>
                                <p class="text-sm text-white flex justify-between"><span class="text-gray-500">–ù–∏–∫:</span> ${data.delivery?.contact}</p>
                            </div>
                            <div class="mt-2 pt-2 border-t border-white/5 space-y-1">
                                <p class="text-sm text-white"><span class="text-gray-500 block text-[10px] uppercase">–ê–¥—Ä–µ—Å:</span> ${data.delivery?.place}</p>
                                <p class="text-sm text-white"><span class="text-gray-500 block text-[10px] uppercase">–í—Ä–µ–º—è:</span> ${data.delivery?.time}</p>
                            </div>
                        </div>

                        <div class="bg-black/40 rounded-xl p-3 mb-4 border border-white/10">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2 flex items-center gap-1"><i data-lucide="credit-card" class="w-3 h-3 icon-fix"></i> –û–ø–ª–∞—Ç–∞</p>
                            <p class="text-sm text-white mb-2">${data.payment_method === 'now' ? '–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É' : '–ù–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏'}</p>
                            ${paymentStatusHtml}
                        </div>

                        <div class="bg-black/40 rounded-xl p-3 mb-6 border border-white/10">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2 flex items-center gap-1"><i data-lucide="shopping-bag" class="w-3 h-3 icon-fix"></i> –¢–æ–≤–∞—Ä—ã</p>
                            ${itemsHtml}
                            
                            <div class="mt-3 pt-2 space-y-2">
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤:</span>
                                    <span>${realSubtotal} ‚ÇΩ</span>
                                </div>
                                
                                ${hasDiscount ? `
                                <div class="flex justify-between items-center text-xs text-green-400 font-bold bg-green-900/20 p-2 rounded-lg border border-green-500/20">
                                    <span class="flex items-center gap-2">
                                        <i data-lucide="ticket" class="w-3 h-3"></i> 
                                        –°–∫–∏–¥–∫–∞ (<span class="text-white uppercase font-black">${data.promo || 'PROMO'}</span>):
                                    </span>
                                    <span>-${discountAmount} ‚ÇΩ</span>
                                </div>
                                ` : ''}

                                <div class="flex justify-between mt-2 pt-2 border-t border-white/10 items-center">
                                    <span class="text-white font-bold text-sm">–ö –û–ü–õ–ê–¢–ï</span>
                                    <span class="text-green-400 font-black text-xl neon-text-green">${data.total} ‚ÇΩ</span>
                                </div>
                            </div>
                        </div>

                        ${statusBadge}

                        <div class="mt-6">
                            <button onclick="document.getElementById('user-order-detail-modal').classList.add('hidden')" class="w-full py-3 bg-white/5 text-white rounded-xl font-bold text-sm hover:bg-white/10 transition-colors">
                                –ó–ê–ö–†–´–¢–¨
                            </button>
                        </div>
                    `;
                    
                    modal.classList.remove('hidden');
                    if(window.lucide) window.lucide.createIcons();

                } catch (e) {
                    console.error(e);
                    window.shop.showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '–°–±–æ–π');
                }
            },

            // --- PROMO CODE MODALS LOGIC ---
            toggleUserPromoModal: () => {
                const modal = document.getElementById('user-promo-modal');
                modal.classList.toggle('hidden');
                if (!modal.classList.contains('hidden')) {
                    document.getElementById('promo-input').value = '';
                    setTimeout(() => {
                        document.getElementById('promo-input').focus();
                    }, 100);
                }
            },

            activatePromo: async () => {
                const code = document.getElementById('promo-input').value.trim().toUpperCase();
                if (!code) return;

                window.shop.showToast("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞...", "–ó–∞–≥—Ä—É–∑–∫–∞");

                try {
                    const promosRef = getPromocodesRef();
                    const snapshot = await getDocs(promosRef);

                    if (snapshot.empty) {
                        window.shop.showToast("–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω", "–û—à–∏–±–∫–∞");
                        return;
                    }

                    let promoData = null;
                    let promoDocId = null;

                    snapshot.forEach(doc => { 
                        const d = doc.data();
                        if (d.code === code) {
                            promoData = d;
                            promoDocId = doc.id;
                        }
                    });

                    if (!promoData) {
                         window.shop.showToast("–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω", "–û—à–∏–±–∫–∞");
                         return;
                    }

                    if (promoData.activations >= promoData.limit) {
                        window.shop.showToast("–õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω", "–û—à–∏–±–∫–∞");
                        return;
                    }

                    window.shop.state.activePromo = {
                        id: promoDocId,
                        code: promoData.code,
                        type: promoData.type || 'percent',
                        percent: promoData.percent || 0,
                        fixed_discount: promoData.fixed_discount || 0,
                        fixed_quantity: promoData.fixed_quantity || 0
                    };

                    window.shop.subscribeToActivePromo(promoDocId);

                    window.shop.showToast(`–°–∫–∏–¥–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!`, "–£—Å–ø–µ—à–Ω–æ");
                    window.shop.toggleUserPromoModal();
                    
                    if (window.shop.state.isCartView) window.shop.updateCartView();

                } catch (e) {
                    console.error("Promo Error:", e);
                    window.shop.showToast("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏", "–°–±–æ–π");
                }
            },

            subscribeToActivePromo: function(promoId) {
                if (this.state.activePromoListener) {
                    this.state.activePromoListener();
                }

                const promoRef = getPromoDocRef(promoId);
                
                this.state.activePromoListener = onSnapshot(promoRef, (docSnap) => {
                    if (!docSnap.exists()) {
                        if (this.state.activePromo && this.state.activePromo.id === promoId) {
                            this.state.activePromo = null;
                            this.showToast("–ü—Ä–æ–º–æ–∫–æ–¥ –±—ã–ª —É–¥–∞–ª–µ–Ω", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
                            if (this.state.isCartView) this.updateCartView();
                        }
                        return;
                    }
                    
                    const data = docSnap.data();
                    if (data.activations >= data.limit) {
                        if (this.state.activePromo && this.state.activePromo.id === promoId) {
                            this.state.activePromo = null;
                            this.showToast("–õ–∏–º–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—á–µ—Ä–ø–∞–Ω", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
                            if (this.state.isCartView) this.updateCartView();
                        }
                    }
                });
            },

            // --- ADMIN PROMO LOGIC ---
            toggleAdminPromoModal: () => {
                const modal = document.getElementById('admin-promo-modal');
                modal.classList.toggle('hidden');
                
                if (!modal.classList.contains('hidden')) {
                    document.getElementById('new-promo-code').value = '';
                    document.getElementById('new-promo-percent').value = '';
                    document.getElementById('new-promo-fixed-discount').value = '';
                    document.getElementById('new-promo-fixed-quantity').value = '';
                    document.getElementById('new-promo-limit').value = '';
                    
                    window.shop.state.promoType = 'percent';
                    window.shop.selectPromoType('percent');
                    
                    setTimeout(() => {
                        document.getElementById('new-promo-code').focus();
                    }, 100);
                    
                    if (!window.shop.state.adminPromoUnsubscribe) {
                        const promosRef = getPromocodesRef();
                        const q = query(promosRef);
                        
                        window.shop.state.adminPromoUnsubscribe = onSnapshot(q, (snapshot) => {
                            const list = document.getElementById('admin-promo-list');
                            if (!list) return;
                            
                            if (snapshot.empty) {
                                list.innerHTML = '<div class="text-center text-gray-600 text-xs py-2">–ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</div>';
                                return;
                            }
                            
                            let docs = [];
                            snapshot.forEach(doc => {
                                docs.push({ id: doc.id, ...doc.data() });
                            });
                            
                            docs.sort((a, b) => {
                                const getMs = (d) => d?.createdAt?.toMillis ? d.createdAt.toMillis() : (d?.createdAt || 0);
                                return getMs(b) - getMs(a);
                            });

                            let html = '';
                            docs.forEach(data => {
                                let typeText = '–ü—Ä–æ—Ü–µ–Ω—Ç';
                                let discountText = `${data.percent}%`;
                                
                                if (data.type === 'fixed') {
                                    typeText = '–°–∫–∏–¥–∫–∞ –Ω–∞ –∫–æ–ª-–≤–æ';
                                    discountText = `${data.fixed_discount}% –Ω–∞ ${data.fixed_quantity} —Ç–æ–≤–∞—Ä–∞(–æ–≤)`;
                                }
                                
                                html += `
                                    <div class="bg-black/40 rounded-xl p-3 border border-white/5 flex justify-between items-center">
                                        <div>
                                            <p class="text-sm font-bold text-white font-mono">${data.code}</p>
                                            <p class="text-[10px] text-gray-500">${typeText}: ${discountText} | –õ–∏–º–∏—Ç: ${data.activations}/${data.limit}</p>
                                        </div>
                                        <button onclick="window.shop.deletePromoCode('${data.id}')" class="text-red-500 hover:text-red-400 p-2">
                                            <i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i>
                                        </button>
                                    </div>
                                `;
                            });
                            list.innerHTML = html;
                            if(window.lucide) window.lucide.createIcons();
                        });
                    }
                }
            },

            createPromoCode: async () => {
                const code = document.getElementById('new-promo-code').value.trim().toUpperCase();
                const limit = Number(document.getElementById('new-promo-limit').value);
                const type = window.shop.state.promoType;

                if (!code || !limit) {
                    window.shop.showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è", "–û—à–∏–±–∫–∞");
                    return;
                }

                let promoData = {
                    code,
                    limit,
                    activations: 0,
                    type: type,
                    createdAt: serverTimestamp()
                };

                if (type === 'percent') {
                    const percent = Number(document.getElementById('new-promo-percent').value);
                    if (!percent) {
                        window.shop.showToast("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏", "–û—à–∏–±–∫–∞");
                        return;
                    }
                    promoData.percent = percent;
                } else if (type === 'fixed') {
                    const fixedDiscount = Number(document.getElementById('new-promo-fixed-discount').value);
                    const fixedQuantity = Number(document.getElementById('new-promo-fixed-quantity').value);
                    
                    if (!fixedDiscount || !fixedQuantity) {
                        window.shop.showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è —Å–∫–∏–¥–∫–∏ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–û—à–∏–±–∫–∞");
                        return;
                    }
                    promoData.fixed_discount = fixedDiscount;
                    promoData.fixed_quantity = fixedQuantity;
                }

                try {
                    const promosRef = getPromocodesRef();
                    await addDoc(promosRef, promoData);
                    
                    window.shop.showToast("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω", "–£—Å–ø–µ—à–Ω–æ");
                    
                    document.getElementById('new-promo-code').value = '';
                    document.getElementById('new-promo-percent').value = '';
                    document.getElementById('new-promo-fixed-discount').value = '';
                    document.getElementById('new-promo-fixed-quantity').value = '';
                    document.getElementById('new-promo-limit').value = '';
                } catch (e) {
                    console.error("Promo Create Error:", e);
                    window.shop.showToast("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è", "–°–±–æ–π");
                }
            },

            deletePromoCode: async (id) => {
                window.shop.showConfirm(
                    "–£–î–ê–õ–ò–¢–¨ –ü–†–û–ú–û–ö–û–î",
                    "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥? –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±—É–¥—É—Ç –æ—Ç–º–µ–Ω–µ–Ω—ã.",
                    async () => {
                        try {
                            const ref = getPromoDocRef(id);
                            await deleteDoc(ref);
                            window.shop.showToast("–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª–µ–Ω", "–£—Å–ø–µ—à–Ω–æ");
                            
                            if (window.shop.state.activePromo && window.shop.state.activePromo.id === id) {
                                window.shop.state.activePromo = null;
                                if (window.shop.state.isCartView) window.shop.updateCartView();
                            }
                        } catch (e) {
                            console.error("Error deleting promo:", e);
                            window.shop.showToast("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "–°–±–æ–π");
                        }
                    }
                );
            },

            // --- ADMIN: RENDER ORDERS ---
            renderAdminOrders: (container) => {
                const isSelectMode = window.shop.state.adminSelectionMode;
                const selectedCount = window.shop.state.selectedAdminOrders.size;

                container.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <button onclick="window.shop.switchView('profile')" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-gray-400 hover:text-white">
                                <i data-lucide="arrow-left" class="w-5 h-5 icon-fix"></i>
                            </button>
                            <h2 class="text-xl font-black italic text-white">–ó–ê–ö–ê–ó–´ <span class="text-red-500">ADMIN</span></h2>
                        </div>
                        <button onclick="window.shop.toggleAdminSelectionMode()" 
                                class="px-3 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all border border-red-500/30 hover:bg-red-500/20 text-red-400 flex items-center gap-2 ${isSelectMode && selectedCount > 0 ? 'bg-red-500/20' : ''}">
                            ${isSelectMode ? 
                                (selectedCount > 0 ? 
                                    '<i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i> –£–î–ê–õ–ò–¢–¨' : 
                                    '<i data-lucide="x" class="w-4 h-4 icon-fix"></i> –û–¢–ú–ï–ù–ê') : 
                                '<i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i> –í–´–ë–†–ê–¢–¨'}
                        </button>
                    </div>
                    <div id="admin-orders-list" class="space-y-3 pb-32">
                        <div class="text-center py-10 text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
                    </div>
                `;
                
                if (window.shop.state.ordersListenerUnsubscribe) {
                    window.shop.state.ordersListenerUnsubscribe();
                    window.shop.state.ordersListenerUnsubscribe = null;
                }

                const ordersCollection = getOrdersRef();
                const q = query(ordersCollection);
                
                window.shop.state.ordersListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                    window.shop.updateAdminOrdersList(snapshot);
                });

                setTimeout(() => {
                    window.shop.renderAdminOrdersFab();
                }, 50);
            },

            // --- RENDER ADMIN ORDERS FAB ---
            renderAdminOrdersFab: function() {
                const isSelectMode = this.state.adminSelectionMode;
                const selectedCount = this.state.selectedAdminOrders.size;
                
                let fabContainer = document.getElementById('admin-orders-fab');
                if (!fabContainer) {
                    fabContainer = document.createElement('div');
                    fabContainer.id = 'admin-orders-fab';
                    fabContainer.className = 'fixed bottom-24 left-4 right-4 z-30';
                    document.getElementById('main-content').appendChild(fabContainer);
                }
                
                if (isSelectMode && selectedCount > 0) {
                    fabContainer.innerHTML = `
                        <button onclick="window.shop.deleteSelectedOrders()" class="w-full bg-red-600 hover:bg-red-500 text-white font-black italic uppercase tracking-wider py-4 rounded-xl shadow-[0_0_20px_rgba(239,68,68,0.3)] flex items-center justify-center gap-2 transition-all active:scale-95 animate-float-up">
                            <i data-lucide="trash-2" class="w-5 h-5 icon-fix"></i>
                            –£–î–ê–õ–ò–¢–¨ (${selectedCount})
                        </button>
                    `;
                    fabContainer.classList.remove('hidden');
                } else {
                    fabContainer.innerHTML = '';
                    fabContainer.classList.add('hidden');
                }
                
                if(window.lucide) window.lucide.createIcons();
            },

            updateAdminOrdersList: function(snapshot = null) {
                const list = document.getElementById('admin-orders-list');
                if (!list) return;
                
                if (snapshot) {
                    if (snapshot.empty) {
                        list.innerHTML = `<div class="text-center py-10 text-gray-500">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>`;
                        this.state.adminOrders = [];
                        this.renderAdminOrdersFab();
                        return;
                    }

                    let docs = [];
                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        docs.push({ 
                            firestoreId: docSnap.id, 
                            ...data,
                            date: data.date ? 
                                (data.date.toDate ? data.date.toDate() : new Date(data.date)) : 
                                new Date()
                        });
                    });
                    
                    docs.sort((a, b) => b.date - a.date);
                    
                    this.state.adminOrders = docs;
                }
                
                const docs = this.state.adminOrders || [];
                
                let html = '';
                docs.forEach(data => {
                    const date = new Date(data.date).toLocaleString('ru-RU', { 
                        day: 'numeric', 
                        month: 'short', 
                        hour: '2-digit', 
                        minute:'2-digit' 
                    });
                    
                    const isSelected = this.state.selectedAdminOrders.has(data.firestoreId);
                    
                    let statusClass = 'status-pending';
                    let statusText = '–û–ñ–ò–î–ê–ï–¢';
                    
                    if (data.status === 'approved') {
                        statusClass = 'status-approved';
                        statusText = '–ü–†–ò–ù–Ø–¢';
                    } else if (data.status === 'rejected') {
                        statusClass = 'status-rejected';
                        statusText = '–û–¢–ö–õ–û–ù–ï–ù';
                    }

                    let paymentBadge = '';
                    let paymentClass = 'payment-status-pending';
                    let paymentText = '–û–ñ–ò–î–ê–ï–¢';
                    
                    if (data.payment_method === 'now' && data.payment_status === 'paid') {
                        paymentClass = 'payment-status-paid';
                        paymentText = '–û–ü–õ–ê–ß–ï–ù–û';
                    } else if (data.payment_method === 'now' && data.payment_status === 'pending') {
                        paymentClass = 'payment-status-pending';
                        paymentText = '–ù–ï –û–ü–õ–ê–ß–ï–ù–û';
                    } else if (data.payment_method === 'on_delivery') {
                        paymentClass = 'payment-status-waiting';
                        paymentText = '–ü–†–ò –ü–û–õ–£–ß–ï–ù–ò–ò';
                    }
                    
                    paymentBadge = `<div class="${paymentClass} status-badge mt-1 text-[8px]">${paymentText}</div>`;

                    const cardStyle = isSelected 
                        ? 'border-red-500 bg-red-500/10' 
                        : `hover:bg-white/5 border-l-4 ${data.status === 'approved' ? 'border-l-green-500' : (data.status === 'rejected' ? 'border-l-red-500' : 'border-l-yellow-500')}`;

                    const clickAction = this.state.adminSelectionMode 
                        ? `window.shop.toggleOrderSelection('${data.firestoreId}')`
                        : `window.shop.openOrderDetails('${data.firestoreId}')`;

                    const checkboxHtml = this.state.adminSelectionMode 
                        ? `<div class="mr-3 pt-1">
                             <div class="order-checkbox ${isSelected ? 'checked' : ''}">
                                ${isSelected ? '<i data-lucide="check" class="w-3 h-3 text-white icon-fix"></i>' : ''}
                             </div>
                            </div>` 
                        : '';

                    html += `
                        <div onclick="${clickAction}" class="glass-panel rounded-xl p-4 cursor-pointer transition-all duration-200 ${cardStyle} flex mb-2">
                            ${checkboxHtml}
                            <div class="flex-grow">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex flex-col">
                                        <span class="text-[10px] text-gray-500 font-mono tracking-widest">${data.order_key || 'NO-ID'}</span>
                                        <span class="text-sm font-bold text-white">${data.delivery?.name || '–ö–ª–∏–µ–Ω—Ç'}</span>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <div class="${statusClass} status-badge">
                                            ${statusText}
                                        </div>
                                        ${paymentBadge}
                                    </div>
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="text-xs text-gray-500">${date}</div>
                                    <div class="text-green-400 font-bold font-mono">${data.total} ‚ÇΩ</div>
                                </div>
                                ${data.promo ? `<div class="text-xs text-green-400 mt-1"><i data-lucide="ticket" class="w-3 h-3 inline mr-1 icon-fix"></i>${data.promo}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                list.innerHTML = html;
                if(window.lucide) window.lucide.createIcons();
                
                this.renderAdminOrdersFab();
            },

            // --- ADMIN SELECTION LOGIC ---
            toggleAdminSelectionMode: function() {
                this.state.adminSelectionMode = !this.state.adminSelectionMode;
                if (!this.state.adminSelectionMode) {
                    this.state.selectedAdminOrders.clear();
                }
                this.updateAdminOrdersList();
                this.updateAdminSelectionButton();
                this.renderAdminOrdersFab();
            },

            toggleOrderSelection: function(docId) {
                const set = this.state.selectedAdminOrders;
                if (set.has(docId)) {
                    set.delete(docId);
                } else {
                    set.add(docId);
                }
                this.updateAdminOrdersList();
                this.updateAdminSelectionButton();
                this.renderAdminOrdersFab();
            },

            updateAdminSelectionButton: function() {
                const selectedCount = this.state.selectedAdminOrders.size;
                const button = document.querySelector('button[onclick="window.shop.toggleAdminSelectionMode()"]');
                if (button) {
                    button.innerHTML = this.state.adminSelectionMode ? 
                        (selectedCount > 0 ? 
                            `<i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i> –£–î–ê–õ–ò–¢–¨` : 
                            '<i data-lucide="x" class="w-4 h-4 icon-fix"></i> –û–¢–ú–ï–ù–ê') : 
                        '<i data-lucide="trash-2" class="w-4 h-4 icon-fix"></i> –í–´–ë–†–ê–¢–¨';
                    
                    if (this.state.adminSelectionMode && selectedCount > 0) {
                        button.classList.add('bg-red-500/20');
                    } else {
                        button.classList.remove('bg-red-500/20');
                    }
                }
            },

            deleteSelectedOrders: function() {
                const count = this.state.selectedAdminOrders.size;
                if (count === 0) return;
                
                this.showConfirm(
                    "–£–î–ê–õ–ò–¢–¨ –ó–ê–ö–ê–ó–´",
                    `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã (${count})? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`,
                    async () => {
                        this.showToast(`–£–¥–∞–ª–µ–Ω–∏–µ ${count} –∑–∞–∫–∞–∑–æ–≤...`, "–û–±—Ä–∞–±–æ—Ç–∫–∞");
                        
                        try {
                            const promises = Array.from(this.state.selectedAdminOrders).map(id => {
                                const orderRef = getPublicOrderRef(id);
                                return deleteDoc(orderRef);
                            });
                            
                            await Promise.all(promises);
                            
                            this.state.adminOrders = this.state.adminOrders.filter(order => 
                                !this.state.selectedAdminOrders.has(order.firestoreId)
                            );
                            
                            this.state.selectedAdminOrders.clear();
                            this.state.adminSelectionMode = false;
                            
                            this.updateAdminOrdersList();
                            this.renderAdminOrdersFab();
                            this.showToast("–ó–∞–∫–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã", "–£—Å–ø–µ—à–Ω–æ");
                            
                        } catch (e) {
                            console.error(e);
                            this.showToast("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "–°–±–æ–π");
                        }
                    }
                );
            },

            openOrderDetails: async (docId) => {
                try {
                    const orderRef = getPublicOrderRef(docId);
                    const docSnap = await getDoc(orderRef);
                    if (!docSnap.exists()) return;
                    
                    const data = docSnap.data();
                    const modal = document.getElementById('order-detail-modal');
                    const content = document.getElementById('order-detail-content');
                    
                    const dateObj = data.date && data.date.toDate ? data.date.toDate() : new Date(data.date);
                    const dateStr = dateObj.toLocaleString('ru-RU', { 
                        day: 'numeric', month: 'long', hour: '2-digit', minute:'2-digit' 
                    });

                    let itemsHtml = '';
                    let subtotal = 0;

                    if (data.items) {
                        for (const [key, qty] of Object.entries(data.items)) {
                             const prod = window.shop.state.products.find(p => p.id === key);
                             const name = prod ? prod.name : '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω';
                             const price = prod ? prod.price : 0;
                             const itemSum = price * qty;
                             subtotal += itemSum;

                             itemsHtml += `
                                <div class="flex justify-between text-xs py-2 border-b border-white/5 items-center">
                                    <div class="flex flex-col">
                                        <span class="text-white">${name}</span>
                                        <span class="text-[9px] text-gray-500">${price} ‚ÇΩ x ${qty} —à—Ç.</span>
                                    </div>
                                    <span class="text-gray-300 font-mono">${itemSum} ‚ÇΩ</span>
                                </div>`;
                        }
                    }

                    const realSubtotal = subtotal > 0 ? subtotal : data.total;
                    const discountAmount = realSubtotal - data.total;
                    const hasDiscount = discountAmount > 0;

                    const promoName = (typeof data.promo === 'object' && data.promo !== null) 
                        ? (data.promo.code || "PROMO") 
                        : (data.promo || "–ë–ï–ó –ö–û–î–ê");

                    const isPaid = data.payment_status === 'paid';
                    let paymentStatusHtml = '';

                    if (data.payment_method === 'now') {
                        paymentStatusHtml = isPaid
                            ? `<div class="payment-status-paid status-badge w-full text-center mt-2">–û–ü–õ–ê–ß–ï–ù–û –û–ù–õ–ê–ô–ù</div>`
                            : `<div class="payment-status-pending status-badge w-full text-center mt-2">–ù–ï –û–ü–õ–ê–ß–ï–ù–û</div>`;
                    } else if (data.payment_method === 'on_delivery') {
                        paymentStatusHtml = isPaid
                            ? `<div class="payment-status-paid status-badge w-full text-center mt-2">–û–ü–õ–ê–ß–ï–ù–û (–í–†–£–ß–ï–ù–û)</div>`
                            : `<div class="payment-status-waiting status-badge w-full text-center mt-2">–û–ü–õ–ê–¢–ê –ü–†–ò –ü–û–õ–£–ß–ï–ù–ò–ò</div>`;
                    }

                    let paymentActions = '';
                    if (!isPaid) {
                        paymentActions = `
                            <button onclick="window.shop.confirmPayment('${docId}')" 
                                    class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-[0_0_15px_rgba(59,130,246,0.3)] mt-3 flex items-center justify-center gap-2 transition-transform active:scale-95">
                                <i data-lucide="check-circle" class="w-4 h-4 icon-fix"></i>
                                –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –ü–û–õ–£–ß–ï–ù–ò–ï –î–ï–ù–ï–ì
                            </button>
                        `;
                    }

                    content.innerHTML = `
                        <div class="text-center mb-4 relative">
                            <h3 class="text-lg font-black italic text-white">–ó–ê–ö–ê–ó ${data.order_key || '...'}</h3>
                            <p class="text-xs text-gray-500 capitalize">${dateStr}</p>
                        </div>
                        
                        <div class="bg-black/40 rounded-xl p-3 mb-4 border border-white/10">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2 flex items-center gap-1"><i data-lucide="user" class="w-3 h-3 icon-fix"></i> –ö–ª–∏–µ–Ω—Ç</p>
                            <div class="space-y-1">
                                <p class="text-sm text-white flex justify-between"><span class="text-gray-500">–ò–º—è:</span> ${data.delivery?.name}</p>
                                <p class="text-sm text-white flex justify-between"><span class="text-gray-500">–¢–µ–ª:</span> <a href="tel:${data.delivery?.phone}" class="text-blue-400 hover:underline">${data.delivery?.phone}</a></p>
                                <p class="text-sm text-white flex justify-between"><span class="text-gray-500">–í–æ–∑—Ä–∞—Å—Ç:</span> ${data.delivery?.age || '-'}</p>
                                <p class="text-sm text-white flex justify-between"><span class="text-gray-500">–ù–∏–∫:</span> ${data.delivery?.contact}</p>
                            </div>
                            <div class="mt-2 pt-2 border-t border-white/5 space-y-1">
                                <p class="text-sm text-white"><span class="text-gray-500 block text-[10px] uppercase">–ê–¥—Ä–µ—Å:</span> ${data.delivery?.place}</p>
                                <p class="text-sm text-white"><span class="text-gray-500 block text-[10px] uppercase">–í—Ä–µ–º—è:</span> ${data.delivery?.time}</p>
                            </div>
                        </div>

                        <div class="bg-black/40 rounded-xl p-3 mb-4 border border-white/10">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2 flex items-center gap-1"><i data-lucide="credit-card" class="w-3 h-3 icon-fix"></i> –û–ø–ª–∞—Ç–∞</p>
                            <p class="text-sm text-white mb-2">${data.payment_method === 'now' ? '–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É' : '–ù–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏'}</p>
                            ${paymentStatusHtml}
                        </div>

                        <div class="bg-black/40 rounded-xl p-3 mb-6 border border-white/10">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2 flex items-center gap-1"><i data-lucide="shopping-bag" class="w-3 h-3 icon-fix"></i> –¢–æ–≤–∞—Ä—ã</p>
                            ${itemsHtml}
                            
                            <div class="mt-3 pt-2 space-y-2">
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤:</span>
                                    <span>${realSubtotal} ‚ÇΩ</span>
                                </div>
                                
                                ${hasDiscount ? `
                                <div class="flex justify-between items-center text-xs text-green-400 font-bold bg-green-900/20 p-2 rounded-lg border border-green-500/20">
                                    <span class="flex items-center gap-2">
                                        <i data-lucide="ticket" class="w-3 h-3"></i> 
                                        –°–∫–∏–¥–∫–∞ (<span class="text-white uppercase font-black">${promoName}</span>):
                                    </span>
                                    <span>-${discountAmount} ‚ÇΩ</span>
                                </div>
                                ` : ''}

                                <div class="flex justify-between mt-2 pt-2 border-t border-white/10 items-center">
                                    <span class="text-white font-bold text-sm">–ö –û–ü–õ–ê–¢–ï</span>
                                    <span class="text-green-400 font-black text-xl neon-text-green">${data.total} ‚ÇΩ</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="window.shop.updateOrderStatus('${docId}', 'approved')" 
                                    class="bg-green-600 hover:bg-green-500 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                                –û–î–û–ë–†–ò–¢–¨
                            </button>
                            <button onclick="window.shop.updateOrderStatus('${docId}', 'rejected')" 
                                    class="bg-red-600 hover:bg-red-500 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-[0_0_15px_rgba(239,68,68,0.3)]">
                                –û–¢–ö–õ–û–ù–ò–¢–¨
                            </button>
                        </div>
                        ${paymentActions}
                    `;
                    
                    modal.classList.remove('hidden');
                    if(window.lucide) window.lucide.createIcons();

                } catch (e) {
                    console.error(e);
                    window.shop.showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '–°–±–æ–π');
                }
            },

            confirmPayment: async function(docId) {
                try {
                    window.shop.showToast('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...', '–û–±—Ä–∞–±–æ—Ç–∫–∞');
                    
                    const orderRef = getPublicOrderRef(docId);
                    const docSnap = await getDoc(orderRef);
                    if (!docSnap.exists()) return;
                    
                    const data = docSnap.data();
                    
                    await updateDoc(orderRef, {
                        payment_status: 'paid',
                        updatedAt: new Date().toISOString()
                    });
                    
                    if (data.linkedUserUid && data.linkedUserOrderId) {
                        try {
                            const userOrderRef = getUserOrderRef(data.linkedUserUid, data.linkedUserOrderId);
                            await updateDoc(userOrderRef, {
                                payment_status: 'paid',
                                updatedAt: new Date().toISOString()
                            });
                        } catch (e) {
                            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞:", e);
                        }
                    }
                    
                    window.shop.showToast('–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!', '–£—Å–ø–µ—à–Ω–æ');
                    
                    document.getElementById('order-detail-modal').classList.add('hidden');
                    
                    if (window.shop.state.adminOrders) {
                        const orderIndex = window.shop.state.adminOrders.findIndex(o => o.firestoreId === docId);
                        if (orderIndex !== -1) {
                            window.shop.state.adminOrders[orderIndex].payment_status = 'paid';
                            window.shop.updateAdminOrdersList();
                        }
                    }
                    
                } catch (e) {
                    console.error(e);
                    window.shop.showToast('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã', '–°–±–æ–π');
                }
            },

            updateOrderStatus: async (docId, status) => {
                document.getElementById('order-detail-modal').classList.add('hidden');
                window.shop.showToast('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞...', '–û–±—Ä–∞–±–æ—Ç–∫–∞');

                try {
                    const orderRef = getPublicOrderRef(docId);
                    
                    const docSnap = await getDoc(orderRef);
                    if (!docSnap.exists()) {
                         throw new Error("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω");
                    }
                    const data = docSnap.data();

                    await updateDoc(orderRef, {
                        status: status,
                        updatedAt: new Date().toISOString()
                    });

                    if (data.linkedUserUid && data.linkedUserOrderId) {
                        try {
                            const userOrderRef = getUserOrderRef(data.linkedUserUid, data.linkedUserOrderId);
                            await updateDoc(userOrderRef, {
                                status: status,
                                updatedAt: new Date().toISOString()
                            });
                        } catch (privateErr) {
                            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞:", privateErr);
                        }
                    }

                    window.shop.showToast(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω: ${status === 'approved' ? '–û–¥–æ–±—Ä–µ–Ω' : '–û—Ç–∫–ª–æ–Ω–µ–Ω'}`, '–£—Å–ø–µ—à–Ω–æ');
                } catch (e) {
                      console.error(e);
                      window.shop.showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + e.message, '–°–±–æ–π');
                }
            },

            // --- Actions ---
            filterCategory: (cat) => {
                window.shop.state.currentCategory = cat;
                window.shop.renderStore();
                if(window.lucide) window.lucide.createIcons();
            },

            addToCart: async (productId) => {
                const product = window.shop.state.products.find(p => p.id === productId);
                if (!product) return;
                
                if (!window.shop.state.cart[productId]) {
                    window.shop.state.cart[productId] = 0;
                }
                window.shop.state.cart[productId]++;
                window.shop.updateCartBadge();
                
                await window.shop.saveCartToFirebase();
                
                window.shop.showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É", "–ö–æ—Ä–∑–∏–Ω–∞");
                
                if(window.Telegram.WebApp.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                }
            },

            updateQty: async (productId, change) => {
                if (!window.shop.state.cart[productId]) return;
                
                const product = window.shop.state.products.find(p => p.id === productId);
                if (!product) return;
                
                window.shop.state.cart[productId] += change;
                
                if (window.shop.state.cart[productId] <= 0) {
                    delete window.shop.state.cart[productId];
                    
                    const cartItem = document.querySelector(`#cart-item-${productId}`);
                    if (cartItem) {
                        cartItem.classList.add('cart-item-removing');
                        setTimeout(() => {
                            if (cartItem.parentNode) {
                                cartItem.parentNode.removeChild(cartItem);
                            }
                            window.shop.updateCartTotal();
                        }, 300);
                    }
                } else {
                    const qtyElement = document.querySelector(`#cart-item-${productId} .cart-item-qty`);
                    if (qtyElement) {
                        qtyElement.textContent = window.shop.state.cart[productId];
                    }
                    window.shop.updateCartTotal();
                }
                
                await window.shop.saveCartToFirebase();
                window.shop.updateCartBadge();
                
                if (Object.keys(window.shop.state.cart).length === 0 && window.shop.state.isCartView) {
                    window.shop.renderCart(document.getElementById('main-content'));
                }
                
                if(window.lucide) window.lucide.createIcons();
            },

            updateCartTotal: () => {
                if (!window.shop.state.isCartView) return;
                
                const cartIds = Object.keys(window.shop.state.cart);
                const products = window.shop.state.products.filter(p => cartIds.includes(p.id));
                let total = 0;
                
                products.forEach(p => {
                    total += p.price * window.shop.state.cart[p.id];
                });

                if (window.shop.state.activePromo) {
                    let discountAmount = 0;
                    
                    if (window.shop.state.activePromo.type === 'percent') {
                        discountAmount = Math.floor((total * window.shop.state.activePromo.percent) / 100);
                    } else if (window.shop.state.activePromo.type === 'fixed') {
                        const cartItems = Object.entries(window.shop.state.cart);
                        let itemsProcessed = 0;
                        
                        for (const [productId, quantity] of cartItems) {
                            const product = window.shop.state.products.find(p => p.id === productId);
                            if (product) {
                                for (let i = 0; i < quantity; i++) {
                                    if (itemsProcessed < window.shop.state.activePromo.fixed_quantity) {
                                        discountAmount += (product.price * window.shop.state.activePromo.fixed_discount) / 100;
                                        itemsProcessed++;
                                    } else {
                                        break;
                                    }
                                }
                            }
                            if (itemsProcessed >= window.shop.state.activePromo.fixed_quantity) break;
                        }
                    }
                    
                    total = total - discountAmount;
                }
                
                const totalElement = document.getElementById('cart-total');
                if (totalElement) {
                    totalElement.innerHTML = `${total} <span class="text-sm align-top text-gray-500 font-normal">RUB</span>`;
                }
            },

            updateCartBadge: () => {
                const validProductIds = window.shop.state.products.map(p => p.id);
                
                let count = 0;
                Object.entries(window.shop.state.cart).forEach(([id, qty]) => {
                    if (validProductIds.includes(id)) {
                        count += qty;
                    }
                });

                const badge = document.getElementById('cart-badge');
                if (badge) {
                    badge.innerText = count;
                    badge.style.opacity = count > 0 ? '1' : '0';
                    badge.style.transform = count > 0 ? 'scale(1)' : 'scale(0.5)';
                }
            },

            toggleAddModal: () => {
                const modal = document.getElementById('add-modal');
                modal.classList.toggle('hidden');
                if (!modal.classList.contains('hidden')) {
                    document.getElementById('new-name').value = '';
                    document.getElementById('new-price').value = '';
                    document.getElementById('new-image-input').value = '';
                    window.shop.state.pendingImage = null;
                    document.getElementById('img-preview-container').style.backgroundImage = 'none';
                    document.getElementById('img-placeholder').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('new-name').focus();
                    }, 100);
                }
            },

            editProduct: function(id) {
                const product = this.state.products.find(p => p.id === id);
                if (!product) return;

                this.state.editingProductId = id;

                document.getElementById('edit-name').value = product.name;
                document.getElementById('edit-price').value = product.price;
                document.getElementById('edit-cat').value = product.category;

                const preview = document.getElementById('edit-img-preview-container');
                const placeholder = document.getElementById('edit-img-placeholder');
                
                preview.style.backgroundImage = '';
                placeholder.classList.remove('hidden');
                
                if (product.image && (product.image.startsWith('data:image') || product.image.includes('http'))) {
                     const tempImg = new Image();
                     tempImg.onload = () => {
                         preview.style.backgroundImage = `url(${product.image})`;
                         placeholder.classList.add('hidden');
                     };
                     tempImg.src = product.image;
                }

                this.toggleEditModal();
            },

            toggleEditModal: function() {
                const modal = document.getElementById('edit-modal');
                modal.classList.toggle('hidden');
                if (modal.classList.contains('hidden')) {
                    this.state.editingProductId = null;
                    this.state.pendingEditImage = null;
                } else {
                    setTimeout(() => {
                        document.getElementById('edit-name').focus();
                    }, 100);
                }
            },

            handleImageSelect: async function(input) {
                if (input.files && input.files[0]) {
                    try {
                        window.shop.showToast("–°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...", "–û–±—Ä–∞–±–æ—Ç–∫–∞");
                        
                        const compressedImage = await this.compressImage(input.files[0]);
                        
                        window.shop.state.pendingImage = compressedImage;
                        const preview = document.getElementById('img-preview-container');
                        preview.style.backgroundImage = `url(${compressedImage})`;
                        document.getElementById('img-placeholder').classList.add('hidden');
                        
                        window.shop.showToast("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ", "–£—Å–ø–µ—à–Ω–æ");
                    } catch (e) {
                        console.error("Error compressing image:", e);
                        window.shop.showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", "–û—à–∏–±–∫–∞");
                    }
                }
            },

            handleEditImageSelect: async function(input) {
                if (input.files && input.files[0]) {
                    try {
                        window.shop.showToast("–°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...", "–û–±—Ä–∞–±–æ—Ç–∫–∞");
                        
                        const compressedImage = await this.compressImage(input.files[0]);
                        
                        this.state.pendingEditImage = compressedImage;
                        const preview = document.getElementById('edit-img-preview-container');
                        preview.style.backgroundImage = `url(${compressedImage})`;
                        document.getElementById('edit-img-placeholder').classList.add('hidden');
                        
                        window.shop.showToast("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ", "–£—Å–ø–µ—à–Ω–æ");
                    } catch (e) {
                        console.error("Error compressing image:", e);
                        window.shop.showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", "–û—à–∏–±–∫–∞");
                    }
                }
            },

            addProduct: async () => {
                const name = document.getElementById('new-name').value;
                const price = Number(document.getElementById('new-price').value);
                const cat = document.getElementById('new-cat').value;
                const image = window.shop.state.pendingImage || 'box';

                if (!name || !price) {
                    window.shop.showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è", "–û—à–∏–±–∫–∞");
                    return;
                }

                const newProduct = { 
                    name, 
                    price, 
                    category: cat, 
                    image, 
                    createdAt: serverTimestamp()
                };

                window.shop.toggleAddModal();
                window.shop.showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...", "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è");

                try {
                    const productsCollection = getProductsRef();
                    await addDoc(productsCollection, newProduct);
                    window.shop.showToast("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω", "–£—Å–ø–µ—à–Ω–æ");
                } catch (e) {
                    console.error("Save failed", e);
                    window.shop.showToast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "–°–±–æ–π");
                }
            },

            updateProduct: async function() {
                const id = this.state.editingProductId;
                if (!id) return;

                const name = document.getElementById('edit-name').value;
                const price = Number(document.getElementById('edit-price').value);
                const cat = document.getElementById('edit-cat').value;
                const image = this.state.pendingEditImage || this.state.products.find(p => p.id === id).image;

                if (!name || !price) {
                    this.showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è", "–û—à–∏–±–∫–∞");
                    return;
                }

                const updatedProduct = {
                    name,
                    price,
                    category: cat,
                    image,
                };

                this.toggleEditModal();
                this.showToast("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...", "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è");

                try {
                    const productRef = getProductDocRef(id);
                    await updateDoc(productRef, updatedProduct);
                    this.state.pendingEditImage = null;
                    this.showToast("–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω", "–£—Å–ø–µ—à–Ω–æ");
                } catch (e) {
                    console.error("Update failed", e);
                    this.showToast("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", "–°–±–æ–π");
                }
            },

            deleteProduct: function(id) {
                console.log("Deleting product with ID:", id);
                window.shop.showConfirm(
                    "–£–î–ê–õ–ò–¢–¨ –¢–û–í–ê–†",
                    "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.",
                    async () => {
                        window.shop.showToast("–£–¥–∞–ª–µ–Ω–∏–µ...", "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è");
                        try {
                            const productRef = getProductDocRef(id);
                            await deleteDoc(productRef);
                            window.shop.showToast("–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω", "–£—Å–ø–µ—à–Ω–æ");
                        } catch (e) { 
                            console.error("Delete failed", e); 
                            window.shop.showToast("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "–°–±–æ–π");
                        }
                    }
                );
            },

            toggleHiddenProduct: async function(id) {
                const product = this.state.products.find(p => p.id === id);
                if (!product) return;

                const newStatus = !product.isHidden;
                const actionText = newStatus ? "—Å–∫—Ä—ã—Ç" : "–¥–æ—Å—Ç—É–ø–µ–Ω";

                this.showToast("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞...", "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è");

                try {
                    const productRef = getProductDocRef(id);
                    await updateDoc(productRef, {
                        isHidden: newStatus
                    });
                    this.showToast(`–¢–æ–≤–∞—Ä ${actionText} –¥–ª—è –≤—Å–µ—Ö`, "–£—Å–ø–µ—à–Ω–æ");
                } catch (e) {
                    console.error("Toggle hidden failed", e);
                    this.showToast("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", "–°–±–æ–π");
                }
            },

            // --- CHECKOUT LOGIC ---

            initCheckout: (total) => {
                window.shop.resetCheckoutState();
                
                window.shop.state.currentTotal = total;
                const modal = document.getElementById('delivery-modal');
                modal.classList.remove('hidden');
                
                setTimeout(() => {
                    const nameInput = document.getElementById('del-name');
                    if (nameInput) {
                        nameInput.focus();
                        setTimeout(() => {
                            nameInput.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center',
                                inline: 'nearest'
                            });
                        }, 100);
                    }
                }, 150);
            },

            selectTime: (time, btn) => {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                window.shop.state.deliveryTime = time;
            },

            selectPaymentMethod: function(method) {
                this.state.paymentMethod = method;
                
                document.querySelectorAll('.payment-method-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const buttons = document.querySelectorAll('.payment-method-btn');
                buttons.forEach(btn => {
                    if (btn.textContent.includes(method === 'now' ? '–û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å' : '–û–ø–ª–∞—Ç–∏—Ç—å –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏')) {
                        btn.classList.add('active');
                    }
                });
                
                const paymentBtn = document.getElementById('payment-action-btn');
                const bankSection = document.getElementById('bank-details-section');
                
                if (method === 'now') {
                    paymentBtn.innerHTML = '<span>–Ø –û–ü–õ–ê–¢–ò–õ</span><i data-lucide="check-circle" class="w-5 h-5 icon-fix"></i>';
                    paymentBtn.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500');
                    paymentBtn.classList.add('bg-gradient-to-r', 'from-green-600', 'to-green-500');
                    bankSection.classList.remove('hidden');
                } else {
                    paymentBtn.innerHTML = '<span>–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –ó–ê–ö–ê–ó</span><i data-lucide="package" class="w-5 h-5 icon-fix"></i>';
                    paymentBtn.classList.remove('bg-gradient-to-r', 'from-green-600', 'to-green-500');
                    paymentBtn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-500');
                    bankSection.classList.add('hidden');
                }
                
                if(window.lucide) window.lucide.createIcons();
            },

            resetCheckoutState: function() {
                this.state.paymentMethod = null;
                this.state.isProcessingOrder = false;
                this.state.currentOrderId = null;
                this.state.deliveryTime = null;
                this.state.deliveryInfo = null;
                
                document.querySelectorAll('.payment-method-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const paymentBtn = document.getElementById('payment-action-btn');
                if (paymentBtn) {
                    paymentBtn.innerHTML = '<span>–í–´–ë–ï–†–ò–¢–ï –°–ü–û–°–û–ë –û–ü–õ–ê–¢–´</span>';
                    paymentBtn.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500');
                    paymentBtn.classList.add('bg-gradient-to-r', 'from-green-600', 'to-green-500');
                    paymentBtn.disabled = false;
                }
            },

            proceedToPayment: () => {
                const name = document.getElementById('del-name').value;
                const phone = document.getElementById('del-phone').value;
                const contact = document.getElementById('del-contact').value;
                const place = document.getElementById('del-place').value;
                const age = document.getElementById('del-age').value;
                const time = window.shop.state.deliveryTime;

                if (!name || !phone || !contact || !place || !time || !age) {
                    window.shop.showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", "–û—à–∏–±–∫–∞");
                    return;
                }

                if (phone.length < 12) {
                    window.shop.showToast("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", "–û—à–∏–±–∫–∞");
                    return;
                }

                if (parseInt(age) < 18) {
                    window.shop.showToast("–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 18+", "–û—à–∏–±–∫–∞");
                    document.getElementById('del-age').focus();
                    return;
                }

                window.shop.state.deliveryInfo = { name, phone, contact, place, time, age };

                document.getElementById('delivery-modal').classList.add('hidden');
                
                document.getElementById('checkout-total').innerText = window.shop.state.currentTotal + " ‚ÇΩ";
                
                if (window.shop.state.activePromo) {
                    let discountAmount = 0;
                    
                    if (window.shop.state.activePromo.type === 'percent') {
                        discountAmount = Math.floor((window.shop.state.currentTotal * window.shop.state.activePromo.percent) / 100);
                    } else if (window.shop.state.activePromo.type === 'fixed') {
                        const cartItems = Object.entries(window.shop.state.cart);
                        let itemsProcessed = 0;
                        
                        for (const [productId, quantity] of cartItems) {
                            const product = window.shop.state.products.find(p => p.id === productId);
                            if (product) {
                                for (let i = 0; i < quantity; i++) {
                                    if (itemsProcessed < window.shop.state.activePromo.fixed_quantity) {
                                        discountAmount += (product.price * window.shop.state.activePromo.fixed_discount) / 100;
                                        itemsProcessed++;
                                    } else {
                                        break;
                                    }
                                }
                            }
                            if (itemsProcessed >= window.shop.state.activePromo.fixed_quantity) break;
                        }
                    }
                    
                    document.getElementById('checkout-discount-row').classList.remove('hidden');
                    document.getElementById('checkout-discount-val').innerText = `-${discountAmount} ‚ÇΩ`;
                } else {
                    document.getElementById('checkout-discount-row').classList.add('hidden');
                }

                const orderId = "VX-" + Math.floor(100000 + Math.random() * 900000);
                document.getElementById('order-id-display').innerText = "–ö–æ–¥ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: " + orderId;
                window.shop.state.currentOrderId = orderId;
                
                window.shop.state.isProcessingOrder = false;
                
                document.getElementById('checkout-modal').classList.remove('hidden');
                
                if(window.lucide) window.lucide.createIcons();
            },

            closeCheckoutModal: function() {
                document.getElementById('checkout-modal').classList.add('hidden');
                this.resetCheckoutState();
            },

            copyBank: () => {
                navigator.clipboard.writeText("2204 3209 2444 1944").then(() => {
                    window.shop.showToast("–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω", "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
                });
            },

            handlePaymentAction: function() {
                if (!this.state.paymentMethod) {
                    this.showToast("–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã", "–û—à–∏–±–∫–∞");
                    return;
                }

                if (this.state.isProcessingOrder) {
                    this.showToast("–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞...", "–í–Ω–∏–º–∞–Ω–∏–µ");
                    return;
                }

                if (this.state.paymentMethod === 'now') {
                    this.completeOrder();
                } else if (this.state.paymentMethod === 'on_delivery') {
                    this.createOrderOnDelivery();
                }
            },

            createOrderOnDelivery: async function() {
                if (window.shop.state.isProcessingOrder) return;
                window.shop.state.isProcessingOrder = true;
                
                const now = new Date();
                const uid = this.state.firebaseUid;
                
                const promoToSave = this.state.activePromo ? this.state.activePromo.code : null;
                const promoIdToUpdate = this.state.activePromo ? this.state.activePromo.id : null;

                const orderBase = {
                    order_key: this.state.currentOrderId,
                    total: this.state.currentTotal,
                    items: this.state.cart,
                    date: now,
                    user: this.state.user,
                    delivery: this.state.deliveryInfo,
                    status: 'pending',
                    createdAt: now,
                    promo: promoToSave,
                    payment_method: 'on_delivery',
                    payment_status: 'waiting'
                };

                try {
                    const publicOrdersCollection = getOrdersRef();
                    await addDoc(publicOrdersCollection, {
                        ...orderBase,
                        linkedUserUid: uid
                    });

                    if (promoIdToUpdate) {
                        const promoRef = getPromoDocRef(promoIdToUpdate);
                        const pSnap = await getDoc(promoRef);
                        if (pSnap.exists()) {
                            await updateDoc(promoRef, { 
                                activations: (pSnap.data().activations || 0) + 1 
                            });
                        }
                    }

                    this.state.cart = {};
                    this.state.activePromo = null;
                    this.updateCartBadge();
                    
                    this.closeCheckoutModal();
                    this.switchView('store');
                    this.showToast("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!", "–£—Å–ø–µ—à–Ω–æ");
                        
                } catch(e) { 
                    console.error(e); 
                    this.state.isProcessingOrder = false;
                    this.showToast("–û—à–∏–±–∫–∞ –±–∞–∑—ã", "–í–Ω–∏–º–∞–Ω–∏–µ");
                }
            },

            completeOrder: async function() {
                if (window.shop.state.isProcessingOrder) return;
                window.shop.state.isProcessingOrder = true;
                
                const now = new Date();
                const uid = this.state.firebaseUid;
                
                const promoToSave = this.state.activePromo ? this.state.activePromo.code : null;
                const promoIdToUpdate = this.state.activePromo ? this.state.activePromo.id : null;

                const orderBase = {
                    order_key: this.state.currentOrderId,
                    total: this.state.currentTotal,
                    items: this.state.cart,
                    date: now,
                    user: this.state.user,
                    delivery: this.state.deliveryInfo,
                    status: 'pending',
                    createdAt: now,
                    promo: promoToSave,
                    payment_method: 'now',
                    payment_status: 'pending'
                };

                try {
                    const publicOrdersCollection = getOrdersRef();
                    await addDoc(publicOrdersCollection, { ...orderBase, linkedUserUid: uid });

                    if (promoIdToUpdate) {
                        const promoRef = getPromoDocRef(promoIdToUpdate);
                        const pSnap = await getDoc(promoRef);
                        if (pSnap.exists()) {
                            await updateDoc(promoRef, { 
                                activations: (pSnap.data().activations || 0) + 1 
                            });
                        }
                    }

                    this.state.cart = {};
                    this.state.activePromo = null;
                    this.updateCartBadge();
                    
                    this.closeCheckoutModal();
                    this.switchView('store');
                    this.showToast("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!", "–£—Å–ø–µ—à–Ω–æ");
                        
                } catch(e) { 
                    console.error(e); 
                    this.state.isProcessingOrder = false;
                }
            },

            testCart: async () => {
                await window.shop.saveCartToFirebase();
                await window.shop.loadCartFromFirebase();
            },

            showToast: (msg, title = "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ") => {
                const toast = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                document.getElementById('toast-title').innerText = title;
                
                toast.classList.remove('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-[-20px]');
                }, 3000);
            }
        };

        window.addEventListener('load', window.shop.init);

    </script>
</body>
</html>
