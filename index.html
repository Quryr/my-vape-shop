<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Premium Vape Store</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        :root {
            --primary: #00FF41;
            --primary-glow: rgba(0, 255, 65, 0.4);
            --bg-dark: #000000;
            --card-bg: rgba(15, 15, 15, 0.6);
            --border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--bg-dark);
            color: #ffffff;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∏–∫—Å –∑–∞–≥—Ä—É–∑–∫–∏ */
        #initial-loader {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loader-smoke {
            width: 50px;
            height: 50px;
            border: 2px solid transparent;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        #bg-canvas {
            position: fixed;
            inset: 0;
            z-index: -1;
        }

        /* –î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ Premium 4.0 */
        .vape-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 32px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.2, 0, 0.2, 1);
        }

        .vape-card:active {
            transform: scale(0.97);
        }

        .primary-glow-text {
            text-shadow: 0 0 20px var(--primary-glow);
        }

        .primary-bg { background: var(--primary); }
        .primary-text { color: var(--primary); }
        
        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-btn {
            position: relative;
            transition: all 0.3s ease;
        }
        .cat-btn.active {
            color: var(--primary);
        }
        .cat-btn.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary);
        }

        .bottom-sheet {
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }
        
        /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ */
        .card-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
    </style>
</head>
<body>

    <div id="initial-loader">
        <div class="loader-smoke"></div>
        <div class="mt-6 text-[10px] tracking-[0.4em] uppercase font-medium opacity-40 animate-pulse">Premium Vapor Quality</div>
    </div>

    <canvas id="bg-canvas"></canvas>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vape-premium-store';

        const ADMIN_ID = 1262669099;

        const THEMES = [
            { name: 'Toxic Green', color: '#00FF41', glow: 'rgba(0, 255, 65, 0.4)' },
            { name: 'Sky Blue', color: '#00D1FF', glow: 'rgba(0, 209, 255, 0.4)' },
            { name: 'Lava Orange', color: '#FF5C00', glow: 'rgba(255, 92, 0, 0.4)' }
        ];

        const SEED_DATA = [
            { name: "HQD Cuvie Plus", price: 950, emoji: "üíé", category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", desc: "1200 –∑–∞—Ç—è–∂–µ–∫ | –ù–∞—Å—ã—â–µ–Ω–Ω—ã–π –≤–∫—É—Å" },
            { name: "Elf Bar BC5000", price: 1450, emoji: "üîã", category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", desc: "5000 –∑–∞—Ç—è–∂–µ–∫ | Type-C" },
            { name: "Lost Mary MO5000", price: 1350, emoji: "‚òÅÔ∏è", category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", desc: "Mesh Coil | 13.5ml" },
            { name: "Vaporesso XROS 3", price: 3400, emoji: "üõ†Ô∏è", category: "Pod-—Å–∏—Å—Ç–µ–º—ã", desc: "–õ—É—á—à–∞—è –≤–∫—É—Å–æ–ø–µ—Ä–µ–¥–∞—á–∞ 2024" },
            { name: "GeekVape Aegis Q", price: 2800, emoji: "üõ°Ô∏è", category: "Pod-—Å–∏—Å—Ç–µ–º—ã", desc: "–ó–∞—â–∏—Ç–∞ –æ—Ç –≤–ª–∞–≥–∏ –∏ —É–¥–∞—Ä–æ–≤" },
            { name: "Maxwells Shoria", price: 800, emoji: "üß™", category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", desc: "–•–≤–æ—è, –º—è—Ç–∞, –ª–µ—Å–Ω—ã–µ —è–≥–æ–¥—ã" },
            { name: "Husky White", price: 650, emoji: "üê∫", category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", desc: "–î–≤–æ–π–Ω–æ–π –ª–µ–¥ | 20mg Strong" },
            { name: "–ö–∞—Ä—Ç—Ä–∏–¥–∂ XROS", price: 400, emoji: "üì¶", category: "–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏", desc: "0.6 / 0.8 Ohm | –û—Ä–∏–≥–∏–Ω–∞–ª" },
            { name: "–ò—Å–ø–∞—Ä–∏—Ç–µ–ª—å PnP", price: 350, emoji: "üîå", category: "–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏", desc: "VM1 0.3ohm | High Power" },
            { name: "Waka PA10000", price: 2200, emoji: "üî•", category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", desc: "10000 —Ç—è–≥ | –†–µ–∂–∏–º Boost" }
        ];

        // --- Realistic Smoke Background Engine ---
        const initSmokeBackground = (color) => {
            const canvas = document.getElementById('bg-canvas');
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10;

            const particlesCount = 40;
            const particles = [];
            const geometry = new THREE.SphereGeometry(3, 32, 32);

            for (let i = 0; i < particlesCount; i++) {
                const material = new THREE.MeshPhongMaterial({
                    color: new THREE.Color(color),
                    transparent: true,
                    opacity: 0.03,
                    shininess: 0
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 10
                );
                mesh.scale.set(Math.random() * 2, Math.random() * 2, 1);
                mesh.userData = { 
                    speedX: (Math.random() - 0.5) * 0.01,
                    speedY: (Math.random() - 0.5) * 0.01 
                };
                scene.add(mesh);
                particles.push(mesh);
            }

            const light = new THREE.PointLight(color, 2, 30);
            light.position.set(0, 0, 5);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x050505));

            const animate = () => {
                requestAnimationFrame(animate);
                particles.forEach(p => {
                    p.position.x += p.userData.speedX;
                    p.position.y += p.userData.speedY;
                    if (Math.abs(p.position.x) > 15) p.userData.speedX *= -1;
                    if (Math.abs(p.position.y) > 15) p.userData.speedY *= -1;
                    p.rotation.z += 0.001;
                });
                renderer.render(scene, camera);
            };
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            return { particles, light };
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [products, setProducts] = useState(SEED_DATA);
            const [cart, setCart] = useState({});
            const [activeCategory, setActiveCategory] = useState("–í—Å–µ");
            const [themeIndex, setThemeIndex] = useState(0);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isCartOpen, setIsCartOpen] = useState(false);
            const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
            const threeRef = useRef(null);
            const tg = window.Telegram?.WebApp;

            useEffect(() => {
                threeRef.current = initSmokeBackground(THEMES[0].color);
                
                // –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –õ–û–ê–î–ï–†–ê
                const forceRemoveLoader = () => {
                    const ldr = document.getElementById('initial-loader');
                    if (ldr) {
                        ldr.style.opacity = '0';
                        setTimeout(() => ldr.remove(), 500);
                    }
                };
                const timer = setTimeout(forceRemoveLoader, 1500);

                if (tg) {
                    tg.expand();
                    tg.ready();
                    if (tg.initDataUnsafe?.user?.id === ADMIN_ID) setIsAdmin(true);
                }

                // Rule 3: Firebase Auth
                const startAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error(e); }
                };
                startAuth();
                onAuthStateChanged(auth, setUser);

                return () => clearTimeout(timer);
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
                return onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    } else if (isAdmin) {
                        SEED_DATA.forEach(item => addDoc(q, item));
                    }
                });
            }, [user, isAdmin]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const categories = ["–í—Å–µ", "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", "–ñ–∏–¥–∫–æ—Å—Ç–∏", "Pod-—Å–∏—Å—Ç–µ–º—ã", "–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏"];
            const filteredProducts = products.filter(p => activeCategory === "–í—Å–µ" || p.category === activeCategory);

            const toggleTheme = () => {
                const next = (themeIndex + 1) % THEMES.length;
                setThemeIndex(next);
                const theme = THEMES[next];
                document.documentElement.style.setProperty('--primary', theme.color);
                document.documentElement.style.setProperty('--primary-glow', theme.glow);
                if (threeRef.current) {
                    threeRef.current.particles.forEach(p => p.material.color.set(theme.color));
                    threeRef.current.light.color.set(theme.color);
                }
                if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            };

            const totalAmount = Object.entries(cart).reduce((sum, [id, qty]) => {
                const p = products.find(x => x.id === id || x.name === id);
                return sum + (p ? p.price * qty : 0);
            }, 0);

            return React.createElement('div', { className: 'p-5 pb-32 max-w-xl mx-auto min-h-screen' },
                // Header
                React.createElement('header', { className: 'flex justify-between items-center mb-10 sticky top-0 z-50 py-4 bg-black/40 backdrop-blur-lg -mx-5 px-5' },
                    React.createElement('div', null,
                        React.createElement('h1', { className: 'text-2xl font-black italic primary-glow-text tracking-tighter' }, 'PREMIUM VAPE'),
                        React.createElement('div', { className: 'flex items-center gap-2 mt-0.5' },
                            React.createElement('div', { className: `w-1 h-1 rounded-full ${isAdmin ? 'primary-bg animate-pulse' : 'bg-white/20'}` }),
                            React.createElement('span', { className: 'text-[9px] uppercase tracking-[0.3em] font-bold opacity-40' }, isAdmin ? 'Admin Active' : 'Exclusive Access')
                        )
                    ),
                    React.createElement('div', { className: 'flex gap-3' },
                        isAdmin && React.createElement('button', { 
                            onClick: () => {
                                const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:");
                                const cat = prompt("–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–û–¥–Ω–æ—Ä–∞–∑–∫–∏/–ñ–∏–¥–∫–æ—Å—Ç–∏/Pod-—Å–∏—Å—Ç–µ–º—ã/–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏):");
                                if(name && cat) addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), {
                                    name, price: 1000, emoji: "üÜï", category: cat, desc: "–î–æ–±–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–æ–º"
                                });
                            },
                            className: 'w-10 h-10 vape-card flex items-center justify-center' 
                        }, React.createElement('i', { 'data-lucide': 'plus-square', className: 'w-5 h-5 primary-text' })),
                        React.createElement('button', { onClick: toggleTheme, className: 'w-10 h-10 vape-card flex items-center justify-center' },
                            React.createElement('i', { 'data-lucide': 'palette', className: 'w-5 h-5' }))
                    )
                ),

                // Categories
                React.createElement('div', { className: 'category-scroll flex gap-8 overflow-x-auto mb-10 pb-4 border-b border-white/5' },
                    categories.map(cat => React.createElement('button', {
                        key: cat,
                        onClick: () => { setActiveCategory(cat); if(tg?.HapticFeedback) tg.HapticFeedback.selectionChanged(); },
                        className: `cat-btn text-[11px] font-black uppercase tracking-widest whitespace-nowrap ${activeCategory === cat ? 'active' : 'opacity-30'}`
                    }, cat))
                ),

                // Grid
                React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
                    filteredProducts.map(p => React.createElement('div', { 
                        key: p.id || p.name,
                        className: 'vape-card p-5'
                    },
                        isAdmin && React.createElement('button', {
                            onClick: () => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', p.id)),
                            className: 'absolute top-3 right-3 p-1.5 bg-red-500/10 text-red-500 rounded-full z-10'
                        }, React.createElement('i', { 'data-lucide': 'x', className: 'w-3 h-3' })),

                        React.createElement('div', { className: 'text-4xl mb-4 text-center' }, p.emoji),
                        
                        React.createElement('div', { className: 'card-content' },
                            React.createElement('div', { className: 'text-[8px] uppercase tracking-widest primary-text font-bold mb-1.5' }, p.category),
                            React.createElement('h3', { className: 'font-bold text-xs leading-tight mb-2' }, p.name),
                            React.createElement('p', { className: 'text-[10px] opacity-40 leading-snug mb-4' }, p.desc)
                        ),

                        React.createElement('div', { className: 'mt-auto' },
                            React.createElement('div', { className: 'text-base font-black mb-3' }, `${p.price} ‚ÇΩ`),
                            React.createElement('button', {
                                onClick: () => {
                                    setCart(prev => ({ ...prev, [p.id || p.name]: (prev[p.id || p.name] || 0) + 1 }));
                                    if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
                                },
                                className: 'w-full py-3 primary-bg text-black text-[10px] font-black uppercase rounded-2xl active:scale-95 transition-all shadow-lg shadow-black/30'
                            }, '–í –∫–æ—Ä–∑–∏–Ω—É')
                        )
                    ))
                ),

                // Cart FAB
                Object.keys(cart).length > 0 && React.createElement('div', { className: 'fixed bottom-8 left-5 right-5 z-[60]' },
                    React.createElement('button', {
                        onClick: () => setIsCartOpen(true),
                        className: 'w-full py-4.5 primary-bg text-black rounded-[24px] flex justify-between px-8 items-center shadow-2xl animate-bounce-short'
                    },
                        React.createElement('div', { className: 'flex gap-3 items-center' },
                            React.createElement('i', { 'data-lucide': 'shopping-cart', className: 'w-5 h-5' }),
                            React.createElement('span', { className: 'font-black uppercase tracking-tighter' }, '–ó–∞–∫–∞–∑')
                        ),
                        React.createElement('div', { className: 'font-black text-xl tracking-tighter' }, `${totalAmount} ‚ÇΩ`)
                    )
                ),

                // Cart Sheet
                React.createElement('div', { 
                    className: `fixed inset-0 bg-black/80 z-[100] transition-opacity duration-300 ${isCartOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}` ,
                    onClick: () => setIsCartOpen(false)
                },
                    React.createElement('div', { 
                        className: `fixed bottom-0 left-0 right-0 vape-card rounded-t-[40px] p-8 max-h-[80vh] overflow-y-auto z-[101] bottom-sheet ${isCartOpen ? 'translate-y-0' : 'translate-y-full'}`,
                        onClick: e => e.stopPropagation()
                    },
                        React.createElement('div', { className: 'w-12 h-1 bg-white/10 rounded-full mx-auto mb-8' }),
                        React.createElement('h2', { className: 'text-2xl font-black italic mb-8' }, '–í–ê–®–ê –ö–û–†–ó–ò–ù–ê'),
                        
                        React.createElement('div', { className: 'space-y-3 mb-10' },
                            Object.entries(cart).map(([id, qty]) => {
                                const p = products.find(x => x.id === id || x.name === id);
                                if (!p) return null;
                                return React.createElement('div', { key: id, className: 'flex items-center justify-between bg-white/[0.03] p-4 rounded-3xl border border-white/5' },
                                    React.createElement('div', null,
                                        React.createElement('div', { className: 'text-sm font-bold' }, p.name),
                                        React.createElement('div', { className: 'text-xs primary-text font-black' }, `${p.price * qty} ‚ÇΩ`)
                                    ),
                                    React.createElement('div', { className: 'flex items-center gap-4' },
                                        React.createElement('button', { onClick: () => setCart(prev => { const n={...prev}; if(n[id]>1) n[id]--; else delete n[id]; return n; }), className: 'w-8 h-8 rounded-xl bg-white/5 flex items-center justify-center font-bold' }, '-'),
                                        React.createElement('span', { className: 'font-black' }, qty),
                                        React.createElement('button', { onClick: () => setCart(prev => ({...prev, [id]: prev[id]+1})), className: 'w-8 h-8 rounded-xl bg-white/5 flex items-center justify-center font-bold' }, '+')
                                    )
                                );
                            })
                        ),

                        React.createElement('button', {
                            onClick: () => { setIsCartOpen(false); setIsCheckoutOpen(true); },
                            className: 'w-full py-5 primary-bg text-black font-black uppercase rounded-[22px]'
                        }, '–ö –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é')
                    )
                ),

                // Checkout Overlay
                isCheckoutOpen && React.createElement('div', { className: 'fixed inset-0 bg-[#000] z-[200] p-8 fade-in overflow-y-auto' },
                    React.createElement('button', { onClick: () => setIsCheckoutOpen(false), className: 'mb-10 opacity-30 text-[10px] font-black uppercase tracking-widest' }, '‚Üê –ú–∞–≥–∞–∑–∏–Ω'),
                    React.createElement('h2', { className: 'text-4xl font-black italic mb-6 primary-glow-text' }, '–û–ü–õ–ê–¢–ê'),
                    React.createElement('div', { className: 'vape-card p-8 rounded-[40px] mb-8' },
                        React.createElement('div', { className: 'text-[10px] opacity-40 uppercase tracking-[0.2em] mb-3' }, '–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞'),
                        React.createElement('div', { className: 'text-5xl font-black primary-text mb-10 tracking-tighter' }, `${totalAmount} ‚ÇΩ`),
                        
                        React.createElement('div', { className: 'space-y-5' },
                            React.createElement('div', { className: 'p-5 bg-white/[0.02] rounded-[28px] border border-white/5' },
                                React.createElement('div', { className: 'text-[9px] opacity-30 uppercase mb-3 font-bold' }, '–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ Ozon –ë–∞–Ω–∫'),
                                React.createElement('div', { className: 'font-mono text-lg mb-1' }, '2204 3209 2444 1944'),
                                React.createElement('div', { className: 'text-[10px] opacity-60' }, '–ò–≤–∞–Ω –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á –†.')
                            ),
                            React.createElement('div', { className: 'p-5 primary-bg/10 rounded-[28px] border border-dashed primary-border' },
                                React.createElement('div', { className: 'text-[9px] primary-text uppercase mb-2 font-black' }, '–ö–æ–¥ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:'),
                                React.createElement('div', { className: 'text-3xl font-black tracking-widest' }, `VX-${Math.floor(1000 + Math.random() * 9000)}`)
                            )
                        )
                    ),
                    React.createElement('button', {
                        onClick: () => {
                            if(tg) tg.sendData(JSON.stringify({order: 'paid', amount: totalAmount}));
                            setCart({}); setIsCheckoutOpen(false);
                        },
                        className: 'w-full py-6 primary-bg text-black font-black uppercase rounded-[30px] shadow-2xl shadow-green-500/20'
                    }, '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –æ–ø–ª–∞—Ç—É')
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
