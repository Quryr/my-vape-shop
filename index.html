<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Vape Store</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –±–µ—Ä–µ—Ç—Å—è –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è Canvas
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±–ª–∞–∫–æ–º
            window.VapeCloud = { 
                db, auth, appId, 
                methods: { collection, doc, onSnapshot, addDoc, deleteDoc, query, getDocs } 
            };

            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã (RULE 3)
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Firebase Auth Success");
                    window.dispatchEvent(new Event('vape-cloud-auth-ok'));
                } catch (e) {
                    console.error("Firebase Auth Error:", e);
                }
            };
            initAuth();
        } catch (e) {
            console.error("Firebase Config Error:", e);
        }
    </script>
    <style>
        :root {
            --brand-color: #00ff88;
            --brand-glow: rgba(0, 255, 136, 0.4);
            --bg-dark: #050505;
            --glass: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --error: #ff4444;
            --success: #00c853;
        }

        .theme-ice { --brand-color: #00d1ff; }
        .theme-magma { --brand-color: #ff6b00; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background-color: var(--bg-dark); color: var(--text-main); overflow-x: hidden; width: 100vw; min-height: 100vh; }

        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #000; }
        .orb { position: absolute; width: 350px; height: 350px; border-radius: 50%; filter: blur(80px); opacity: 0.15; pointer-events: none; }
        .orb-1 { background: var(--brand-color); top: -80px; right: -80px; }
        .orb-2 { background: #4a00ff; bottom: -80px; left: -80px; }

        header {
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; backdrop-filter: blur(15px);
            background: rgba(5, 5, 5, 0.6); border-bottom: 1px solid var(--glass-border);
        }
        .logo { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .header-btns { display: flex; gap: 8px; }
        .icon-btn {
            background: var(--glass); border: 1px solid var(--glass-border); color: var(--text-main);
            padding: 8px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 40px; height: 40px; transition: 0.3s;
        }
        #adminBtn { display: none; } 
        .icon-btn.active { background: var(--brand-color); color: #000; border-color: var(--brand-color); }
        #addBtn { display: none; background: var(--brand-color); color: #000; border: none; }

        .categories-container { padding: 12px 0; overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
        .categories-inner { display: inline-flex; gap: 10px; padding: 10px 20px 25px 20px; }
        .category-btn {
            background: var(--glass); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 10px 18px;
            border-radius: 20px; font-size: 14px; font-weight: 600; outline: none; transition: 0.3s;
        }
        .category-btn.active { color: var(--text-main); background: rgba(255, 255, 255, 0.1); border-color: var(--brand-color); }

        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 0 16px 120px 16px; width: 100%; }
        .product-card {
            background: var(--glass); border: 1px solid var(--glass-border); backdrop-filter: blur(10px);
            border-radius: 22px; padding: 12px; display: flex; flex-direction: column; gap: 10px; position: relative;
            animation: fadeIn 0.4s ease-out;
            min-height: 280px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ */
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .delete-card-btn {
            position: absolute; top: 10px; right: 10px; background: var(--error);
            color: white; border: none; width: 30px; height: 30px; border-radius: 8px;
            display: none; align-items: center; justify-content: center; z-index: 10; cursor: pointer;
        }
        .product-img { width: 100%; aspect-ratio: 1/1; border-radius: 16px; background: rgba(255,255,255,0.02); object-fit: cover; }
        
        /* –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–ê–í–ö–ê –í–´–†–ê–í–ù–ò–í–ê–ù–ò–Ø */
        .product-info { 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
            padding: 4px 4px 8px 4px; 
            flex-grow: 1; /* –≠—Ç–æ—Ç –±–ª–æ–∫ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏ —Ç–æ–ª–∫–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑ */
        }
        
        .product-name { font-size: 13px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; min-height: 32px; }
        .product-price { font-size: 15px; font-weight: 800; color: var(--brand-color); margin-top: auto; }
        .add-btn { background: var(--text-main); color: var(--bg-dark); border: none; padding: 12px; border-radius: 14px; font-weight: 800; font-size: 12px; width: 100%; cursor: pointer; margin-top: auto; }

        .cart-fab {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(120px);
            width: calc(100% - 32px); max-width: 450px; background: var(--brand-color);
            color: var(--bg-dark); height: 64px; border-radius: 22px; display: flex;
            align-items: center; justify-content: space-between; padding: 0 24px; font-weight: 800;
            box-shadow: 0 10px 40px var(--brand-glow); z-index: 200; transition: 0.5s;
        }
        .cart-fab.visible { transform: translateX(-50%) translateY(0); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 300; opacity: 0; visibility: hidden; transition: 0.3s; }
        .overlay.active { opacity: 1; visibility: visible; }
        
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #0a0a0a;
            border-top: 1px solid var(--glass-border); border-radius: 28px 28px 0 0;
            z-index: 301; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            max-height: 85vh; padding: 24px; display: flex; flex-direction: column;
        }
        .bottom-sheet.active { transform: translateY(0); }
        
        .form-input { width: 100%; background: var(--glass); border: 1px solid var(--glass-border); color: white; padding: 14px; border-radius: 14px; margin-bottom: 12px; outline: none; }
        .checkout-btn { background: var(--brand-color); color: var(--bg-dark); border: none; width: 100%; padding: 18px; border-radius: 18px; font-weight: 800; cursor: pointer; }
        .checkout-btn:active { transform: scale(0.98); }

        .payment-info { background: rgba(255,255,255,0.03); border: 1px dashed var(--brand-color); border-radius: 16px; padding: 20px; text-align: center; margin: 10px 0; }
        .price-tag { font-size: 28px; font-weight: 900; color: var(--brand-color); margin: 10px 0; }
        
        .cart-item { display: flex; align-items: center; gap: 12px; background: var(--glass); padding: 10px; border-radius: 18px; margin-bottom: 8px; }
        .cart-item img { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; }
        .cart-qty { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 12px; }

        body.admin-mode .delete-card-btn { display: flex !important; }
        body.admin-mode .cart-fab { display: none !important; }

        #setup-banner { background: var(--brand-color); color: #000; padding: 12px; border-radius: 12px; font-weight: 800; margin: 10px 16px; text-align: center; cursor: pointer; display: none; }
        
        #boot-loader { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 15px; transition: 0.5s; }
        #boot-loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--glass); border-top-color: var(--brand-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="theme-toxic">

    <div id="boot-loader">
        <div class="spinner"></div>
        <div style="color: var(--brand-color); font-weight: 800; letter-spacing: 2px; font-size: 12px;">–ó–ê–ì–†–£–ó–ö–ê</div>
    </div>

    <div class="background-container">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <header>
        <div class="logo"><i data-lucide="zap" fill="var(--brand-color)" color="var(--brand-color)" size="22"></i> VAPE CLOUD</div>
        <div class="header-btns">
            <button class="icon-btn" id="addBtn" onclick="openSheet('adminSheet')"><i data-lucide="plus"></i></button>
            <button class="icon-btn" id="adminBtn" onclick="toggleAdminMode()"><i data-lucide="shield"></i></button>
            <button class="icon-btn" onclick="toggleTheme()"><i data-lucide="palette"></i></button>
        </div>
    </header>

    <div id="setup-banner" onclick="manualSeed()">üöÄ –ú–ê–ì–ê–ó–ò–ù –ü–£–°–¢. –ó–ê–ì–†–£–ó–ò–¢–¨ –¢–û–í–ê–†–´?</div>

    <div class="categories-container"><div class="categories-inner" id="categories"></div></div>
    <div class="products-grid" id="products"></div>

    <div class="cart-fab" id="cartFab" onclick="openSheet('cartSheet')">
        <div style="display: flex; align-items: center; gap: 10px;"><i data-lucide="shopping-cart"></i> <span id="cartCount">0 –¢–û–í–ê–†–û–í</span></div>
        <span id="cartTotal">0 ‚ÇΩ</span>
    </div>

    <div class="overlay" id="overlay" onclick="closeAllSheets()"></div>

    <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
    <div class="bottom-sheet" id="cartSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
            <i data-lucide="x" onclick="closeAllSheets()" style="cursor:pointer"></i>
        </div>
        <div id="cartList" style="overflow-y:auto; flex-grow:1; margin-bottom:20px;"></div>
        <button class="checkout-btn" id="checkout-main-btn" onclick="openSheet('orderSheet')">–ö –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é</button>
    </div>

    <!-- –ó–∞–∫–∞–∑ -->
    <div class="bottom-sheet" id="orderSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞</h2>
            <i data-lucide="arrow-left" onclick="openSheet('cartSheet')" style="cursor:pointer"></i>
        </div>
        <div style="overflow-y:auto; flex-grow:1;">
            <input type="text" id="order_name" class="form-input" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="tel" id="order_phone" class="form-input" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
            <input type="text" id="order_contact" class="form-input" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¢–ì @—é–∑)">
            <input type="text" id="order_location" class="form-input" placeholder="–ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏">
            <select id="order_time" class="form-input">
                <option value="6:00 - 12:00">6:00 - 12:00</option>
                <option value="14:00 - 20:00">14:00 - 20:00</option>
            </select>
        </div>
        <button class="checkout-btn" onclick="goToPayment()">–ö –æ–ø–ª–∞—Ç–µ</button>
    </div>

    <!-- –û–ø–ª–∞—Ç–∞ -->
    <div class="bottom-sheet" id="paymentSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>–û–ø–ª–∞—Ç–∞</h2>
            <i data-lucide="x" onclick="closeAllSheets()" style="cursor:pointer"></i>
        </div>
        <div class="payment-info">
            <div class="price-tag" id="finalPrice">0 ‚ÇΩ</div>
            <div style="font-weight: 800; margin-bottom: 12px; color: var(--brand-color); letter-spacing: 1px;">OZON –ë–ê–ù–ö</div>
            <div class="copy-info-row">
                <span style="font-family: monospace;">2204 3209 2444 1944</span>
                <span class="copy-btn" onclick="copyText('2204320924441944')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
            </div>
            <div style="font-size: 12px; margin: 15px 0 10px 0; color: var(--text-muted);">–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ö –ü–õ–ê–¢–ï–ñ–£:</div>
            <div class="copy-info-row" style="background: rgba(0,255,136,0.1); border: 1px solid var(--brand-color);">
                <span id="payment_key" style="font-weight: 800;">---</span>
                <span class="copy-btn" onclick="copyText(document.getElementById('payment_key').innerText)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
            </div>
        </div>
        <button class="checkout-btn" id="finishBtn" style="background: var(--success); color: #fff;" onclick="finishOrder()">–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)</button>
    </div>

    <!-- –ê–¥–º–∏–Ω–∫–∞ -->
    <div class="bottom-sheet" id="adminSheet">
        <h2 style="margin-bottom:20px;">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h2>
        <input type="text" id="p_name" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <input type="number" id="p_price" class="form-input" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)">
        <select id="p_cat" class="form-input">
            <option value="–û–¥–Ω–æ—Ä–∞–∑–∫–∏">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</option>
            <option value="–ñ–∏–¥–∫–æ—Å—Ç–∏">–ñ–∏–¥–∫–æ—Å—Ç–∏</option>
            <option value="Pod-—Å–∏—Å—Ç–µ–º—ã">Pod-—Å–∏—Å—Ç–µ–º—ã</option>
            <option value="–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</option>
        </select>
        <div style="margin-bottom: 20px;">
            <input type="file" id="p_file" accept="image/*" onchange="previewImage(event)">
            <img id="img_preview" style="width: 60px; height: 60px; border-radius: 10px; margin-top: 10px; display: none; object-fit: cover; border: 1px solid var(--brand-color);">
        </div>
        <button class="checkout-btn" id="saveProductBtn" onclick="saveNewProduct()">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const MY_ADMIN_ID = "1262669099"; // –°—Ç—Ä–æ–∫–æ–≤–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–µ–µ
        let products = [];
        let cart = {};
        let activeCategory = '–í—Å–µ';
        let isAdminMode = false;
        let selectedBase64 = '';
        let cloudSynced = false;
        let isUserAdmin = false;

        const seedItems = [
            { category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', name: 'HQD Cuvie Plus (1200)', price: 450, img: 'https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200' },
            { category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', name: 'Elf Bar BC5000', price: 850, img: 'https://images.unsplash.com/photo-1621217743588-3351ecf7b46d?w=200' },
            { category: '–ñ–∏–¥–∫–æ—Å—Ç–∏', name: 'Husky Ice 30ml', price: 450, img: 'https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200' },
            { category: 'Pod-—Å–∏—Å—Ç–µ–º—ã', name: 'Vaporesso XROS 3', price: 2850, img: 'https://images.unsplash.com/photo-1552819056-421622b3818f?w=200' },
            { category: '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', name: '–ö–∞—Ä—Ç—Ä–∏–¥–∂ XROS 0.6', price: 350, img: 'https://images.unsplash.com/photo-1542385151-efd9000785a0?w=200' }
        ];

        // –£–°–ò–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ê–î–ú–ò–ù–ê
        function forceAdminCheck() {
            const webapp = window.Telegram.WebApp;
            let uId = webapp.initDataUnsafe?.user?.id || tg.initDataUnsafe?.user?.id;
            
            // –ï—Å–ª–∏ —á–µ—Ä–µ–∑ SDK –Ω–µ –ø—Ä–∏—à–ª–æ, –∏—â–µ–º –≤ URL –Ω–∞–ø—Ä—è–º—É—é (–±—ã–≤–∞–µ—Ç –ø—Ä–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ø–æ—Å–æ–±–∞—Ö –æ—Ç–∫—Ä—ã—Ç–∏—è)
            if(!uId) {
                try {
                    const hashParams = new URLSearchParams(window.location.hash.slice(1));
                    const dataStr = hashParams.get('tgWebAppData');
                    if(dataStr) {
                        const data = Object.fromEntries(new URLSearchParams(dataStr));
                        if(data.user) uId = JSON.parse(data.user).id;
                    }
                } catch(e) {}
            }

            if(uId && String(uId) === MY_ADMIN_ID) {
                isUserAdmin = true;
                const btn = document.getElementById('adminBtn');
                if(btn) btn.style.display = 'flex';
                console.log("Admin Authorized:", uId);
            }
        }

        function renderAll() {
            const categories = ['–í—Å–µ', ...new Set(products.map(p => p.category))];
            if(categories.length === 1) categories.push('–û–¥–Ω–æ—Ä–∞–∑–∫–∏', '–ñ–∏–¥–∫–æ—Å—Ç–∏', 'Pod-—Å–∏—Å—Ç–µ–º—ã', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏');
            document.getElementById('categories').innerHTML = categories.map(c => `
                <button class="category-btn ${c===activeCategory?'active':''}" onclick="setCat('${c}')">${c}</button>
            `).join('');

            const grid = document.getElementById('products');
            const filtered = activeCategory === '–í—Å–µ' ? products : products.filter(p => p.category === activeCategory);
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:var(--text-muted)">–ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</div>`;
            } else {
                grid.innerHTML = filtered.map(p => `
                    <div class="product-card">
                        <button class="delete-card-btn" onclick="deleteItem('${p.docId || ''}', '${p.name}')"><i data-lucide="trash-2" size="14"></i></button>
                        <img src="${p.img}" class="product-img" onerror="this.src='https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200'">
                        <div class="product-info">
                            <span class="product-name">${p.name}</span>
                            <span class="product-price">${p.price} ‚ÇΩ</span>
                        </div>
                        <button class="add-btn" onclick="addToCart('${p.docId || p.name}')">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    </div>`).join('');
            }
            lucide.createIcons();
            setTimeout(() => document.getElementById('boot-loader').classList.add('hidden'), 500);
        }

        window.addEventListener('vape-cloud-ready', () => {
            if (!window.VapeCloud) return;
            const { db, appId, methods } = window.VapeCloud;
            const coll = methods.collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            
            forceAdminCheck();

            methods.onSnapshot(methods.query(coll), async (snapshot) => {
                let dbItems = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                
                if (dbItems.length === 0 && isUserAdmin) {
                    document.getElementById('setup-banner').style.display = 'block';
                } else {
                    document.getElementById('setup-banner').style.display = 'none';
                }

                cloudSynced = true;
                products = dbItems.length > 0 ? dbItems : [...seedItems];
                renderAll();
            }, (err) => {
                console.warn("Cloud access restricted or error", err);
                products = [...seedItems];
                renderAll();
            });
        });

        // –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞ (–¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
        [100, 500, 1500, 3000].forEach(ms => setTimeout(forceAdminCheck, ms));

        window.setCat = (c) => { activeCategory = c; renderAll(); };
        window.toggleAdminMode = () => { isAdminMode = !isAdminMode; document.body.classList.toggle('admin-mode', isAdminMode); document.getElementById('adminBtn').classList.toggle('active', isAdminMode); document.getElementById('addBtn').style.display = isAdminMode ? 'flex' : 'none'; renderAll(); };
        window.openSheet = (id) => { closeAllSheets(); document.getElementById(id).classList.add('active'); document.getElementById('overlay').classList.add('active'); };
        window.closeAllSheets = () => { document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active')); document.getElementById('overlay').classList.remove('active'); };

        window.previewImage = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => { selectedBase64 = ev.target.result; const p = document.getElementById('img_preview'); p.src = selectedBase64; p.style.display = 'block'; };
            reader.readAsDataURL(file);
        };

        window.manualSeed = async () => {
            if(!confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ –æ–±–ª–∞–∫–æ?") || !window.VapeCloud) return;
            const { db, appId, methods } = window.VapeCloud;
            document.getElementById('setup-banner').innerText = "–ó–ê–ì–†–£–ó–ö–ê...";
            for(let item of seedItems) {
                await methods.addDoc(methods.collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), { ...item, createdAt: Date.now() });
            }
            document.getElementById('setup-banner').style.display = 'none';
        };

        window.saveNewProduct = async () => {
            const name = document.getElementById('p_name').value;
            const price = Number(document.getElementById('p_price').value);
            const category = document.getElementById('p_cat').value;
            if(!name || !price || !window.VapeCloud) return;

            const btn = document.getElementById('saveProductBtn');
            btn.disabled = true; btn.innerText = "...";
            try {
                const { db, appId, methods } = window.VapeCloud;
                await methods.addDoc(methods.collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), {
                    name, price, category, img: selectedBase64 || 'https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200', createdAt: Date.now()
                });
                closeAllSheets();
                document.getElementById('p_name').value = ''; document.getElementById('p_price').value = ''; document.getElementById('img_preview').style.display = 'none';
                selectedBase64 = '';
            } catch(e) {} finally { btn.disabled = false; btn.innerText = "–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"; }
        };

        window.deleteItem = async (docId, name) => {
            if(!confirm(`–£–¥–∞–ª–∏—Ç—å ${name}?`)) return;
            if(!docId) { 
                products = products.filter(p => p.name !== name);
                renderAll();
                return;
            }
            const { db, appId, methods } = window.VapeCloud;
            await methods.deleteDoc(methods.doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', docId));
            tg.HapticFeedback.impactOccurred('medium');
        };

        window.addToCart = (id) => {
            const p = products.find(x => x.docId === id || x.name === id);
            if(!p) return;
            const cId = p.docId || p.name;
            if(cart[cId]) cart[cId].qty++; else cart[cId] = {...p, qty: 1};
            updateCartUI();
            tg.HapticFeedback.notificationOccurred('success');
        };

        function updateCartUI() {
            const items = Object.values(cart);
            const count = items.reduce((a, b) => a + b.qty, 0);
            const total = items.reduce((a, b) => a + (b.price * b.qty), 0);
            document.getElementById('cartFab').classList.toggle('visible', count > 0 && !isAdminMode);
            document.getElementById('cartCount').innerText = `${count} –¢–û–í–ê–†–û–í`;
            document.getElementById('cartTotal').innerText = `${total} ‚ÇΩ`;
            const list = document.getElementById('cartList');
            if(items.length === 0) list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted)">–ü—É—Å—Ç–æ</div>`;
            else list.innerHTML = items.map(i => `
                <div class="cart-item">
                    <img src="${i.img}">
                    <div style="flex-grow:1;">
                        <div style="font-size:13px; font-weight:600;">${i.name}</div>
                        <div style="color:var(--brand-color); font-weight:800;">${i.price * i.qty} ‚ÇΩ</div>
                    </div>
                    <div class="cart-qty">
                        <button style="background:none; border:none; color:#fff;" onclick="changeQty('${i.docId || i.name}', -1)">-</button>
                        <span>${i.qty}</span>
                        <button style="background:none; border:none; color:#fff;" onclick="changeQty('${i.docId || i.name}', 1)">+</button>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        }

        window.changeQty = (id, delta) => {
            if(cart[id]) { cart[id].qty += delta; if(cart[id].qty <= 0) delete cart[id]; updateCartUI(); }
        };

        window.goToPayment = () => {
            if(!document.getElementById('order_name').value || !document.getElementById('order_phone').value) return;
            const total = Object.values(cart).reduce((a, b) => a + (b.price * b.qty), 0);
            document.getElementById('finalPrice').innerText = `${total} ‚ÇΩ`;
            const k = 'VX-' + Math.floor(100 + Math.random() * 900);
            document.getElementById('payment_key').innerText = k;
            openSheet('paymentSheet');
        };

        window.copyText = (t) => { const e = document.createElement('textarea'); e.value = t; document.body.appendChild(e); e.select(); document.execCommand('copy'); document.body.removeChild(e); tg.HapticFeedback.impactOccurred('medium'); };

        window.finishOrder = () => {
            const total = Object.values(cart).reduce((a, b) => a + (b.price * b.qty), 0);
            const itemsText = Object.values(cart).map(i => `${i.name} (x${i.qty})`).join(', ');
            tg.sendData(JSON.stringify({
                order_key: document.getElementById('payment_key').innerText, items: itemsText, total: total + " ‚ÇΩ",
                client: { name: document.getElementById('order_name').value, phone: document.getElementById('order_phone').value, username_or_contact: document.getElementById('order_contact').value, place: document.getElementById('order_location').value, time: document.getElementById('order_time').value }
            }));
            tg.close();
        };

        window.toggleTheme = () => { document.body.className = document.body.className.includes('toxic') ? 'theme-ice' : document.body.className.includes('ice') ? 'theme-magma' : 'theme-toxic'; };
    </script>
</body>
</html>
