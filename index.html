<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Vape Store</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Инициализация конфигурации
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Глобальный объект для доступа
        window.VapeCloud = { 
            db, auth, appId, 
            methods: { collection, doc, onSnapshot, addDoc, deleteDoc, query, getDocs } 
        };

        // RULE 3: Auth Before Queries
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Cloud Authorized");
                window.dispatchEvent(new Event('vape-cloud-ready'));
            } catch (e) {
                console.error("Auth failed:", e);
            }
        };
        initAuth();
    </script>
    <style>
        /* Ваши стили остаются без изменений */
    </style>
</head>
<body class="theme-toxic">

    <div id="loading-overlay">
        <div style="color: var(--brand-color); font-weight: 700; letter-spacing: 2px;">VAPE CLOUD</div>
    </div>

    <div class="background-container">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <header>
        <div class="logo"><i data-lucide="zap" fill="var(--brand-color)" color="var(--brand-color)" size="22"></i> VAPE CLOUD</div>
        <div class="header-btns">
            <button class="icon-btn" id="addBtn" onclick="openSheet('adminSheet')"><i data-lucide="plus"></i></button>
            <button class="icon-btn" id="adminBtn" onclick="toggleAdminMode()"><i data-lucide="shield"></i></button>
            <button class="icon-btn" onclick="toggleTheme()"><i data-lucide="palette"></i></button>
        </div>
    </header>

    <div class="categories-container"><div class="categories-inner" id="categories"></div></div>
    <div class="products-grid" id="products"></div>

    <div class="cart-fab" id="cartFab" onclick="openSheet('cartSheet')">
        <div style="display: flex; align-items: center; gap: 10px;"><i data-lucide="shopping-cart"></i> <span id="cartCount">0 ТОВАРОВ</span></div>
        <span id="cartTotal">0 ₽</span>
    </div>

    <div class="overlay" id="overlay" onclick="closeAllSheets()"></div>

    <!-- Корзина -->
    <div class="bottom-sheet" id="cartSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Корзина</h2>
            <i data-lucide="x" onclick="closeAllSheets()" style="cursor:pointer"></i>
        </div>
        <div id="cartList" style="overflow-y:auto; flex-grow:1; margin-bottom:20px;"></div>
        <button class="checkout-btn" onclick="openSheet('orderSheet')">Перейти к оформлению</button>
    </div>

    <!-- Форма данных -->
    <div class="bottom-sheet" id="orderSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Данные заказа</h2>
            <i data-lucide="arrow-left" onclick="openSheet('cartSheet')" style="cursor:pointer"></i>
        </div>
        <div style="overflow-y:auto; flex-grow:1;">
            <input type="text" id="order_name" class="form-input" placeholder="Ваше Имя">
            <input type="tel" id="order_phone" class="form-input" placeholder="Номер телефона">
            <input type="text" id="order_contact" class="form-input" placeholder="Контактные данные (ТГ @юз)">
            <input type="text" id="order_location" class="form-input" placeholder="Место встречи">
            <select id="order_time" class="form-input">
                <option value="6:00 - 12:00">6:00 - 12:00</option>
                <option value="14:00 - 20:00">14:00 - 20:00</option>
            </select>
        </div>
        <button class="checkout-btn" onclick="goToPayment()">К оплате</button>
    </div>

    <!-- Оплата -->
    <div class="bottom-sheet" id="paymentSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Оплата</h2>
            <i data-lucide="x" onclick="closeAllSheets()" style="cursor:pointer"></i>
        </div>
        <div class="payment-info">
            <div class="price-tag" id="finalPrice">0 ₽</div>
            <div style="font-weight: 700; margin-bottom: 12px; color: var(--brand-color)">Ozon Банк</div>
            <div class="copy-info-row">
                <span style="font-family: monospace;">2204 3209 2444 1944</span>
                <span class="copy-btn" onclick="copyText('2204320924441944')">КОПИРОВАТЬ</span>
            </div>
            <div style="font-size: 12px; margin: 15px 0 5px 0; color: var(--text-muted);">КОММЕНТАРИЙ К ПЛАТЕЖУ:</div>
            <div class="copy-info-row" style="background: rgba(0,255,136,0.1); border: 1px solid var(--brand-color);">
                <span id="payment_key" class="payment-key">---</span>
                <span class="copy-btn" onclick="copyText(document.getElementById('payment_key').innerText)">КОПИРОВАТЬ</span>
            </div>
            <div style="font-size: 12px; margin-top: 15px;">Получатель: <b>Иван Владимирович Р.</b></div>
        </div>
        <button class="checkout-btn" id="finishBtn" style="background: var(--success); color: #fff;" onclick="finishOrder()">Я оплатил(а)</button>
    </div>

    <!-- Админка -->
    <div class="bottom-sheet" id="adminSheet">
        <h2 style="margin-bottom:20px;">Новый товар</h2>
        <input type="text" id="p_name" class="form-input" placeholder="Название">
        <input type="number" id="p_price" class="form-input" placeholder="Цена (₽)">
        <select id="p_cat" class="form-input">
            <option value="Одноразки">Одноразки</option>
            <option value="Жидкости">Жидкости</option>
            <option value="Аксессуары">Аксессуары</option>
        </select>
        <input type="url" id="p_url" class="form-input" placeholder="Фото URL">
        <button class="checkout-btn" id="addProductBtn" onclick="addProduct()">Добавить товар</button>
    </div>

    <script>
        let isAdmin = false;
        let cart = [];

        // Инициализация режима администратора
        const toggleAdminMode = () => {
            isAdmin = !isAdmin;
            document.getElementById("adminBtn").style.background = isAdmin ? "var(--brand-color)" : "";
            document.getElementById("adminSheet").style.display = isAdmin ? "block" : "none";
        };

        // Добавление товара
        const addProduct = async () => {
            const name = document.getElementById('p_name').value;
            const price = parseFloat(document.getElementById('p_price').value);
            const category = document.getElementById('p_cat').value;
            const imageUrl = document.getElementById('p_url').value;

            if (name && price && category && imageUrl) {
                try {
                    await addDoc(collection(db, "vape_items"), {
                        name,
                        price,
                        category,
                        imageUrl
                    });
                    alert("Товар успешно добавлен!");
                    document.getElementById('p_name').value = '';
                    document.getElementById('p_price').value = '';
                    document.getElementById('p_url').value = '';
                    loadProducts();
                } catch (e) {
                    console.error("Ошибка при добавлении товара: ", e);
                }
            } else {
                alert("Пожалуйста, заполните все поля.");
            }
        };

        // Загрузка товаров
        const loadProducts = async () => {
            const querySnapshot = await getDocs(collection(db, "vape_items"));
            const productsContainer = document.getElementById("products");
            productsContainer.innerHTML = "";

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const productElement = document.createElement("div");
                productElement.className = "product-card";
                productElement.innerHTML = `
                    <img src="${data.imageUrl}" alt="${data.name}" class="product-image">
                    <div class="product-info">
                        <h3 class="product-title">${data.name}</h3>
                        <p class="product-category">${data.category}</p>
                        <p class="product-price">${data.price} ₽</p>
                        ${isAdmin ? `<button class="remove-product-btn" onclick="removeProduct('${doc.id}')">Удалить</button>` : ""}
                    </div>
                `;
                productsContainer.appendChild(productElement);
            });
        };

        // Удаление товара
        const removeProduct = async (productId) => {
            try {
                await deleteDoc(doc(db, "vape_items", productId));
                alert("Товар успешно удален!");
                loadProducts();
            } catch (e) {
                console.error("Ошибка при удалении товара: ", e);
            }
        };

        // Инициализация товаров
        loadProducts();
    </script>
</body>
</html>
