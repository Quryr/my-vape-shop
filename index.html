<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Vape Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #39FF14; /* Toxic Green */
            --primary-glow: rgba(57, 255, 20, 0.5);
            --bg-dark: #050505;
            --card-bg: rgba(20, 20, 20, 0.7);
        }

        .theme-ice {
            --primary: #00D1FF;
            --primary-glow: rgba(0, 209, 255, 0.5);
        }

        .theme-magma {
            --primary: #FF4D00;
            --primary-glow: rgba(255, 77, 0, 0.5);
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glow-sphere {
            position: fixed;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.4;
            animation: move 20s infinite alternate;
        }

        @keyframes move {
            from { transform: translate(-10%, -10%); }
            to { transform: translate(20%, 30%); }
        }

        .product-card {
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: transform 0.2s ease;
        }
        
        .product-card:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: var(--primary);
            color: black;
            font-weight: 700;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .loader-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hide scrollbar */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24">

    <!-- Background Elements -->
    <div class="glow-sphere bg-[var(--primary)] top-0 left-[-50px]"></div>
    <div class="glow-sphere bg-purple-600 bottom-0 right-[-50px]" style="animation-delay: -5s;"></div>

    <!-- Loader -->
    <div id="loader" class="loader-screen">
        <div class="w-16 h-16 border-4 border-t-[var(--primary)] border-white/10 rounded-full animate-spin"></div>
        <p class="mt-4 text-[var(--primary)] font-bold tracking-widest uppercase text-sm">Premium Vape</p>
    </div>

    <!-- Header -->
    <header class="p-4 sticky top-0 z-40 glass mb-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold tracking-tighter">VAPE<span class="text-[var(--primary)]">STORE</span></h1>
            <p id="user-name" class="text-[8px] text-gray-400 uppercase tracking-widest">Guest User</p>
        </div>
        <div class="flex gap-3">
            <button id="theme-toggle" class="p-2 rounded-full glass border-white/5">
                <i data-lucide="palette" class="w-5 h-5"></i>
            </button>
            <button id="admin-btn" class="hidden p-2 rounded-full glass border-white/5 text-[var(--primary)]">
                <i data-lucide="shield-check" class="w-5 h-5"></i>
            </button>
            <button id="add-product-btn" class="hidden p-2 rounded-full glass border-white/5">
                <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- App Content -->
    <main class="px-4">
        <!-- Categories -->
        <div class="flex gap-2 overflow-x-auto mb-6 no-scrollbar">
            <button class="px-4 py-2 glass rounded-full text-xs whitespace-nowrap border-[var(--primary)] text-[var(--primary)]">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
            <button class="px-4 py-2 glass rounded-full text-xs whitespace-nowrap opacity-60">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</button>
            <button class="px-4 py-2 glass rounded-full text-xs whitespace-nowrap opacity-60">–ñ–∏–¥–∫–æ—Å—Ç–∏</button>
            <button class="px-4 py-2 glass rounded-full text-xs whitespace-nowrap opacity-60">–ü–æ–¥-—Å–∏—Å—Ç–µ–º—ã</button>
        </div>

        <!-- Product Grid -->
        <div id="product-grid" class="grid grid-cols-2 gap-3">
            <!-- Products injected here -->
        </div>
    </main>

    <!-- Navigation / Cart Trigger -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] z-50">
        <button id="cart-trigger" class="w-full btn-primary py-4 rounded-2xl flex justify-between items-center px-6 transition-transform active:scale-95">
            <div class="flex items-center gap-2">
                <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                <span class="font-bold uppercase text-sm">–ö–æ—Ä–∑–∏–Ω–∞</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="cart-count" class="bg-black text-white text-[10px] px-2 py-0.5 rounded-full">0</span>
                <span id="cart-total" class="font-black text-lg">0 ‚ÇΩ</span>
            </div>
        </button>
    </div>

    <!-- Modals & Sheets -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden opacity-0 transition-opacity duration-300"></div>

    <!-- Cart Bottom Sheet -->
    <div id="cart-sheet" class="fixed bottom-0 left-0 right-0 glass rounded-t-[32px] z-[70] p-6 bottom-sheet max-h-[90vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-white/20 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black italic">–í–ê–®–ê –ö–û–†–ó–ò–ù–ê</h2>
            <button onclick="toggleCart(false)" class="text-white/50"><i data-lucide="x"></i></button>
        </div>
        
        <div id="cart-items" class="space-y-4 mb-8">
            <!-- Cart items injected here -->
        </div>

        <div id="checkout-form" class="hidden space-y-4">
            <h3 class="text-[var(--primary)] font-bold uppercase text-xs tracking-widest mb-4">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</h3>
            <input type="text" id="order-name" placeholder="–í–∞—à–µ –∏–º—è" class="w-full glass p-4 rounded-xl outline-none focus:border-[var(--primary)] transition-colors">
            <input type="tel" id="order-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" class="w-full glass p-4 rounded-xl outline-none focus:border-[var(--primary)] transition-colors">
            <input type="text" id="order-contact" placeholder="@username –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å" class="w-full glass p-4 rounded-xl outline-none focus:border-[var(--primary)] transition-colors">
            <input type="text" id="order-location" placeholder="–ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏ (—Ä–∞–π–æ–Ω/–º–µ—Ç—Ä–æ)" class="w-full glass p-4 rounded-xl outline-none focus:border-[var(--primary)] transition-colors">
            <input type="text" id="order-time" placeholder="–£–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–µ–≥–æ–¥–Ω—è –≤ 18:00)" class="w-full glass p-4 rounded-xl outline-none focus:border-[var(--primary)] transition-colors">
            
            <button onclick="proceedToPayment()" class="w-full btn-primary py-4 rounded-xl mt-4 font-black">–ü–ï–†–ï–ô–¢–ò –ö –û–ü–õ–ê–¢–ï</button>
        </div>

        <div id="payment-screen" class="hidden text-center space-y-6">
            <div class="py-4 border-y border-white/10">
                <p class="text-gray-400 text-sm mb-1 uppercase">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</p>
                <h3 id="final-total" class="text-4xl font-black text-[var(--primary)]">0 ‚ÇΩ</h3>
            </div>
            
            <div class="glass p-6 rounded-2xl relative overflow-hidden text-left">
                <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="credit-card" class="w-12 h-12"></i></div>
                <p class="text-[10px] text-gray-500 mb-1 uppercase tracking-widest">Ozon –ë–∞–Ω–∫</p>
                <p class="text-xl font-mono tracking-wider mb-4 select-all">2204 3209 2444 1944</p>
                <p class="text-xs text-white/70">–ü–æ–ª—É—á–∞—Ç–µ–ª—å: <span class="text-white font-bold">–ò–≤–∞–Ω –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á –†.</span></p>
            </div>

            <div class="bg-[var(--primary)]/10 border border-[var(--primary)]/30 p-4 rounded-xl text-sm">
                ‚ö†Ô∏è <span class="font-bold">–í–ê–ñ–ù–û:</span> –í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–ª–∞—Ç–µ–∂—É —É–∫–∞–∂–∏—Ç–µ –∫–æ–¥: <span id="order-id" class="font-black text-[var(--primary)]">VX-###</span>
            </div>

            <button onclick="confirmPayment()" class="w-full btn-primary py-4 rounded-xl font-black">–Ø –û–ü–õ–ê–¢–ò–õ</button>
            <button onclick="backToForm()" class="text-xs text-white/30 uppercase font-bold tracking-widest">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–∞–Ω–Ω—ã–º</button>
        </div>

        <div id="cart-empty" class="text-center py-10 hidden">
            <i data-lucide="ghost" class="w-12 h-12 mx-auto mb-4 opacity-20"></i>
            <p class="text-white/40">–í –∫–æ—Ä–∑–∏–Ω–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ...</p>
        </div>
        
        <div id="cart-footer">
            <button onclick="showCheckoutForm()" class="w-full btn-primary py-4 rounded-xl font-black">–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó</button>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-6">
        <div class="glass w-full max-w-sm rounded-[32px] p-6 border-white/20 shadow-2xl">
            <h2 class="text-xl font-black mb-4">–î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†</h2>
            <div class="space-y-3">
                <input type="text" id="p-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" class="w-full glass p-3 rounded-lg outline-none">
                <input type="number" id="p-price" placeholder="–¶–µ–Ω–∞ (—Ä—É–±)" class="w-full glass p-3 rounded-lg outline-none">
                <select id="p-cat" class="w-full glass p-3 rounded-lg outline-none appearance-none">
                    <option value="–û–¥–Ω–æ—Ä–∞–∑–∫–∞">–û–¥–Ω–æ—Ä–∞–∑–∫–∞</option>
                    <option value="–ñ–∏–¥–∫–æ—Å—Ç—å">–ñ–∏–¥–∫–æ—Å—Ç—å</option>
                    <option value="–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
                    <option value="–†–∞—Å—Ö–æ–¥–Ω–∏–∫">–†–∞—Å—Ö–æ–¥–Ω–∏–∫</option>
                </select>
                <input type="text" id="p-img" placeholder="Emoji / –ò–∫–æ–Ω–∫–∞" class="w-full glass p-3 rounded-lg outline-none">
                <div class="flex gap-2 pt-4">
                    <button onclick="closeAdmin()" class="flex-1 py-3 rounded-lg glass font-bold text-xs uppercase">–û—Ç–º–µ–Ω–∞</button>
                    <button onclick="saveNewProduct()" class="flex-1 py-3 rounded-lg btn-primary font-bold text-xs uppercase">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, deleteDoc, addDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vape-premium-mini-app';
        const ADMIN_ID = 1262669099;

        const tg = window.Telegram?.WebApp;
        if (tg) tg.expand();

        let user = null;
        let isAdmin = false;
        let products = [];
        let cart = [];
        let currentTheme = 'toxic';

        // --- AUTH & INITIALIZATION ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                checkAdminRights();
                setupListeners();
                setTimeout(() => {
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader').remove(), 500);
                }, 2000);
            }
        });

        const checkAdminRights = () => {
            let tgId = null;
            
            // Aggressive ID Check
            try {
                if (tg?.initDataUnsafe?.user?.id) {
                    tgId = tg.initDataUnsafe.user.id;
                    document.getElementById('user-name').innerText = tg.initDataUnsafe.user.username || tg.initDataUnsafe.user.first_name;
                } else {
                    // Manual hash parsing as fallback
                    const hash = window.location.hash;
                    if (hash.includes('user=')) {
                        const userMatch = hash.match(/user=([^&]*)/);
                        if (userMatch) {
                            const userData = JSON.parse(decodeURIComponent(userMatch[1]));
                            tgId = userData.id;
                        }
                    }
                }
            } catch (e) { console.error("Admin check error", e); }

            if (tgId == ADMIN_ID) {
                isAdmin = true;
                document.getElementById('admin-btn').classList.remove('hidden');
                document.getElementById('add-product-btn').classList.remove('hidden');
            }
        };

        // --- DATABASE OPS ---
        const setupListeners = () => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            onSnapshot(colRef, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Auto-seeding for admin on empty DB
                if (products.length === 0 && isAdmin) {
                    seedDatabase();
                } else {
                    renderProducts();
                }
            }, (err) => {
                console.error("Firestore error:", err);
            });
        };

        const seedDatabase = async () => {
            const starterItems = [
                { name: "HQD Cuvie Air", price: 1200, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∞", icon: "üí®" },
                { name: "Elf Bar BC5000", price: 1100, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∞", icon: "üçì" },
                { name: "Lost Mary OS5000", price: 1050, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∞", icon: "üçí" },
                { name: "Waka SoPro 10k", price: 1500, category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∞", icon: "‚ö°" },
                { name: "Husky Ice Liquid", price: 550, category: "–ñ–∏–¥–∫–æ—Å—Ç—å", icon: "üßä" },
                { name: "Maxwell's Shoria", price: 650, category: "–ñ–∏–¥–∫–æ—Å—Ç—å", icon: "üå≤" },
                { name: "Boshki Original", price: 600, category: "–ñ–∏–¥–∫–æ—Å—Ç—å", icon: "üåø" },
                { name: "Vaporesso XROS 3", price: 2800, category: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", icon: "üì±" },
                { name: "Charon Baby Plus", price: 2400, category: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", icon: "üëæ" },
                { name: "–ö–∞—Ä—Ç—Ä–∏–¥–∂ XROS 0.6", price: 350, category: "–†–∞—Å—Ö–æ–¥–Ω–∏–∫", icon: "üì¶" },
                { name: "–ò—Å–ø–∞—Ä–∏—Ç–µ–ª—å Smoant S-1", price: 300, category: "–†–∞—Å—Ö–æ–¥–Ω–∏–∫", icon: "‚öôÔ∏è" }
            ];

            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            for (const item of starterItems) {
                await addDoc(colRef, item);
            }
        };

        // --- RENDER LOGIC ---
        const renderProducts = () => {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = products.map(p => `
                <div class="product-card glass p-3 rounded-2xl fade-in relative overflow-hidden">
                    ${isAdmin ? `<button onclick="window.deleteProduct('${p.id}')" class="absolute top-2 right-2 z-10 p-1 bg-red-500/20 text-red-500 rounded-md"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                    <div class="h-24 flex items-center justify-center text-5xl mb-3">${p.icon || 'üì¶'}</div>
                    <div class="flex-grow flex flex-col">
                        <span class="text-[8px] uppercase font-bold text-[var(--primary)] opacity-60 mb-1">${p.category}</span>
                        <h3 class="text-xs font-bold leading-tight mb-2 line-clamp-2">${p.name}</h3>
                        <div class="mt-auto">
                            <p class="text-sm font-black mb-3">${p.price} ‚ÇΩ</p>
                            <button onclick="window.addToCart('${p.id}')" class="w-full btn-primary py-2 rounded-lg text-[10px] uppercase font-bold transition-all active:scale-95">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        };

        const renderCart = () => {
            const container = document.getElementById('cart-items');
            const empty = document.getElementById('cart-empty');
            const footer = document.getElementById('cart-footer');
            
            if (cart.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                footer.classList.add('hidden');
            } else {
                empty.classList.add('hidden');
                footer.classList.remove('hidden');
                container.innerHTML = cart.map((item, idx) => `
                    <div class="flex items-center gap-4 glass p-3 rounded-xl">
                        <div class="text-2xl">${item.icon}</div>
                        <div class="flex-grow">
                            <h4 class="text-sm font-bold">${item.name}</h4>
                            <p class="text-[var(--primary)] text-xs font-black">${item.price * item.quantity} ‚ÇΩ</p>
                        </div>
                        <div class="flex items-center gap-3 glass border-white/5 px-2 py-1 rounded-lg">
                            <button onclick="window.updateQty(${idx}, -1)" class="text-white/50"><i data-lucide="minus" class="w-4 h-4"></i></button>
                            <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                            <button onclick="window.updateQty(${idx}, 1)" class="text-[var(--primary)]"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
            updateCartTotals();
        };

        const updateCartTotals = () => {
            const count = cart.reduce((acc, item) => acc + item.quantity, 0);
            const total = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-total').innerText = `${total} ‚ÇΩ`;
            document.getElementById('final-total').innerText = `${total} ‚ÇΩ`;
        };

        // --- ACTIONS ---
        window.addToCart = (id) => {
            const product = products.find(p => p.id === id);
            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            renderCart();
        };

        window.updateQty = (idx, delta) => {
            cart[idx].quantity += delta;
            if (cart[idx].quantity <= 0) cart.splice(idx, 1);
            if (tg?.HapticFeedback) tg.HapticFeedback.selectionChanged();
            renderCart();
        };

        window.deleteProduct = async (id) => {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?")) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', id);
                await deleteDoc(docRef);
                if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
            } catch (e) {
                console.error("Error deleting", e);
            }
        };

        window.toggleCart = (show) => {
            const sheet = document.getElementById('cart-sheet');
            const overlay = document.getElementById('modal-overlay');
            if (show) {
                sheet.classList.add('active');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.style.opacity = '1', 10);
                renderCart();
            } else {
                sheet.classList.remove('active');
                overlay.style.opacity = '0';
                setTimeout(() => overlay.classList.add('hidden'), 300);
                backToForm(); // Reset view
            }
        };

        window.showCheckoutForm = () => {
            document.getElementById('cart-items').classList.add('hidden');
            document.getElementById('cart-footer').classList.add('hidden');
            document.getElementById('checkout-form').classList.remove('hidden');
        };

        window.backToForm = () => {
            document.getElementById('cart-items').classList.remove('hidden');
            document.getElementById('cart-footer').classList.remove('hidden');
            document.getElementById('checkout-form').classList.add('hidden');
            document.getElementById('payment-screen').classList.add('hidden');
        };

        window.proceedToPayment = () => {
            const name = document.getElementById('order-name').value;
            const phone = document.getElementById('order-phone').value;
            const contact = document.getElementById('order-contact').value;
            
            if (!name || !phone || !contact) {
                if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            const orderId = `VX-${Math.floor(100 + Math.random() * 899)}`;
            document.getElementById('order-id').innerText = orderId;
            
            document.getElementById('checkout-form').classList.add('hidden');
            document.getElementById('payment-screen').classList.remove('hidden');
            if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        };

        window.confirmPayment = () => {
            const total = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const orderData = {
                order_id: document.getElementById('order-id').innerText,
                customer: {
                    name: document.getElementById('order-name').value,
                    phone: document.getElementById('order-phone').value,
                    contact: document.getElementById('order-contact').value,
                    location: document.getElementById('order-location').value,
                    time: document.getElementById('order-time').value,
                },
                items: cart,
                total: total,
                timestamp: new Date().toISOString()
            };

            if (tg) {
                tg.sendData(JSON.stringify(orderData));
                tg.close();
            } else {
                console.log("Mock Order Sent:", orderData);
                alert("–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ö–æ–¥: " + orderData.order_id);
                toggleCart(false);
                cart = [];
                renderCart();
            }
        };

        window.saveNewProduct = async () => {
            const name = document.getElementById('p-name').value;
            const price = parseInt(document.getElementById('p-price').value);
            const category = document.getElementById('p-cat').value;
            const icon = document.getElementById('p-img').value;

            if (!name || !price) return;

            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            await addDoc(colRef, { name, price, category, icon });
            
            closeAdmin();
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
        };

        window.closeAdmin = () => {
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-modal').classList.remove('flex');
        };

        // --- UI BINDINGS ---
        document.getElementById('cart-trigger').onclick = () => toggleCart(true);
        document.getElementById('modal-overlay').onclick = () => toggleCart(false);
        
        document.getElementById('add-product-btn').onclick = () => {
            document.getElementById('admin-modal').classList.remove('hidden');
            document.getElementById('admin-modal').classList.add('flex');
        };

        document.getElementById('theme-toggle').onclick = () => {
            const body = document.body;
            if (currentTheme === 'toxic') {
                body.classList.add('theme-ice');
                currentTheme = 'ice';
            } else if (currentTheme === 'ice') {
                body.classList.remove('theme-ice');
                body.classList.add('theme-magma');
                currentTheme = 'magma';
            } else {
                body.classList.remove('theme-magma');
                currentTheme = 'toxic';
            }
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        };

        // START
        initAuth();
        lucide.createIcons();

    </script>
</body>
</html>
