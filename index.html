<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VAPE LUXE - Premium Shop</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --accent-color: #22c55e; /* Default Toxic Green */
            --accent-glow: rgba(34, 197, 94, 0.5);
        }

        body {
            background-color: #000000;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .accent-text { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color); }
        .accent-border { border-color: var(--accent-color); }
        .accent-shadow { box-shadow: 0 0 15px var(--accent-glow); }

        /* Animated Spheres */
        .orb {
            position: fixed;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.4;
            pointer-events: none;
            animation: move 20s infinite alternate ease-in-out;
        }

        @keyframes move {
            from { transform: translate(-20%, -20%); }
            to { transform: translate(20%, 20%); }
        }

        /* Bottom Sheet Transitions */
        .bottom-sheet {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
        }
        .bottom-sheet.active {
            transform: translateY(0);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 0px; height: 0px; }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* Essential for Button Alignment */
        .product-card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .product-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #loading-screen {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
    </style>
</head>
<body class="p-4">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="w-12 h-12 border-4 accent-border border-t-transparent rounded-full animate-spin mb-4 shadow-lg accent-shadow"></div>
        <p class="text-sm font-medium tracking-widest uppercase accent-text animate-pulse">Initializing Luxe...</p>
    </div>

    <!-- Background Orbs -->
    <div class="orb accent-bg top-[-50px] left-[-50px]"></div>
    <div class="orb bg-purple-600 bottom-[-50px] right-[-50px]" style="animation-delay: -5s;"></div>

    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight">VAPE <span class="accent-text">LUXE</span></h1>
            <div id="auth-status" class="text-[10px] uppercase tracking-[0.2em] opacity-50">Authorized</div>
        </div>
        <div class="flex items-center gap-3">
            <!-- Admin Buttons -->
            <div id="admin-controls" class="hidden flex items-center gap-2">
                <button onclick="showStats()" class="p-2 glass rounded-full"><i data-lucide="shield" class="w-5 h-5 accent-text"></i></button>
                <button onclick="toggleAddModal(true)" class="p-2 glass rounded-full"><i data-lucide="plus" class="w-5 h-5 accent-text"></i></button>
            </div>
            <!-- Theme Switcher -->
            <button onclick="cycleTheme()" class="p-2 glass rounded-full"><i data-lucide="palette" class="w-5 h-5"></i></button>
        </div>
    </header>

    <!-- Category Filter -->
    <nav class="flex overflow-x-auto gap-2 mb-6 no-scrollbar pb-2">
        <button onclick="setFilter('–í—Å–µ')" class="category-btn px-5 py-2 glass rounded-2xl text-sm font-medium whitespace-nowrap active">–í—Å–µ</button>
        <button onclick="setFilter('–û–¥–Ω–æ—Ä–∞–∑–∫–∏')" class="category-btn px-5 py-2 glass rounded-2xl text-sm font-medium whitespace-nowrap opacity-60">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</button>
        <button onclick="setFilter('–ñ–∏–¥–∫–æ—Å—Ç–∏')" class="category-btn px-5 py-2 glass rounded-2xl text-sm font-medium whitespace-nowrap opacity-60">–ñ–∏–¥–∫–æ—Å—Ç–∏</button>
        <button onclick="setFilter('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞')" class="category-btn px-5 py-2 glass rounded-2xl text-sm font-medium whitespace-nowrap opacity-60">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
        <button onclick="setFilter('–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏')" class="category-btn px-5 py-2 glass rounded-2xl text-sm font-medium whitespace-nowrap opacity-60">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</button>
    </nav>

    <!-- Product Grid -->
    <div id="product-grid" class="product-grid mb-24">
        <!-- Products injected here -->
    </div>

    <!-- Floating Cart Button -->
    <div id="cart-fab" class="fixed bottom-6 right-6 z-40 hidden">
        <button onclick="toggleCart(true)" class="accent-bg p-4 rounded-full shadow-2xl accent-shadow flex items-center justify-center relative transform active:scale-95 transition-transform">
            <i data-lucide="shopping-cart" class="text-black w-6 h-6"></i>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-white text-black text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
        </button>
    </div>

    <!-- Modals & Sheets -->
    <div id="overlay" onclick="closeAll()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300"></div>

    <!-- Cart Bottom Sheet -->
    <div id="cart-sheet" class="bottom-sheet fixed bottom-0 left-0 right-0 glass z-50 rounded-t-[32px] p-6 max-h-[85vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-6"></div>
        <h2 class="text-2xl font-bold mb-6 flex items-center justify-between">
            –ö–æ—Ä–∑–∏–Ω–∞
            <span id="cart-total-header" class="text-lg font-medium accent-text">0 ‚ÇΩ</span>
        </h2>
        <div id="cart-items" class="space-y-4 mb-8">
            <!-- Cart items injected here -->
        </div>
        <div id="checkout-form" class="hidden space-y-4 mb-8">
            <h3 class="font-bold text-lg">–î–µ—Ç–∞–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
            <input type="text" id="order-name" placeholder="–ò–º—è" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl focus:outline-none focus:border-green-500 transition-colors">
            <input type="tel" id="order-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl focus:outline-none focus:border-green-500 transition-colors">
            <input type="text" id="order-location" placeholder="–ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl focus:outline-none focus:border-green-500 transition-colors">
            <input type="text" id="order-time" placeholder="–ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl focus:outline-none focus:border-green-500 transition-colors">
        </div>
        <div id="payment-screen" class="hidden space-y-6 mb-8 text-center">
            <div class="p-6 glass rounded-3xl border-dashed accent-border border-2">
                <p class="text-sm opacity-60 mb-2">–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –Ω–∞ Ozon</p>
                <h4 id="final-amount" class="text-3xl font-black mb-4 tracking-wider">0 ‚ÇΩ</h4>
                <div class="bg-black/40 p-4 rounded-xl mb-2 font-mono text-lg select-all cursor-pointer" onclick="copyCard()">2204 3209 2444 1944</div>
                <p class="text-xs opacity-50">–ò–≤–∞–Ω –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á –†.</p>
            </div>
            <p class="text-[10px] opacity-40 uppercase">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</p>
        </div>
        <button id="cart-action-btn" onclick="nextStep()" class="w-full accent-bg text-black font-bold py-4 rounded-2xl accent-shadow active:scale-95 transition-transform uppercase tracking-widest">
            –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </button>
    </div>

    <!-- Admin: Add Product Modal -->
    <div id="add-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] glass z-50 rounded-[32px] p-6 hidden scale-90 transition-all opacity-0">
        <h2 class="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
        <div class="space-y-3">
            <input type="text" id="p-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. HQD Titan)" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl">
            <input type="number" id="p-price" placeholder="–¶–µ–Ω–∞ (—Ä—É–±)" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl">
            <select id="p-category" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl appearance-none">
                <option value="–û–¥–Ω–æ—Ä–∞–∑–∫–∏">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</option>
                <option value="–ñ–∏–¥–∫–æ—Å—Ç–∏">–ñ–∏–¥–∫–æ—Å—Ç–∏</option>
                <option value="–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
                <option value="–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</option>
            </select>
            <input type="text" id="p-emoji" placeholder="–≠–º–æ–¥–∑–∏ (üí®, üîã, üçì)" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl">
            <div class="flex gap-2">
                <button onclick="toggleAddModal(false)" class="flex-1 py-3 glass rounded-xl">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveProduct()" class="flex-1 py-3 accent-bg text-black font-bold rounded-xl">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Notifications Placeholder -->
    <div id="notification" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 glass rounded-full shadow-2xl translate-y-[-100px] transition-transform flex items-center gap-3">
        <i data-lucide="check-circle" class="w-5 h-5 accent-text"></i>
        <span id="notif-text" class="text-sm font-medium">–£—Å–ø–µ—à–Ω–æ</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Global State
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const ADMIN_ID = '1262669099';
        const ADMIN_USERNAME = 'Tru5tNoBody';
        
        let db, auth, user;
        let items = [];
        let cart = [];
        let currentFilter = '–í—Å–µ';
        let isAdmin = false;
        let currentStep = 'cart'; // cart, form, payment
        let activeTheme = 0;
        const themes = [
            { name: 'Toxic Green', color: '#22c55e', glow: 'rgba(34, 197, 94, 0.5)' },
            { name: 'Ice Blue', color: '#3b82f6', glow: 'rgba(59, 130, 246, 0.5)' },
            { name: 'Magma Orange', color: '#f97316', glow: 'rgba(249, 115, 22, 0.5)' }
        ];

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vape-luxe-premium';

        // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –ª–æ–∞–¥–µ—Ä–∞
        function hideLoading() {
            const loader = document.getElementById('loading-screen');
            if (loader) {
                loader.style.opacity = '0';
                loader.style.visibility = 'hidden';
                setTimeout(() => loader.remove(), 500);
            }
        }

        // --- CORE FUNCTIONS ---

        async function initApp() {
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Å—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ Firebase —É–ø–∞–¥–µ—Ç)
            setTimeout(hideLoading, 3500);

            try {
                if (typeof __firebase_config === 'undefined') {
                    console.error("Firebase config is missing");
                    hideLoading();
                    return;
                }

                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Auth Logic (Rule 3)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        checkAdmin();
                        startListeners();
                        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                        hideLoading();
                    }
                });
            } catch (err) {
                console.error("Init Error:", err);
                showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", "error");
                hideLoading(); // –°–∫—Ä—ã–≤–∞–µ–º –≤ —Å–ª—É—á–∞–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏
            }
        }

        function checkAdmin() {
            const userId = tg.initDataUnsafe?.user?.id?.toString();
            const username = tg.initDataUnsafe?.user?.username;
            
            const verify = () => {
                if (userId === ADMIN_ID || username === ADMIN_USERNAME) {
                    isAdmin = true;
                    document.getElementById('admin-controls').classList.remove('hidden');
                    document.getElementById('auth-status').innerText = 'ADMIN MODE';
                    document.getElementById('auth-status').classList.remove('opacity-50');
                    document.getElementById('auth-status').classList.add('accent-text', 'font-bold');
                    renderProducts(); 
                }
            };

            verify();
            setTimeout(verify, 500);
            setTimeout(verify, 2000);
        }

        function startListeners() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            onSnapshot(q, (snapshot) => {
                items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (items.length === 0 && isAdmin) {
                    seedDatabase();
                }
                
                renderProducts();
            }, (err) => {
                console.error("Snapshot error:", err);
                hideLoading();
            });
        }

        async function seedDatabase() {
            const starter = [
                { name: 'HQD Titan 7000', price: 1200, category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', emoji: 'üíé' },
                { name: 'Elf Bar BC5000', price: 950, category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', emoji: 'üçâ' },
                { name: 'Vaporesso XROS 3', price: 2900, category: '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', emoji: 'üîã' },
                { name: 'Bad Drip 60ml', price: 1500, category: '–ñ–∏–¥–∫–æ—Å—Ç–∏', emoji: 'üß™' },
                { name: 'Maxwell\'s Shoria', price: 800, category: '–ñ–∏–¥–∫–æ—Å—Ç–∏', emoji: 'üå≤' },
                { name: 'Lost Mary 5000', price: 1000, category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', emoji: 'üçì' },
                { name: 'Geekvape Aegis', price: 4500, category: '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', emoji: 'üõ†Ô∏è' },
                { name: 'Coils 0.6 Ohm', price: 350, category: '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', emoji: 'üåÄ' },
                { name: 'Husky Double Ice', price: 650, category: '–ñ–∏–¥–∫–æ—Å—Ç–∏', emoji: '‚ùÑÔ∏è' },
                { name: 'Waka 10000', price: 1800, category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', emoji: 'üõ∏' }
            ];

            for (const item of starter) {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), item);
                } catch(e) {}
            }
        }

        // --- UI RENDERING ---

        window.renderProducts = function() {
            const container = document.getElementById('product-grid');
            const filtered = items.filter(i => currentFilter === '–í—Å–µ' || i.category === currentFilter);
            
            container.innerHTML = filtered.map(item => `
                <div class="product-card glass p-4 rounded-[24px] relative animate-in fade-in zoom-in duration-300">
                    ${isAdmin ? `<button onclick="deleteProduct('${item.id}')" class="absolute top-2 right-2 p-1.5 bg-red-500/20 text-red-500 rounded-full z-10"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                    <div class="text-4xl mb-3 h-20 flex items-center justify-center bg-white/5 rounded-2xl">${item.emoji || 'üí®'}</div>
                    <div class="product-info">
                        <h3 class="font-bold text-sm leading-tight mb-1 line-clamp-2">${item.name}</h3>
                        <p class="text-[10px] opacity-40 uppercase tracking-wider mb-3">${item.category}</p>
                        <div class="mt-auto">
                            <div class="text-lg font-black accent-text mb-3">${item.price} ‚ÇΩ</div>
                            <button onclick="addToCart('${item.id}')" class="w-full py-2.5 rounded-xl border border-white/10 glass text-[10px] font-bold uppercase tracking-widest hover:accent-bg hover:text-black transition-all active:scale-95">
                                –í –∫–æ—Ä–∑–∏–Ω—É
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        // --- CART LOGIC ---

        window.addToCart = function(id) {
            const item = items.find(i => i.id === id);
            const inCart = cart.find(c => c.id === id);
            
            if (inCart) {
                inCart.count++;
            } else {
                cart.push({ ...item, count: 1 });
            }
            
            tg.HapticFeedback.impactOccurred('medium');
            updateCartUI();
            showNotification(`+ ${item.name}`);
        }

        function updateCartUI() {
            const count = cart.reduce((a, b) => a + b.count, 0);
            const total = cart.reduce((a, b) => a + (b.count * b.price), 0);
            
            document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-total-header').innerText = `${total} ‚ÇΩ`;
            document.getElementById('cart-fab').classList.toggle('hidden', count === 0);
            
            const itemsContainer = document.getElementById('cart-items');
            itemsContainer.innerHTML = cart.map((item, idx) => `
                <div class="flex items-center gap-4 glass p-3 rounded-2xl">
                    <div class="text-2xl">${item.emoji}</div>
                    <div class="flex-grow">
                        <div class="text-sm font-bold line-clamp-1">${item.name}</div>
                        <div class="text-xs accent-text">${item.price} ‚ÇΩ</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="updateQty(${idx}, -1)" class="w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 border border-white/10">-</button>
                        <span class="text-sm font-bold">${item.count}</span>
                        <button onclick="updateQty(${idx}, 1)" class="w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 border border-white/10">+</button>
                    </div>
                </div>
            `).join('');
        }

        window.updateQty = function(idx, delta) {
            cart[idx].count += delta;
            if (cart[idx].count <= 0) cart.splice(idx, 1);
            updateCartUI();
            if (cart.length === 0) closeAll();
        }

        // --- CHECKOUT FLOW ---

        window.nextStep = function() {
            const btn = document.getElementById('cart-action-btn');
            
            if (currentStep === 'cart') {
                document.getElementById('cart-items').classList.add('hidden');
                document.getElementById('checkout-form').classList.remove('hidden');
                btn.innerText = '–ö –æ–ø–ª–∞—Ç–µ';
                currentStep = 'form';
                return;
            }

            if (currentStep === 'form') {
                const name = document.getElementById('order-name').value;
                const phone = document.getElementById('order-phone').value;
                if (!name || !phone) return showNotification("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã", "error");
                
                const total = cart.reduce((a, b) => a + (b.count * b.price), 0);
                document.getElementById('checkout-form').classList.add('hidden');
                document.getElementById('payment-screen').classList.remove('hidden');
                document.getElementById('final-amount').innerText = `${total} ‚ÇΩ`;
                btn.innerText = '–Ø –æ–ø–ª–∞—Ç–∏–ª';
                currentStep = 'payment';
                return;
            }

            if (currentStep === 'payment') {
                submitOrder();
            }
        }

        function submitOrder() {
            const total = cart.reduce((a, b) => a + (b.count * b.price), 0);
            const orderId = `VX-${Math.floor(Math.random() * 900) + 100}`;
            
            const orderData = {
                orderId,
                items: cart.map(i => `${i.name} x${i.count}`),
                total,
                customer: {
                    name: document.getElementById('order-name').value,
                    phone: document.getElementById('order-phone').value,
                    username: tg.initDataUnsafe?.user?.username || 'N/A',
                    location: document.getElementById('order-location').value,
                    time: document.getElementById('order-time').value
                }
            };

            tg.HapticFeedback.notificationOccurred('success');
            tg.sendData(JSON.stringify(orderData));
            
            showNotification(`–ó–∞–∫–∞–∑ ${orderId} –æ—Ñ–æ—Ä–º–ª–µ–Ω!`);
            setTimeout(() => tg.close(), 1500);
        }

        // --- UTILS ---

        window.setFilter = function(f) {
            currentFilter = f;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === f);
                btn.classList.toggle('opacity-60', btn.innerText !== f);
            });
            renderProducts();
        }

        window.cycleTheme = function() {
            activeTheme = (activeTheme + 1) % themes.length;
            const theme = themes[activeTheme];
            document.documentElement.style.setProperty('--accent-color', theme.color);
            document.documentElement.style.setProperty('--accent-glow', theme.glow);
            document.querySelector('.orb.accent-bg').style.backgroundColor = theme.color;
            showNotification(`–¢–µ–º–∞: ${theme.name}`);
        }

        window.toggleCart = function(open) {
            const sheet = document.getElementById('cart-sheet');
            const overlay = document.getElementById('overlay');
            if (open) {
                sheet.classList.add('active');
                overlay.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                sheet.classList.remove('active');
                overlay.classList.remove('opacity-100', 'pointer-events-auto');
                setTimeout(() => {
                    currentStep = 'cart';
                    document.getElementById('cart-items').classList.remove('hidden');
                    document.getElementById('checkout-form').classList.add('hidden');
                    document.getElementById('payment-screen').classList.add('hidden');
                    document.getElementById('cart-action-btn').innerText = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                }, 300);
            }
        }

        window.toggleAddModal = function(open) {
            const modal = document.getElementById('add-modal');
            const overlay = document.getElementById('overlay');
            if (open) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('scale-100', 'opacity-100'), 10);
                overlay.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                modal.classList.remove('scale-100', 'opacity-100');
                overlay.classList.remove('opacity-100', 'pointer-events-auto');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        window.closeAll = function() {
            toggleCart(false);
            toggleAddModal(false);
        }

        window.showNotification = function(text, type = 'success') {
            const el = document.getElementById('notification');
            document.getElementById('notif-text').innerText = text;
            el.style.transform = 'translate(-50%, 40px)';
            setTimeout(() => {
                el.style.transform = 'translate(-50%, -100px)';
            }, 2000);
        }

        window.copyCard = function() {
            const text = "2204320924441944";
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification("–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
            tg.HapticFeedback.impactOccurred('light');
        }

        // --- ADMIN ACTIONS ---

        window.saveProduct = async function() {
            const name = document.getElementById('p-name').value;
            const price = parseInt(document.getElementById('p-price').value);
            const category = document.getElementById('p-category').value;
            const emoji = document.getElementById('p-emoji').value;

            if (!name || !price) return showNotification("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", "error");

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), {
                    name, price, category, emoji: emoji || 'üí®'
                });
                showNotification("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω");
                toggleAddModal(false);
                document.getElementById('p-name').value = '';
                document.getElementById('p-price').value = '';
            } catch (err) {
                showNotification("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "error");
            }
        }

        window.deleteProduct = async function(id) {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', id));
                tg.HapticFeedback.impactOccurred('heavy');
                showNotification("–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω");
            } catch (err) {
                showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "error");
            }
        }

        window.showStats = function() {
            showNotification(`–í –±–∞–∑–µ: ${items.length} –ø–æ–∑.`);
        }

        // Init on load
        window.onload = initApp;

    </script>
</body>
</html>
