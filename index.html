<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Vape Store</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.VapeCore = { db, auth, appId, methods: { collection, doc, onSnapshot, addDoc, deleteDoc, query, getDocs } };

        const runAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                window.dispatchEvent(new Event('vape-ready'));
            } catch (e) {
                console.error("Auth Fail", e);
            }
        };
        runAuth();
    </script>
    <style>
        :root {
            --brand: #00ff88;
            --brand-glow: rgba(0, 255, 136, 0.3);
            --bg: #050505;
            --surface: rgba(255, 255, 255, 0.05);
            --surface-border: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
            --text-dim: #a0a0a0;
            --error: #ff4d4d;
            --success: #00e676;
        }

        .theme-ice { --brand: #00d1ff; --brand-glow: rgba(0, 209, 255, 0.3); }
        .theme-magma { --brand: #ff6b00; --brand-glow: rgba(255, 107, 0, 0.3); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text); overflow-x: hidden; width: 100vw; min-height: 100vh; }

        /* Silk Background */
        .silk-bg { position: fixed; inset: 0; z-index: -1; background: #000; overflow: hidden; }
        .orb { position: absolute; width: 400px; height: 400px; border-radius: 50%; filter: blur(100px); opacity: 0.2; pointer-events: none; }
        .orb-1 { background: var(--brand); top: -100px; right: -100px; animation: float 15s infinite alternate; }
        .orb-2 { background: #4a00ff; bottom: -100px; left: -100px; animation: float 20s infinite alternate-reverse; }
        @keyframes float { from { transform: translate(0,0); } to { transform: translate(40px, 60px); } }

        /* Header */
        header {
            position: sticky; top: 0; z-index: 100; padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(20px); background: rgba(5,5,5,0.7);
            border-bottom: 1px solid var(--surface-border);
        }
        .logo { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .header-actions { display: flex; gap: 8px; }
        .btn-icon {
            background: var(--surface); border: 1px solid var(--surface-border); color: #fff;
            width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-icon.active { background: var(--brand); color: #000; border-color: var(--brand); }
        #adminBtn { display: none; }
        #addBtn { display: none; background: var(--brand); color: #000; border: none; }

        /* Categories */
        .cats-wrap { padding: 12px 0; overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
        .cats-inner { display: inline-flex; gap: 10px; padding: 0 20px 10px 20px; }
        .cat-btn {
            background: var(--surface); border: 1px solid var(--surface-border); color: var(--text-dim);
            padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; transition: 0.3s;
        }
        .cat-btn.active { color: var(--text); background: rgba(255,255,255,0.1); border-color: var(--brand); box-shadow: 0 0 15px var(--brand-glow); }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 0 16px 120px 16px; }
        .card {
            background: var(--surface); border: 1px solid var(--surface-border); border-radius: 24px;
            padding: 12px; display: flex; flex-direction: column; position: relative;
            backdrop-filter: blur(10px); animation: fadeIn 0.5s ease forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-del {
            position: absolute; top: 10px; right: 10px; background: var(--error);
            color: #fff; border: none; width: 30px; height: 30px; border-radius: 8px;
            display: none; align-items: center; justify-content: center; z-index: 10;
        }
        .card-img { width: 100%; aspect-ratio: 1/1; border-radius: 18px; object-fit: cover; background: rgba(255,255,255,0.02); margin-bottom: 10px; }
        
        .card-info { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
        .card-name { font-size: 14px; font-weight: 600; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; min-height: 36px; }
        .card-price { font-size: 16px; font-weight: 800; color: var(--brand); margin-top: auto; }
        
        .btn-buy { background: var(--text); color: var(--bg); border: none; padding: 14px; border-radius: 16px; font-weight: 800; font-size: 13px; cursor: pointer; transition: 0.2s; width: 100%; }
        .btn-buy:active { transform: scale(0.96); }

        /* Cart FAB */
        .cart-fab {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150px);
            width: calc(100% - 32px); max-width: 450px; background: var(--brand); color: #000;
            height: 68px; border-radius: 24px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 28px; font-weight: 800; z-index: 200; box-shadow: 0 10px 40px var(--brand-glow);
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cart-fab.visible { transform: translateX(-50%) translateY(0); }

        /* Sheets */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 300; opacity: 0; visibility: hidden; transition: 0.3s; }
        .overlay.active { opacity: 1; visibility: visible; }
        .sheet {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #0a0a0a;
            border-top: 1px solid var(--surface-border); border-radius: 32px 32px 0 0;
            z-index: 301; transform: translateY(100%); transition: 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            max-height: 85vh; padding: 24px; display: flex; flex-direction: column;
        }
        .sheet.active { transform: translateY(0); }
        
        .input { width: 100%; background: var(--surface); border: 1px solid var(--surface-border); color: #fff; padding: 16px; border-radius: 18px; margin-bottom: 12px; outline: none; font-size: 15px; }
        .btn-main { background: var(--brand); color: #000; border: none; width: 100%; padding: 20px; border-radius: 22px; font-weight: 800; font-size: 16px; cursor: pointer; }

        .price-tag { font-size: 32px; font-weight: 900; color: var(--brand); text-align: center; margin: 15px 0; }
        .copy-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 14px; border-radius: 16px; margin-bottom: 10px; font-size: 14px; }
        
        .cart-item { display: flex; align-items: center; gap: 12px; background: var(--surface); padding: 10px; border-radius: 18px; margin-bottom: 8px; }
        .item-qty { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 12px; }

        body.admin-mode .card-del { display: flex !important; }
        body.admin-mode .cart-fab { display: none !important; }

        #loader { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; transition: 0.5s; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--surface); border-top-color: var(--brand); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="theme-toxic">

    <div id="loader">
        <div class="spinner"></div>
        <div style="color: var(--brand); font-weight: 800; letter-spacing: 2px;">VAPE CLOUD</div>
    </div>

    <div class="silk-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <header>
        <div class="logo"><i data-lucide="zap" fill="var(--brand)" color="var(--brand)" size="22"></i> VAPE CLOUD</div>
        <div class="header-actions">
            <button class="btn-icon" id="addBtn" onclick="openSheet('adminSheet')"><i data-lucide="plus"></i></button>
            <button class="btn-icon" id="adminBtn" onclick="toggleAdmin()"><i data-lucide="shield"></i></button>
            <button class="btn-icon" onclick="toggleTheme()"><i data-lucide="palette"></i></button>
        </div>
    </header>

    <div class="cats-wrap"><div class="cats-inner" id="categories"></div></div>
    <div class="grid" id="products"></div>

    <div class="cart-fab" id="cartFab" onclick="openSheet('cartSheet')">
        <div style="display: flex; align-items: center; gap: 10px;"><i data-lucide="shopping-cart"></i> <span id="cartCount">0 ТОВАРОВ</span></div>
        <span id="cartTotal">0 ₽</span>
    </div>

    <div class="overlay" id="overlay" onclick="closeSheets()"></div>

    <!-- Корзина -->
    <div class="sheet" id="cartSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h2>Корзина</h2><i data-lucide="x" onclick="closeSheets()"></i></div>
        <div id="cartList" style="overflow-y:auto; flex-grow:1; margin-bottom:20px;"></div>
        <button class="btn-main" id="toOrderBtn" onclick="openSheet('orderSheet')">Перейти к оформлению</button>
    </div>

    <!-- Данные -->
    <div class="sheet" id="orderSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h2>Ваши данные</h2><i data-lucide="arrow-left" onclick="openSheet('cartSheet')"></i></div>
        <div style="overflow-y:auto; flex-grow:1;">
            <input type="text" id="order_name" class="input" placeholder="Ваше Имя">
            <input type="tel" id="order_phone" class="input" placeholder="Номер телефона">
            <input type="text" id="order_contact" class="input" placeholder="ТГ @username или контакт">
            <input type="text" id="order_loc" class="input" placeholder="Место встречи">
            <select id="order_time" class="input"><option value="6:00 - 12:00">6:00 - 12:00</option><option value="14:00 - 20:00">14:00 - 20:00</option></select>
        </div>
        <button class="btn-main" onclick="openPayment()">К оплате</button>
    </div>

    <!-- Оплата -->
    <div class="sheet" id="paymentSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h2>Оплата</h2><i data-lucide="x" onclick="closeSheets()"></i></div>
        <div class="price-tag" id="finalTotal">0 ₽</div>
        <div class="copy-row"><span>Карта Ozon: <b>2204 3209 2444 1944</b></span><span style="color:var(--brand);font-weight:800;font-size:11px;" onclick="copy('2204320924441944')">КОПИЯ</span></div>
        <div style="font-size:12px; margin: 10px 0; color:var(--text-dim);">КОММЕНТАРИЙ К ПЛАТЕЖУ (ОБЯЗАТЕЛЬНО):</div>
        <div class="copy-row" style="background:rgba(0,255,136,0.1); border:1px solid var(--brand);">
            <span id="pay_key" style="font-weight:900; letter-spacing:2px;">---</span>
            <span style="color:var(--brand);font-weight:800;font-size:11px;" onclick="copy(document.getElementById('pay_key').innerText)">КОПИЯ</span>
        </div>
        <button class="btn-main" style="background:var(--success); color:#fff; margin-top:15px;" onclick="sendOrder()">Я ОПЛАТИЛ(А)</button>
    </div>

    <!-- Админка -->
    <div class="sheet" id="adminSheet">
        <h2 style="margin-bottom:20px;">Новый товар</h2>
        <input type="text" id="p_name" class="input" placeholder="Название">
        <input type="number" id="p_price" class="input" placeholder="Цена">
        <select id="p_cat" class="input"><option value="Одноразки">Одноразки</option><option value="Жидкости">Жидкости</option><option value="Pod-системы">Pod-системы</option><option value="Расходники">Расходники</option></select>
        <input type="file" id="p_file" accept="image/*" onchange="handleImg(event)">
        <img id="img_p" style="width:60px;height:60px;border-radius:10px;margin-top:10px;display:none;object-fit:cover;border:1px solid var(--brand);">
        <button class="btn-main" id="saveBtn" style="margin-top:20px;" onclick="saveToCloud()">ДОБАВИТЬ В ОБЛАКО</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const MY_ID = "1262669099";
        let products = [];
        let cart = {};
        let activeCat = 'Все';
        let isAdmin = false;
        let pBase64 = '';
        let currentOrderKey = '';

        const seed = [
            { category: 'Одноразки', name: 'HQD Cuvie Plus (1200)', price: 450, img: 'https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200' },
            { category: 'Одноразки', name: 'Elf Bar BC5000', price: 850, img: 'https://images.unsplash.com/photo-1621217743588-3351ecf7b46d?w=200' },
            { category: 'Одноразки', name: 'Lost Mary BM5000', price: 790, img: 'https://images.unsplash.com/photo-1552819056-421622b3818f?w=200' },
            { category: 'Жидкости', name: 'Husky Ice 30ml', price: 450, img: 'https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200' },
            { category: 'Pod-системы', name: 'Vaporesso XROS 3', price: 2850, img: 'https://images.unsplash.com/photo-1552819056-421622b3818f?w=200' },
            { category: 'Расходники', name: 'Картридж XROS 0.6', price: 350, img: 'https://images.unsplash.com/photo-1542385151-efd9000785a0?w=200' }
        ];

        function checkUser() {
            let uId = tg.initDataUnsafe?.user?.id || "";
            if(!uId) {
                try {
                    const h = new URLSearchParams(window.location.hash.slice(1));
                    const data = Object.fromEntries(new URLSearchParams(h.get('tgWebAppData')));
                    uId = JSON.parse(data.user).id;
                } catch(e){}
            }
            if(String(uId) === MY_ID) {
                isAdmin = true;
                document.getElementById('adminBtn').style.display = 'flex';
                return true;
            }
            return false;
        }

        window.addEventListener('vape-ready', () => {
            const { db, appId, methods } = window.VapeCore;
            const coll = methods.collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            
            const isAdm = checkUser();

            methods.onSnapshot(methods.query(coll), async (snap) => {
                let items = snap.docs.map(d => ({ docId: d.id, ...d.data() }));

                // Auto-Seed if empty
                if (items.length === 0 && isAdm) {
                    for(let p of seed) await methods.addDoc(coll, { ...p, createdAt: Date.now() });
                    return;
                }

                products = items.length > 0 ? items : seed;
                render();
                document.getElementById('loader').classList.add('hidden');
            });
        });

        function render() {
            const cats = ['Все', ...new Set(products.map(p => p.category))];
            document.getElementById('categories').innerHTML = cats.map(c => `
                <button class="cat-btn ${c===activeCat?'active':''}" onclick="setCat('${c}')">${c}</button>
            `).join('');

            const grid = document.getElementById('products');
            const filtered = activeCat === 'Все' ? products : products.filter(p => p.category === activeCat);
            
            grid.innerHTML = filtered.map(p => `
                <div class="card">
                    <button class="card-del" onclick="delItem('${p.docId}')"><i data-lucide="trash-2" size="14"></i></button>
                    <img src="${p.img}" class="card-img" onerror="this.src='https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200'">
                    <div class="card-info">
                        <div class="card-name">${p.name}</div>
                        <div class="card-price">${p.price} ₽</div>
                    </div>
                    <button class="btn-buy" onclick="add('${p.docId || p.name}')">В корзину</button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.setCat = (c) => { activeCat = c; render(); };
        window.toggleAdmin = () => { document.body.classList.toggle('admin-mode'); document.getElementById('adminBtn').classList.toggle('active'); document.getElementById('addBtn').style.display = document.body.classList.contains('admin-mode')?'flex':'none'; };
        window.openSheet = (id) => { closeSheets(); document.getElementById(id).classList.add('active'); document.getElementById('overlay').classList.add('active'); };
        window.closeSheets = () => { document.querySelectorAll('.sheet').forEach(s => s.classList.remove('active')); document.getElementById('overlay').classList.remove('active'); };

        window.handleImg = (e) => {
            const f = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => { pBase64 = ev.target.result; const i = document.getElementById('img_p'); i.src = pBase64; i.style.display = 'block'; };
            reader.readAsDataURL(f);
        };

        window.saveToCloud = async () => {
            const n = document.getElementById('p_name').value;
            const p = Number(document.getElementById('p_price').value);
            const c = document.getElementById('p_cat').value;
            if(!n || !p) return;
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; btn.innerText = "...";
            const { db, appId, methods } = window.VapeCore;
            await methods.addDoc(methods.collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), {
                name: n, price: p, category: c, img: pBase64 || seed[0].img, createdAt: Date.now()
            });
            closeSheets();
            document.getElementById('p_name').value = ''; document.getElementById('p_price').value = ''; document.getElementById('img_p').style.display = 'none';
            pBase64 = ''; btn.disabled = false; btn.innerText = "ДОБАВИТЬ В ОБЛАКО";
        };

        window.delItem = async (id) => {
            if(!id) { alert("Сначала дождитесь синхронизации облака"); return; }
            if(!confirm("Удалить?")) return;
            const { db, appId, methods } = window.VapeCore;
            await methods.deleteDoc(methods.doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', id));
            tg.HapticFeedback.impactOccurred('medium');
        };

        window.add = (id) => {
            const p = products.find(x => (x.docId || x.name) === id);
            if(cart[id]) cart[id].qty++; else cart[id] = {...p, qty: 1};
            updateCart();
            tg.HapticFeedback.notificationOccurred('success');
        };

        function updateCart() {
            const items = Object.values(cart);
            const count = items.reduce((a, b) => a + b.qty, 0);
            const total = items.reduce((a, b) => a + (b.price * b.qty), 0);
            document.getElementById('cartFab').classList.toggle('visible', count > 0 && !document.body.classList.contains('admin-mode'));
            document.getElementById('cartCount').innerText = `${count} ТОВАРОВ`;
            document.getElementById('cartTotal').innerText = `${total} ₽`;
            
            const list = document.getElementById('cartList');
            if(items.length === 0) list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-dim)">Корзина пуста</div>`;
            else list.innerHTML = items.map(i => `
                <div class="cart-item">
                    <img src="${i.img}">
                    <div style="flex-grow:1; min-width:0;">
                        <div class="card-name" style="min-height:auto;">${i.name}</div>
                        <div style="color:var(--brand); font-weight:800;">${i.price * i.qty} ₽</div>
                    </div>
                    <div class="item-qty">
                        <button style="background:none; border:none; color:#fff;" onclick="chQty('${i.docId || i.name}', -1)">-</button>
                        <span style="font-weight:800; min-width:20px; text-align:center;">${i.qty}</span>
                        <button style="background:none; border:none; color:#fff;" onclick="chQty('${i.docId || i.name}', 1)">+</button>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        }

        window.chQty = (id, d) => {
            if(cart[id]) { cart[id].qty += d; if(cart[id].qty <= 0) delete cart[id]; updateCart(); tg.HapticFeedback.impactOccurred('light'); }
        };

        window.openPayment = () => {
            if(!document.getElementById('order_name').value || !document.getElementById('order_phone').value) return;
            const total = Object.values(cart).reduce((a, b) => a + (b.price * b.qty), 0);
            document.getElementById('finalTotal').innerText = `${total} ₽`;
            currentOrderKey = 'VX-' + Math.floor(100 + Math.random() * 900);
            document.getElementById('pay_key').innerText = currentOrderKey;
            openSheet('paymentSheet');
        };

        window.copy = (t) => { const e = document.createElement('textarea'); e.value = t; document.body.appendChild(e); e.select(); document.execCommand('copy'); document.body.removeChild(e); tg.HapticFeedback.impactOccurred('medium'); };

        window.sendOrder = () => {
            const total = Object.values(cart).reduce((a, b) => a + (b.price * b.qty), 0);
            const items = Object.values(cart).map(i => `${i.name} (x${i.qty})`).join(', ');
            tg.sendData(JSON.stringify({
                order_key: currentOrderKey, items, total: total + " ₽",
                client: { name: document.getElementById('order_name').value, phone: document.getElementById('order_phone').value, username_or_contact: document.getElementById('order_contact').value, place: document.getElementById('order_loc').value, time: document.getElementById('order_time').value },
                timestamp: new Date().toLocaleString()
            }));
            tg.close();
        };

        window.toggleTheme = () => { document.body.className = document.body.className.includes('toxic') ? 'theme-ice' : document.body.className.includes('ice') ? 'theme-magma' : 'theme-toxic'; };

        setTimeout(() => checkUser(), 500);
        setTimeout(() => checkUser(), 2000);
    </script>
</body>
</html>
