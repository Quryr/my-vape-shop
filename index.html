<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VŒõPOR CLOUD | Cyber Store</title>
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        window.fb = { initializeApp, getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');

        :root {
            --accent: #22c55e;
            --bg: #050505;
            --surface: rgba(20, 20, 20, 0.8);
            --border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: #ffffff;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */
        .cyber-grid {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(to right, rgba(34, 197, 94, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(34, 197, 94, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at 50% 50%, black, transparent 80%);
            z-index: -1;
        }

        .glow-sphere {
            position: fixed;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            filter: blur(120px);
            opacity: 0.1;
            pointer-events: none;
            z-index: -1;
            animation: pulse 10s infinite alternate;
        }

        @keyframes pulse {
            from { transform: translate(-10%, -10%) scale(1); }
            to { transform: translate(10%, 10%) scale(1.2); }
        }

        /* Glassmorphism */
        .glass {
            background: var(--surface);
            backdrop-filter: blur(20px) saturate(160%);
            border: 1px solid var(--border);
        }

        .glass-premium {
            background: linear-gradient(145deg, rgba(30, 30, 30, 0.9), rgba(10, 10, 10, 0.9));
            border: 1px solid rgba(34, 197, 94, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .cat-scroll {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .cat-scroll::-webkit-scrollbar { display: none; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .neo-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .neo-button:active { transform: scale(0.96); }
        .neo-button::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: 0.5s;
        }
        .neo-button:hover::after { transform: translateX(100%); }

        .btn-glow {
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }

        /* –°–ø–µ—Ü-—Å—Ç–∏–ª–∏ –¥–ª—è –ª–æ–∞–¥–µ—Ä–∞ */
        #loader {
            transition: opacity 0.4s ease, visibility 0.4s;
        }

        /* –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
        .product-card {
            display: grid;
            grid-template-rows: auto 1fr auto;
        }
    </style>
</head>
<body class="antialiased">

    <div class="cyber-grid"></div>
    <div class="glow-sphere"></div>

    <!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="loader" class="fixed inset-0 z-[100] bg-[#050505] flex flex-col items-center justify-center">
        <div class="relative">
            <div class="w-20 h-20 border-2 border-green-500/20 rounded-full"></div>
            <div class="absolute inset-0 w-20 h-20 border-t-2 border-green-500 rounded-full animate-spin"></div>
            <i data-lucide="zap" class="absolute inset-0 m-auto w-8 h-8 text-green-500 animate-pulse"></i>
        </div>
        <h2 class="mt-6 font-black italic text-2xl tracking-[0.2em] text-white">VŒõPOR <span class="text-green-500">CLOUD</span></h2>
        <p class="text-[10px] text-white/30 tracking-[0.4em] uppercase mt-2">Initializing System...</p>
    </div>

    <div id="app" class="hidden min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-50 px-6 py-5 glass border-b border-white/5 rounded-b-[2rem]">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="font-black italic text-xl tracking-tighter">VŒõPOR <span class="text-green-500">CLOUD</span></h1>
                    <div id="user-status" class="flex items-center gap-2 mt-1">
                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-ping"></div>
                        <p id="user-display-name" class="text-[10px] text-white/50 uppercase tracking-widest font-bold">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="admin-add-btn" class="hidden w-10 h-10 glass rounded-xl flex items-center justify-center text-green-500 shadow-lg border-green-500/20" onclick="window.ui.toggleModal('add-product-modal')">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                    <button onclick="window.ui.toggleCart(true)" class="relative w-10 h-10 glass rounded-xl flex items-center justify-center">
                        <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                        <span id="cart-count" class="absolute -top-1 -right-1 bg-green-500 text-black text-[10px] font-black w-4 h-4 flex items-center justify-center rounded-full hidden">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Store View -->
        <main id="view-store" class="p-4 pb-32">
            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div class="flex overflow-x-auto cat-scroll gap-2 py-4 mb-2">
                <button onclick="window.ui.setCategory('all')" class="cat-chip px-5 py-2.5 rounded-full glass text-xs font-bold whitespace-nowrap border-green-500/50 text-green-500">–í—Å–µ</button>
                <button onclick="window.ui.setCategory('devices')" class="cat-chip px-5 py-2.5 rounded-full glass text-xs font-bold whitespace-nowrap opacity-40">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
                <button onclick="window.ui.setCategory('disposables')" class="cat-chip px-5 py-2.5 rounded-full glass text-xs font-bold whitespace-nowrap opacity-40">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</button>
                <button onclick="window.ui.setCategory('liquids')" class="cat-chip px-5 py-2.5 rounded-full glass text-xs font-bold whitespace-nowrap opacity-40">–ñ–∏–¥–∫–æ—Å—Ç–∏</button>
            </div>

            <!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
            <div id="product-grid" class="grid grid-cols-2 gap-4">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
            <div id="empty-state" class="hidden py-20 text-center space-y-4">
                <i data-lucide="package-search" class="w-16 h-16 mx-auto text-white/10"></i>
                <p class="text-white/30 font-medium">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã...</p>
            </div>
        </main>

        <!-- Profile View -->
        <main id="view-profile" class="hidden p-6 pb-32 space-y-6">
            <div class="glass-premium rounded-[2.5rem] p-8 text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-6 opacity-10">
                    <i data-lucide="shield-check" class="w-20 h-20"></i>
                </div>
                <div id="profile-avatar-box" class="w-24 h-24 rounded-full glass mx-auto mb-4 flex items-center justify-center border-2 border-green-500/30">
                    <i data-lucide="user" class="w-12 h-12 text-green-500"></i>
                </div>
                <h2 id="p-full-name" class="text-2xl font-black tracking-tight">VŒõPER</h2>
                <p id="p-username" class="text-white/40 text-sm">@username</p>
                <div id="p-rank" class="mt-4 inline-block px-4 py-1 rounded-full bg-green-500/10 border border-green-500/20 text-green-500 text-[10px] font-black uppercase tracking-widest">Standard Client</div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="glass rounded-3xl p-5 border-l-2 border-l-green-500">
                    <p class="text-[10px] text-white/30 uppercase font-bold mb-1">–ó–∞–∫–∞–∑—ã</p>
                    <p class="text-xl font-black">0</p>
                </div>
                <div class="glass rounded-3xl p-5 border-l-2 border-l-blue-500">
                    <p class="text-[10px] text-white/30 uppercase font-bold mb-1">–°–∫–∏–¥–∫–∞</p>
                    <p class="text-xl font-black">5%</p>
                </div>
            </div>

            <button onclick="window.Telegram.WebApp.close()" class="w-full glass p-5 rounded-3xl flex items-center justify-between group active:bg-red-500/10">
                <span class="font-bold">–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</span>
                <i data-lucide="log-out" class="w-5 h-5 text-red-500 group-active:translate-x-1 transition-transform"></i>
            </button>
        </main>

        <!-- Bottom Nav -->
        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md glass rounded-[2rem] p-2 flex items-center justify-between shadow-2xl border-white/10">
            <button onclick="window.ui.switchView('store')" id="nav-store" class="flex-1 flex flex-col items-center py-2 gap-1 text-green-500">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">–ú–∞–≥–∞–∑–∏–Ω</span>
            </button>
            <div class="w-px h-8 bg-white/5"></div>
            <button onclick="window.ui.switchView('profile')" id="nav-profile" class="flex-1 flex flex-col items-center py-2 gap-1 text-white/40">
                <i data-lucide="user-circle" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </button>
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div id="cart-sheet" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-md" onclick="window.ui.toggleCart(false)"></div>
        <div id="cart-content" class="absolute bottom-0 left-0 right-0 glass-premium rounded-t-[3rem] p-8 translate-y-full transition-transform duration-500 flex flex-col max-h-[90vh]">
            <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
            <div class="flex justify-between items-end mb-8">
                <h2 class="text-3xl font-black italic tracking-tighter">–ú–û–Ø <span class="text-green-500">–ö–û–†–ó–ò–ù–ê</span></h2>
                <button onclick="window.ui.toggleCart(false)" class="w-10 h-10 glass rounded-full flex items-center justify-center">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="cart-items" class="flex-grow overflow-y-auto space-y-4 pr-2">
                <!-- Items -->
            </div>

            <div class="mt-8 pt-8 border-t border-white/5 space-y-6">
                <div class="flex justify-between items-center">
                    <span class="text-white/40 font-bold uppercase text-xs">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</span>
                    <span id="cart-total" class="text-2xl font-black text-green-500">0 ‚ÇΩ</span>
                </div>
                <button onclick="window.ui.openCheckout()" class="w-full py-5 bg-green-500 text-black font-black uppercase tracking-[0.2em] rounded-2xl btn-glow neo-button">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="checkout-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-xl"></div>
        <div class="glass-premium relative w-full max-w-sm rounded-[3rem] p-8 text-center">
            <div class="w-20 h-20 bg-green-500/10 rounded-full mx-auto flex items-center justify-center border-2 border-green-500/20 mb-6">
                <i data-lucide="credit-card" class="w-10 h-10 text-green-500"></i>
            </div>
            <h3 class="text-2xl font-black mb-2 uppercase">–û–ø–ª–∞—Ç–∞</h3>
            <p class="text-sm text-white/50 mb-6">–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –Ω–∞ Ozon Bank:</p>
            
            <div class="bg-black/40 rounded-3xl p-6 text-left space-y-4 border border-white/5 mb-8">
                <div>
                    <p class="text-[9px] uppercase text-white/30 font-bold">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</p>
                    <p class="font-mono text-lg tracking-wider text-green-500">2204 3209 2444 1944</p>
                </div>
                <div>
                    <p class="text-[9px] uppercase text-white/30 font-bold">–ö–æ–¥ –∑–∞–∫–∞–∑–∞ (–í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)</p>
                    <p id="order-code" class="text-xl font-black tracking-widest text-white"></p>
                </div>
            </div>

            <button onclick="window.ui.finishOrder()" class="w-full py-4 bg-white text-black font-black uppercase rounded-2xl neo-button">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
        </div>
    </div>

    <div id="add-product-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-black/95" onclick="window.ui.toggleModal('add-product-modal')"></div>
        <div class="glass-premium relative w-full max-w-sm rounded-[3rem] p-8 space-y-4">
            <h3 class="text-xl font-black uppercase">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h3>
            <input id="adm-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl focus:border-green-500 outline-none text-sm">
            <input id="adm-price" type="number" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl focus:border-green-500 outline-none text-sm">
            <select id="adm-cat" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none text-sm text-white/50">
                <option value="devices">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
                <option value="disposables">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</option>
                <option value="liquids">–ñ–∏–¥–∫–æ—Å—Ç–∏</option>
            </select>
            <input id="adm-emoji" type="text" placeholder="–≠–º–æ–¥–∑–∏" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none text-sm">
            <button onclick="window.ui.saveProduct()" class="w-full py-4 bg-green-500 text-black font-black uppercase rounded-2xl shadow-xl">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <script type="module">
        const { initializeApp, getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.fb;

        // Configuration
        const ADMIN_ID = 1262669099;
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'vape-premium-cyber';
        const firebaseConfig = JSON.parse(__firebase_config);

        // State
        let db, auth, user = null;
        let products = [];
        let cart = [];
        let category = 'all';

        window.ui = {
            switchView: (v) => {
                document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
                document.getElementById(`view-${v}`).classList.remove('hidden');
                
                document.querySelectorAll('nav button, [id^="nav-"]').forEach(b => {
                    b.classList.remove('text-green-500');
                    b.classList.add('text-white/40');
                });
                const activeBtn = document.getElementById(`nav-${v}`);
                activeBtn.classList.remove('text-white/40');
                activeBtn.classList.add('text-green-500');
            },

            setCategory: (c) => {
                category = c;
                document.querySelectorAll('.cat-chip').forEach(btn => {
                    btn.classList.add('opacity-40');
                    btn.classList.remove('border-green-500/50', 'text-green-500');
                });
                event.target.classList.remove('opacity-40');
                event.target.classList.add('border-green-500/50', 'text-green-500');
                window.ui.renderProducts();
            },

            toggleCart: (show) => {
                const sheet = document.getElementById('cart-sheet');
                const content = document.getElementById('cart-content');
                if(show) {
                    sheet.classList.remove('hidden');
                    setTimeout(() => content.classList.remove('translate-y-full'), 10);
                    window.ui.renderCart();
                } else {
                    content.classList.add('translate-y-full');
                    setTimeout(() => sheet.classList.add('hidden'), 500);
                }
            },

            addToCart: (id) => {
                const p = products.find(x => x.id === id);
                const exist = cart.find(x => x.id === id);
                if(exist) exist.qty++; else cart.push({...p, qty: 1});
                window.ui.updateCartUI();
                if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            },

            updateQty: (id, delta) => {
                const idx = cart.findIndex(x => x.id === id);
                if(idx === -1) return;
                cart[idx].qty += delta;
                if(cart[idx].qty <= 0) cart.splice(idx, 1);
                window.ui.updateCartUI();
                window.ui.renderCart();
            },

            updateCartUI: () => {
                const count = cart.reduce((a, b) => a + b.qty, 0);
                const badge = document.getElementById('cart-count');
                badge.innerText = count;
                count > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
            },

            renderCart: () => {
                const container = document.getElementById('cart-items');
                if(cart.length === 0) {
                    container.innerHTML = `<div class="py-20 text-center opacity-20"><p class="text-sm font-bold uppercase tracking-widest">–ü—É—Å—Ç–æ</p></div>`;
                } else {
                    container.innerHTML = cart.map(i => `
                        <div class="glass rounded-3xl p-4 flex items-center justify-between border-white/5">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 glass rounded-2xl flex items-center justify-center text-2xl">${i.emoji || 'üí®'}</div>
                                <div>
                                    <p class="font-bold text-sm mb-1">${i.name}</p>
                                    <p class="text-green-500 font-black text-xs">${i.price} ‚ÇΩ</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 bg-white/5 p-1.5 rounded-2xl border border-white/5">
                                <button onclick="window.ui.updateQty('${i.id}', -1)" class="w-8 h-8 flex items-center justify-center text-white/20">-</button>
                                <span class="text-xs font-black w-4 text-center">${i.qty}</span>
                                <button onclick="window.ui.updateQty('${i.id}', 1)" class="w-8 h-8 flex items-center justify-center text-green-500">+</button>
                            </div>
                        </div>
                    `).join('');
                }
                const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
                document.getElementById('cart-total').innerText = `${total} ‚ÇΩ`;
            },

            renderProducts: () => {
                const grid = document.getElementById('product-grid');
                const empty = document.getElementById('empty-state');
                const filtered = category === 'all' ? products : products.filter(p => p.category === category);
                
                if(filtered.length === 0) {
                    grid.classList.add('hidden');
                    empty.classList.remove('hidden');
                } else {
                    grid.classList.remove('hidden');
                    empty.classList.add('hidden');
                    grid.innerHTML = filtered.map(p => `
                        <div class="product-card glass rounded-[2.2rem] p-4 relative group animate-in fade-in slide-in-from-bottom-4 duration-500">
                            ${(user?.id === ADMIN_ID) ? `
                                <button onclick="window.ui.deleteProduct('${p.id}')" class="absolute top-3 right-3 w-8 h-8 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center z-10">
                                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                </button>
                            ` : ''}
                            <div class="aspect-square glass rounded-[1.5rem] mb-4 flex items-center justify-center text-5xl shadow-inner border-white/5 bg-gradient-to-br from-white/5 to-transparent">
                                ${p.emoji || 'üí®'}
                            </div>
                            <div class="px-1 mb-4">
                                <h3 class="font-bold text-[13px] leading-tight text-white/90 line-clamp-2 min-h-[2rem]">${p.name}</h3>
                                <p class="text-green-500 font-black text-lg mt-1">${p.price} ‚ÇΩ</p>
                            </div>
                            <button onclick="window.ui.addToCart('${p.id}')" class="w-full py-3.5 glass rounded-2xl text-[10px] font-black uppercase tracking-widest text-white border-green-500/20 active:bg-green-500 active:text-black transition-all flex items-center justify-center gap-2">
                                <i data-lucide="shopping-cart" class="w-3 h-3"></i> –ö—É–ø–∏—Ç—å
                            </button>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            },

            toggleModal: (id) => document.getElementById(id).classList.toggle('hidden'),

            saveProduct: async () => {
                const name = document.getElementById('adm-name').value;
                const price = Number(document.getElementById('adm-price').value);
                const cat = document.getElementById('adm-cat').value;
                const emoji = document.getElementById('adm-emoji').value;
                if(!name || !price) return;
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'products'), { name, price, category: cat, emoji, ts: Date.now() });
                window.ui.toggleModal('add-product-modal');
                document.getElementById('adm-name').value = '';
                document.getElementById('adm-price').value = '';
            },

            deleteProduct: async (id) => {
                if(confirm("–£–¥–∞–ª–∏—Ç—å?")) await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'products', id));
            },

            openCheckout: () => {
                if(cart.length === 0) return;
                document.getElementById('order-code').innerText = "VX-" + Math.floor(1000 + Math.random() * 9000);
                window.ui.toggleCart(false);
                window.ui.toggleModal('checkout-modal');
            },

            finishOrder: () => {
                const code = document.getElementById('order-code').innerText;
                window.Telegram.WebApp.sendData(JSON.stringify({ code, cart }));
                window.Telegram.WebApp.close();
            }
        };

        // Mutation Observer for icons
        const obs = new MutationObserver(() => lucide.createIcons());
        obs.observe(document.body, { childList: true, subtree: true });

        // App Initialization
        async function init() {
            // Hard hide loader after 4s no matter what
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                }, 500);
            }, 4000);

            const fbApp = initializeApp(firebaseConfig);
            db = getFirestore(fbApp);
            auth = getAuth(fbApp);

            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            // Robust User Detection
            let tgUser = tg.initDataUnsafe?.user;
            if(!tgUser) {
                try {
                    const hash = new URLSearchParams(window.location.hash.slice(1));
                    tgUser = JSON.parse(hash.get('user'));
                } catch(e) {}
            }

            user = tgUser || { id: 0, first_name: "Guest", username: "vaper_guest" };

            // Auth
            if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (fbU) => {
                if(!fbU) return;

                // Sync UI
                document.getElementById('user-display-name').innerText = user.first_name || "Vaper";
                document.getElementById('p-full-name').innerText = (user.first_name + ' ' + (user.last_name || '')).trim();
                document.getElementById('p-username').innerText = user.username ? `@${user.username}` : `ID: ${user.id}`;
                
                if(user.id === ADMIN_ID) {
                    document.getElementById('admin-add-btn').classList.remove('hidden');
                    document.getElementById('p-rank').innerText = "Administrator";
                    document.getElementById('p-rank').classList.replace('text-green-500', 'text-yellow-500');
                }

                // Data Listeners
                onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'products'), (snap) => {
                    products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(products.length === 0) seed();
                    window.ui.renderProducts();
                    
                    // Hide Loader
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loader').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                    }, 500);
                });
            });
        }

        async function seed() {
            const items = [
                {name: "XROS 3 Nano", price: 3490, category: "devices", emoji: "üîã"},
                {name: "Lost Mary 5000", price: 1150, category: "disposables", emoji: "üçì"},
                {name: "Angry Vape - Shark", price: 650, category: "liquids", emoji: "ü¶à"},
                {name: "Smoant Knight 80", price: 4200, category: "devices", emoji: "‚öîÔ∏è"},
                {name: "Elf Bar 10000", price: 1800, category: "disposables", emoji: "üí®"},
                {name: "Maxwell's Shoria", price: 890, category: "liquids", emoji: "‚ùÑÔ∏è"}
            ];
            const col = collection(db, 'artifacts', APP_ID, 'public', 'data', 'products');
            for(const i of items) await addDoc(col, {...i, ts: Date.now()});
        }

        window.onload = init;
    </script>
</body>
</html>
