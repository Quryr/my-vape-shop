<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Vape Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #22c55e; /* Toxic Green */
            --bg-black: #000000;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-black);
            color: white;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ñ–µ—Ä—ã */
        .orb {
            position: fixed;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.3;
            z-index: -1;
            animation: drift 20s infinite alternate ease-in-out;
        }
        .orb-1 { background: var(--primary); top: -50px; left: -50px; }
        .orb-2 { background: #a855f7; bottom: 10%; right: -50px; animation-delay: -5s; }
        .orb-3 { background: #3b82f6; top: 40%; left: 50%; transform: translateX(-50%); animation-delay: -10s; }

        @keyframes drift {
            from { transform: translate(0, 0) scale(1); }
            to { transform: translate(20px, 40px) scale(1.1); }
        }

        .glass {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .theme-toxic { --primary: #22c55e; }
        .theme-ice { --primary: #0ea5e9; }
        .theme-magma { --primary: #f97316; }

        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .border-primary { border-color: var(--primary); }

        .loader-overlay {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
        ::-webkit-scrollbar { width: 0px; }

        .product-card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .product-info {
            flex-grow: 1;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è Bottom Sheet */
        .bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-sheet.active {
            transform: translateY(0);
        }
    </style>

    <script>
        // GLOBAL SAFETY EXIT: –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –∑–∞ 2.5 —Å–µ–∫, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        window.hideLoader = function() {
            const loader = document.getElementById('loader');
            const app = document.getElementById('app');
            if (loader && loader.style.display !== 'none') {
                loader.style.opacity = '0';
                loader.style.visibility = 'hidden';
                setTimeout(() => {
                    loader.style.display = 'none';
                    if (app) app.classList.remove('hidden');
                }, 500);
            }
        };
        setTimeout(window.hideLoader, 2500);
    </script>
</head>
<body class="theme-toxic">
    <!-- Safety Loader -->
    <div id="loader" class="loader-overlay">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin"></div>
            <p class="mt-4 text-sm font-medium tracking-widest uppercase opacity-50">Loading Store</p>
        </div>
    </div>

    <!-- Background Orbs -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <!-- Main Content -->
    <div id="app" class="px-4 pb-24 pt-6 max-w-2xl mx-auto min-h-screen relative z-10 hidden">
        
        <!-- Header -->
        <header class="flex items-center justify-between mb-8">
            <div>
                <h1 id="admin-status" class="text-xs font-bold tracking-[0.2em] text-white/50 mb-1 uppercase">PREMIUM STORE</h1>
                <h2 class="text-2xl font-bold tracking-tight">Vape <span class="text-primary">Cloud</span></h2>
            </div>
            <div class="flex items-center gap-3">
                <!-- Admin Actions -->
                <div id="admin-controls" class="hidden flex items-center gap-2">
                    <button onclick="window.showAdminStats()" class="p-2 glass rounded-xl text-primary">
                        <i data-lucide="shield"></i>
                    </button>
                    <button onclick="window.showAddProduct()" class="p-2 glass rounded-xl text-primary">
                        <i data-lucide="plus"></i>
                    </button>
                </div>
                <!-- Theme Switcher -->
                <button onclick="window.nextTheme()" class="p-2 glass rounded-xl">
                    <i data-lucide="palette"></i>
                </button>
            </div>
        </header>

        <!-- Search & Filter -->
        <div class="flex gap-2 mb-6">
            <div class="flex-grow glass rounded-2xl flex items-center px-4 py-3">
                <i data-lucide="search" class="w-5 h-5 opacity-40 mr-3"></i>
                <input type="text" id="search-input" oninput="window.filterProducts(this.value)" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." class="bg-transparent border-none outline-none w-full text-sm">
            </div>
        </div>

        <!-- Products Grid -->
        <div id="products-grid" class="grid grid-cols-2 gap-3">
            <!-- Skeleton Loader -->
            <div class="glass p-4 rounded-3xl animate-pulse h-64"></div>
            <div class="glass p-4 rounded-3xl animate-pulse h-64"></div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="fixed bottom-4 left-4 right-4 h-16 glass rounded-2xl flex items-center justify-around z-40 px-2 max-w-2xl mx-auto border border-white/10">
        <button class="flex flex-col items-center justify-center w-full gap-1 text-primary">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium uppercase tracking-wider">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button onclick="window.toggleCart()" class="flex flex-col items-center justify-center w-full gap-1 opacity-40 relative">
            <i data-lucide="shopping-cart" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium uppercase tracking-wider">–ö–æ—Ä–∑–∏–Ω–∞</span>
            <div id="cart-badge" class="hidden absolute top-0 right-1/4 bg-primary text-black text-[10px] font-bold px-1.5 rounded-full border-2 border-black">0</div>
        </button>
        <button class="flex flex-col items-center justify-center w-full gap-1 opacity-40">
            <i data-lucide="user" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium uppercase tracking-wider">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
    </nav>

    <!-- Cart Modal (Bottom Sheet) -->
    <div id="cart-sheet" class="fixed inset-0 z-50 pointer-events-none">
        <div id="cart-overlay" onclick="window.toggleCart()" class="absolute inset-0 bg-black/60 opacity-0 transition-opacity pointer-events-none"></div>
        <div class="bottom-sheet absolute bottom-0 left-0 right-0 bg-zinc-950 border-t border-white/10 rounded-t-[32px] max-h-[85vh] flex flex-col pointer-events-auto">
            <div class="w-12 h-1 bg-white/10 rounded-full mx-auto my-4 shrink-0"></div>
            
            <div class="px-6 pb-4 flex items-center justify-between shrink-0">
                <h3 class="text-xl font-bold">–ö–æ—Ä–∑–∏–Ω–∞</h3>
                <button onclick="window.toggleCart()" class="p-2 opacity-50"><i data-lucide="x"></i></button>
            </div>

            <div id="cart-items" class="flex-grow overflow-y-auto px-6 py-2 space-y-4">
                <p class="text-center opacity-30 py-10">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
            </div>

            <div id="cart-footer" class="p-6 glass border-t border-white/10 shrink-0">
                <div class="flex justify-between mb-4">
                    <span class="opacity-50">–ò—Ç–æ–≥–æ:</span>
                    <span id="cart-total" class="text-xl font-bold">0 ‚ÇΩ</span>
                </div>
                <button onclick="window.startCheckout()" class="w-full bg-primary text-black font-bold py-4 rounded-2xl flex items-center justify-center gap-2">
                    –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 z-[60] glass hidden items-center justify-center p-4">
        <div class="bg-zinc-950 border border-white/10 w-full max-w-md rounded-[32px] p-6 flex flex-col gap-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold">–î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                <button onclick="window.closeCheckout()" class="opacity-50"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-3" id="checkout-form">
                <input type="text" id="order-name" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-primary">
                <input type="tel" id="order-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-primary">
                <input type="text" id="order-address" placeholder="–ê–¥—Ä–µ—Å / –†–∞–π–æ–Ω" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-primary">
                <select id="order-time" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-primary">
                    <option value="ASAP">–ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ</option>
                    <option value="18:00-20:00">18:00 - 20:00</option>
                    <option value="20:00-22:00">20:00 - 22:00</option>
                </select>
            </div>

            <button onclick="window.proceedToPayment()" class="w-full bg-primary text-black font-bold py-4 rounded-2xl mt-4">
                –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
            </button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 z-[70] glass hidden items-center justify-center p-4">
        <div class="bg-zinc-950 border border-white/10 w-full max-w-md rounded-[32px] p-8 text-center">
            <div class="w-16 h-16 bg-primary/20 text-primary rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="credit-card" class="w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-bold mb-2">–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h3>
            <p class="text-white/50 text-sm mb-6 leading-relaxed">–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ –Ω–∞ –∫–∞—Ä—Ç—É Ozon Bank. –í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –∑–∞–∫–∞–∑–∞.</p>
            
            <div class="bg-white/5 border border-white/10 rounded-2xl p-5 mb-6 text-left relative">
                <p class="text-[10px] uppercase tracking-widest text-white/30 mb-1">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (Ozon)</p>
                <p class="text-lg font-mono tracking-wider mb-3">2204 3209 2444 1944</p>
                <p class="text-[10px] uppercase tracking-widest text-white/30 mb-1">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</p>
                <p class="text-lg font-medium">Ivan V. R.</p>
                
                <div class="mt-4 pt-4 border-t border-white/5 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] uppercase tracking-widest text-white/30">–ö–æ–¥ –∑–∞–∫–∞–∑–∞</p>
                        <p id="payment-code" class="text-xl font-bold text-primary">VX-404</p>
                    </div>
                    <button onclick="window.copyToClipboard('2204320924441944')" class="p-3 glass rounded-xl active:scale-95 transition-transform">
                        <i data-lucide="copy" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <button onclick="window.confirmOrder()" class="w-full bg-primary text-black font-bold py-4 rounded-2xl">
                –Ø –æ–ø–ª–∞—Ç–∏–ª (–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å)
            </button>
            <button onclick="window.closePayment()" class="w-full py-4 text-white/40 text-sm">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- Admin Add Product Modal -->
    <div id="add-product-modal" class="fixed inset-0 z-[80] glass hidden items-center justify-center p-4">
        <div class="bg-zinc-950 border border-white/10 w-full max-w-md rounded-[32px] p-6">
            <h3 class="text-xl font-bold mb-6">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h3>
            <div class="space-y-4">
                <input type="text" id="p-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. HQD Cuve)" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none">
                <input type="number" id="p-price" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none">
                <input type="text" id="p-image" placeholder="Emoji / –ò–∫–æ–Ω–∫–∞" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none">
                <select id="p-tag" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none">
                    <option value="Disposable">–û–¥–Ω–æ—Ä–∞–∑–∫–∞</option>
                    <option value="Liquid">–ñ–∏–¥–∫–æ—Å—Ç—å</option>
                    <option value="Device">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
                </select>
                <div class="flex gap-3 pt-4">
                    <button onclick="window.closeAddProduct()" class="w-full py-4 text-white/50">–û—Ç–º–µ–Ω–∞</button>
                    <button onclick="window.saveProduct()" class="w-full bg-primary text-black font-bold py-4 rounded-2xl">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth;
        let appId = 'vape-store-default';
        const tg = window.Telegram?.WebApp;

        // Global State
        window.state = {
            products: [],
            filteredProducts: [],
            cart: [],
            user: null,
            isAdmin: false,
            currentTheme: 'toxic',
            orderCode: 'VX-000'
        };

        const ADMIN_DATA = { id: 1262669099, username: "Tru5tNoBody" };

        // Theme Management
        window.nextTheme = () => {
            tg?.HapticFeedback.selectionChanged();
            const themes = ['toxic', 'ice', 'magma'];
            let nextIdx = (themes.indexOf(window.state.currentTheme) + 1) % themes.length;
            window.state.currentTheme = themes[nextIdx];
            document.body.className = `theme-${window.state.currentTheme}`;
        };

        const checkAdmin = (userData) => {
            if (!userData) return false;
            return userData.id === ADMIN_DATA.id || userData.username === ADMIN_DATA.username;
        };

        const recursiveAdminCheck = () => {
            const userData = tg?.initDataUnsafe?.user;
            if (checkAdmin(userData)) {
                window.state.isAdmin = true;
                const controls = document.getElementById('admin-controls');
                if (controls) controls.classList.remove('hidden');
                
                const status = document.getElementById('admin-status');
                if (status) {
                    status.innerText = 'ADMIN MODE';
                    status.classList.add('text-primary');
                }
                renderProducts();
            }
        };

        // Auth
        const initAuth = async () => {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'vape-store-default';

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    window.state.user = user;
                    if (user) {
                        initDataStore();
                    }
                });
            } catch (error) {
                console.error("Auth failed", error);
                window.hideLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            }
        };

        // Firestore
        const initDataStore = () => {
            if (!auth.currentUser) return;

            const q = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            onSnapshot(q, (snapshot) => {
                const products = [];
                snapshot.forEach((doc) => products.push({ id: doc.id, ...doc.data() }));
                window.state.products = products;
                window.state.filteredProducts = products;
                
                if (products.length === 0 && window.state.isAdmin) {
                    seedDatabase();
                }
                renderProducts();
                window.hideLoader(); // –ü—Ä—è—á–µ–º –ª–æ–∞–¥–µ—Ä, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ
            }, (error) => {
                console.error("Firestore error", error);
                window.hideLoader();
            });
        };

        const seedDatabase = async () => {
            if (!auth.currentUser) return;
            const starters = [
                { name: "HQD Cuve Plus", price: 1200, icon: "üí®", tag: "Disposable" },
                { name: "Elf Bar BC5000", price: 1450, icon: "üîã", tag: "Disposable" },
                { name: "Lost Mary OS5000", price: 1500, icon: "üçì", tag: "Disposable" },
                { name: "Vaporesso XROS 3", price: 2800, icon: "‚ö°", tag: "Device" },
                { name: "Brusko Salt Liquid", price: 450, icon: "üíß", tag: "Liquid" },
                { name: "Geekvape Aegis L200", price: 5400, icon: "üõ†Ô∏è", tag: "Device" },
                { name: "HQD Titan", price: 1800, icon: "üå™Ô∏è", tag: "Disposable" },
                { name: "Waka SoPro 10k", price: 2100, icon: "üçá", tag: "Disposable" },
                { name: "Maxwell's Shoria", price: 650, icon: "üå≤", tag: "Liquid" },
                { name: "Voopoo Drag S", price: 3200, icon: "üî•", tag: "Device" },
                { name: "Gang Force 10000", price: 1900, icon: "üëΩ", tag: "Disposable" }
            ];

            const coll = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
            for (const item of starters) {
                await addDoc(coll, item);
            }
        };

        window.filterProducts = (query) => {
            const q = query.toLowerCase();
            window.state.filteredProducts = window.state.products.filter(p => 
                p.name.toLowerCase().includes(q) || p.tag.toLowerCase().includes(q)
            );
            renderProducts();
        };

        const renderProducts = () => {
            const grid = document.getElementById('products-grid');
            if (!grid) return;

            if (window.state.filteredProducts.length === 0) {
                grid.innerHTML = '<div class="col-span-2 text-center py-20 opacity-30">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            grid.innerHTML = window.state.filteredProducts.map(p => `
                <div class="product-card glass p-4 rounded-[28px] relative overflow-hidden group">
                    ${window.state.isAdmin ? `
                        <button onclick="window.deleteProduct('${p.id}')" class="absolute top-2 right-2 p-2 bg-red-500/20 text-red-500 rounded-lg z-20">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    ` : ''}
                    <div class="product-info">
                        <div class="w-full aspect-square bg-white/5 rounded-2xl flex items-center justify-center text-5xl mb-4 group-hover:scale-110 transition-transform duration-500">
                            ${p.icon || 'üí®'}
                        </div>
                        <span class="text-[10px] uppercase tracking-widest text-primary font-bold mb-1 block">${p.tag || 'NEW'}</span>
                        <h3 class="font-bold text-sm leading-tight mb-2">${p.name}</h3>
                    </div>
                    <div class="mt-2 flex items-center justify-between">
                        <span class="font-bold text-lg">${p.price} ‚ÇΩ</span>
                        <button onclick="window.addToCart('${p.id}')" class="bg-primary text-black p-2.5 rounded-xl active:scale-90 transition-transform">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        };

        window.addToCart = (id) => {
            tg?.HapticFeedback.notificationOccurred('success');
            const product = window.state.products.find(p => p.id === id);
            const inCart = window.state.cart.find(item => item.id === id);
            
            if (inCart) {
                inCart.qty++;
            } else {
                window.state.cart.push({ ...product, qty: 1 });
            }
            updateCartUI();
        };

        window.updateQty = (id, delta) => {
            const item = window.state.cart.find(i => i.id === id);
            if (item) {
                item.qty += delta;
                if (item.qty <= 0) {
                    window.state.cart = window.state.cart.filter(i => i.id !== id);
                }
                updateCartUI();
            }
        };

        const updateCartUI = () => {
            const badge = document.getElementById('cart-badge');
            const totalCount = window.state.cart.reduce((sum, i) => sum + i.qty, 0);
            
            if (totalCount > 0) {
                badge.innerText = totalCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            const itemsContainer = document.getElementById('cart-items');
            if (window.state.cart.length === 0) {
                itemsContainer.innerHTML = '<p class="text-center opacity-30 py-10">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
            } else {
                itemsContainer.innerHTML = window.state.cart.map(item => `
                    <div class="flex items-center gap-4 bg-white/5 p-4 rounded-2xl">
                        <div class="w-12 h-12 glass rounded-xl flex items-center justify-center text-xl">${item.icon}</div>
                        <div class="flex-grow">
                            <h4 class="text-sm font-bold">${item.name}</h4>
                            <p class="text-xs opacity-50">${item.price} ‚ÇΩ</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="window.updateQty('${item.id}', -1)" class="w-8 h-8 glass rounded-lg flex items-center justify-center">-</button>
                            <span class="text-sm font-bold">${item.qty}</span>
                            <button onclick="window.updateQty('${item.id}', 1)" class="w-8 h-8 glass rounded-lg flex items-center justify-center">+</button>
                        </div>
                    </div>
                `).join('');
            }

            const totalAmount = window.state.cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            document.getElementById('cart-total').innerText = `${totalAmount} ‚ÇΩ`;
            lucide.createIcons();
        };

        window.toggleCart = () => {
            tg?.HapticFeedback.impactOccurred('medium');
            const sheet = document.getElementById('cart-sheet');
            const overlay = document.getElementById('cart-overlay');
            const content = sheet.querySelector('.bottom-sheet');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                overlay.classList.add('opacity-0');
                setTimeout(() => {
                    sheet.classList.add('pointer-events-none');
                    overlay.classList.add('pointer-events-none');
                }, 300);
            } else {
                sheet.classList.remove('pointer-events-none');
                overlay.classList.remove('pointer-events-none');
                overlay.classList.remove('opacity-0');
                content.classList.add('active');
            }
        };

        window.startCheckout = () => {
            if (window.state.cart.length === 0) return;
            window.toggleCart();
            document.getElementById('checkout-modal').classList.remove('hidden');
            document.getElementById('checkout-modal').classList.add('flex');
        };

        window.closeCheckout = () => {
            document.getElementById('checkout-modal').classList.add('hidden');
        };

        window.proceedToPayment = () => {
            const name = document.getElementById('order-name').value;
            const phone = document.getElementById('order-phone').value;
            const address = document.getElementById('order-address').value;
            
            if (!name || !phone || !address) {
                tg?.HapticFeedback.notificationOccurred('error');
                return;
            }

            window.state.orderCode = `VX-${Math.floor(100 + Math.random() * 899)}`;
            document.getElementById('payment-code').innerText = window.state.orderCode;
            document.getElementById('checkout-modal').classList.add('hidden');
            document.getElementById('payment-modal').classList.remove('hidden');
            document.getElementById('payment-modal').classList.add('flex');
        };

        window.confirmOrder = () => {
            tg?.HapticFeedback.notificationOccurred('success');
            const order = {
                code: window.state.orderCode,
                items: window.state.cart,
                total: document.getElementById('cart-total').innerText,
                customer: {
                    name: document.getElementById('order-name').value,
                    phone: document.getElementById('order-phone').value,
                    address: document.getElementById('order-address').value,
                    time: document.getElementById('order-time').value,
                    username: tg?.initDataUnsafe?.user?.username || 'N/A'
                }
            };
            
            tg?.sendData(JSON.stringify(order));
            tg?.close();
        };

        window.closePayment = () => {
            document.getElementById('payment-modal').classList.add('hidden');
        };

        window.copyToClipboard = (text) => {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            tg?.HapticFeedback.impactOccurred('light');
        };

        window.deleteProduct = async (id) => {
            if (!auth.currentUser) return;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', id));
                tg?.HapticFeedback.notificationOccurred('warning');
            } catch (e) { console.error(e); }
        };

        window.showAddProduct = () => {
            document.getElementById('add-product-modal').classList.remove('hidden');
            document.getElementById('add-product-modal').classList.add('flex');
        };

        window.closeAddProduct = () => {
            document.getElementById('add-product-modal').classList.add('hidden');
        };

        window.saveProduct = async () => {
            if (!auth.currentUser) return;
            const name = document.getElementById('p-name').value;
            const price = parseInt(document.getElementById('p-price').value);
            const icon = document.getElementById('p-image').value;
            const tag = document.getElementById('p-tag').value;

            if (!name || isNaN(price)) return;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), {
                    name, price, icon, tag
                });
                window.closeAddProduct();
                tg?.HapticFeedback.notificationOccurred('success');
            } catch (e) { console.error(e); }
        };

        // App Initialization
        window.onload = () => {
            tg?.ready();
            tg?.expand();
            initAuth();
            recursiveAdminCheck();
            setTimeout(recursiveAdminCheck, 500);
            setTimeout(recursiveAdminCheck, 2000);
            lucide.createIcons();
        };
    </script>
</body>
</html>
