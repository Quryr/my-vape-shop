<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Vape Store</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.VapeDB = { 
            db, auth, appId, 
            fs: { collection, doc, onSnapshot, addDoc, deleteDoc, query, getDocs, signInAnonymously, signInWithCustomToken, onAuthStateChanged } 
        };

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                window.dispatchEvent(new Event('vape-auth-ready'));
            } catch (e) {
                console.error("Auth failed:", e);
            }
        };
        initAuth();
    </script>
    <style>
        :root {
            --brand-color: #00ff88;
            --brand-glow: rgba(0, 255, 136, 0.4);
            --bg-dark: #050505;
            --glass: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --error: #ff4444;
            --success: #00c853;
        }

        .theme-ice { --brand-color: #00d1ff; --brand-glow: rgba(0, 209, 255, 0.4); }
        .theme-magma { --brand-color: #ff6b00; --brand-glow: rgba(255, 107, 0, 0.4); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background-color: var(--bg-dark); color: var(--text-main); overflow-x: hidden; width: 100vw; min-height: 100vh; }

        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; background: radial-gradient(circle at center, #111 0%, #000 100%); }
        .orb { position: absolute; width: 300px; height: 300px; border-radius: 50%; filter: blur(80px); opacity: 0.3; transition: background var(--transition); }
        .orb-1 { background: var(--brand-color); top: -50px; right: -50px; animation: float 20s infinite alternate; }
        .orb-2 { background: #4a00ff; bottom: -50px; left: -50px; animation: float 25s infinite alternate-reverse; }
        @keyframes float { 0% { transform: translate(0, 0) scale(1); } 50% { transform: translate(30px, 50px) scale(1.1); } 100% { transform: translate(-20px, 30px) scale(0.9); } }

        header {
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; backdrop-filter: blur(15px);
            background: rgba(5, 5, 5, 0.6); border-bottom: 1px solid var(--glass-border);
        }
        .logo { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .header-btns { display: flex; gap: 8px; }
        .icon-btn {
            background: var(--glass); border: 1px solid var(--glass-border); color: var(--text-main);
            padding: 8px; border-radius: 12px; cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;
        }
        #adminBtn { display: none; } 
        .icon-btn.active { background: var(--brand-color); color: var(--bg-dark); }
        #addBtn { display: none; background: var(--brand-color); color: var(--bg-dark); border-color: var(--brand-color); }

        .categories-container { padding: 12px 0; overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
        .categories-inner { display: inline-flex; gap: 10px; padding: 10px 20px 25px 20px; align-items: center; }
        .category-btn {
            background: var(--glass); border: none; color: var(--text-muted); padding: 10px 18px;
            border-radius: 20px; font-size: 14px; font-weight: 500; position: relative; transition: var(--transition); outline: none;
        }
        .category-btn.active { color: var(--text-main); background: rgba(255, 255, 255, 0.08); }
        .category-btn.active::after { content: ''; position: absolute; inset: 0; border-radius: 20px; background: var(--brand-color); filter: blur(15px); opacity: 0.5; z-index: -1; }

        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 0 16px 120px 16px; width: 100%; }
        .product-card {
            background: var(--glass); border: 1px solid var(--glass-border); backdrop-filter: blur(10px);
            border-radius: 22px; padding: 10px; display: flex; flex-direction: column; gap: 8px;
            animation: fadeIn 0.4s ease forwards; min-width: 0; position: relative;
        }
        .delete-card-btn {
            position: absolute; top: 10px; right: 10px; background: var(--error);
            color: white; border: none; width: 28px; height: 28px; border-radius: 8px;
            display: none; align-items: center; justify-content: center; z-index: 10;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .product-img { width: 100%; aspect-ratio: 1/1; border-radius: 16px; background: rgba(255,255,255,0.03); object-fit: cover; padding: 6px; }
        .product-info { display: flex; flex-direction: column; gap: 2px; padding: 0 4px; }
        .product-name { font-size: 13px; font-weight: 500; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-price { font-size: 15px; font-weight: 700; color: var(--brand-color); }
        .add-btn { background: var(--text-main); color: var(--bg-dark); border: none; padding: 12px; border-radius: 14px; font-weight: 600; font-size: 12px; width: 100%; cursor: pointer; transition: var(--transition); }

        .cart-fab {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(120px);
            width: calc(100% - 32px); max-width: 450px; background: var(--brand-color);
            color: var(--bg-dark); height: 64px; border-radius: 22px; display: flex;
            align-items: center; justify-content: space-between; padding: 0 24px; font-weight: 700;
            box-shadow: 0 10px 40px var(--brand-glow); z-index: 200; transition: transform 0.5s;
        }
        .cart-fab.visible { transform: translateX(-50%) translateY(0); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 300; opacity: 0; visibility: hidden; transition: var(--transition); }
        .overlay.active { opacity: 1; visibility: visible; }
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #0d0d0d;
            border-top: 1px solid var(--glass-border); border-radius: 28px 28px 0 0;
            z-index: 301; transform: translateY(100%); transition: transform 0.4s;
            max-height: 85vh; display: flex; flex-direction: column; padding: 20px;
        }
        .bottom-sheet.active { transform: translateY(0); }
        .form-input { width: 100%; background: var(--glass); border: 1px solid var(--glass-border); color: white; padding: 14px; border-radius: 14px; margin-bottom: 12px; outline: none; font-size: 15px; }
        
        .file-upload-container {
            width: 100%; background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 14px; padding: 15px; text-align: center; margin-bottom: 15px;
            cursor: pointer; position: relative;
        }
        .file-upload-preview { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; margin: 10px auto; display: none; border: 1px solid var(--brand-color); }
        #p_file { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        .checkout-btn { background: var(--brand-color); color: var(--bg-dark); border: none; width: 100%; padding: 18px; border-radius: 18px; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .checkout-btn:active { transform: scale(0.98); }

        .payment-info { background: rgba(255,255,255,0.03); border: 1px dashed var(--brand-color); border-radius: 16px; padding: 20px; text-align: center; margin: 10px 0; }
        .price-tag { font-size: 28px; font-weight: 800; color: var(--brand-color); margin: 10px 0; }
        .copy-info-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 12px; margin-bottom: 8px; font-size: 14px; border: 1px solid var(--glass-border); }
        .copy-btn { color: var(--brand-color); font-size: 11px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .payment-key { color: var(--brand-color); font-size: 22px; font-weight: 800; letter-spacing: 2px; }

        /* Admin Setup Banner */
        .admin-setup-btn { background: var(--brand-color); color: #000; padding: 12px; border-radius: 12px; font-weight: 700; margin: 10px 16px; display: none; text-align: center; cursor: pointer; }

        body.admin-mode .delete-card-btn { display: flex !important; }
        body:not(.admin-mode) .delete-card-btn { display: none !important; }
        body.admin-mode .cart-fab { display: none !important; }

        @media (max-width: 360px) { .product-name { font-size: 12px; } .products-grid { gap: 8px; padding: 0 12px 100px 12px; } }
    </style>
</head>
<body class="theme-toxic">

    <div class="background-container">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <header>
        <div class="logo">
            <i data-lucide="zap" fill="var(--brand-color)" color="var(--brand-color)" size="22"></i>
            VAPE CLOUD
        </div>
        <div class="header-btns">
            <button class="icon-btn" id="addBtn" onclick="openAdminForm()">
                <i data-lucide="plus" size="22"></i>
            </button>
            <button class="icon-btn" id="adminBtn" onclick="toggleAdminMode()">
                <i data-lucide="shield" size="20"></i>
            </button>
            <button class="icon-btn" onclick="toggleTheme()">
                <i data-lucide="palette" size="20"></i>
            </button>
        </div>
    </header>

    <div id="adminSetup" class="admin-setup-btn" onclick="seedDatabase()">üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É —Ç–æ–≤–∞—Ä–æ–≤ (–û–¥–∏–Ω —Ä–∞–∑)</div>

    <div class="categories-container">
        <div class="categories-inner" id="categories"></div>
    </div>

    <div class="products-grid" id="products"></div>

    <div class="cart-fab" id="cartFab" onclick="toggleCart(true)">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i data-lucide="shopping-cart" size="20"></i>
            <span id="cartCount">0 –¢–û–í–ê–†–û–í</span>
        </div>
        <span id="cartTotal">0 ‚ÇΩ</span>
    </div>

    <div class="overlay" id="overlay" onclick="closeSheets()"></div>

    <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
    <div class="bottom-sheet" id="cartSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="font-size: 18px;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
            <button class="icon-btn" style="border:none; background:transparent" onclick="toggleCart(false)">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div id="cartList" style="overflow-y:auto; flex-grow:1; margin-bottom:20px;"></div>
        <button class="checkout-btn" onclick="openOrderForm()">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é</button>
    </div>

    <!-- –§–æ—Ä–º–∞ –ó–∞–∫–∞–∑–∞ -->
    <div class="bottom-sheet" id="orderSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="font-size: 18px;">–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞</h2>
            <button class="icon-btn" style="border:none; background:transparent" onclick="toggleCart(true)">
                <i data-lucide="arrow-left"></i>
            </button>
        </div>
        <div style="flex-grow:1; overflow-y:auto;">
            <input type="text" id="order_name" class="form-input" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="tel" id="order_phone" class="form-input" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
            <input type="text" id="order_contact" class="form-input" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¢–ì @—é–∑ –∏–ª–∏ –¥—Ä)">
            
            <div style="margin-bottom: 8px; font-size: 12px; color: var(--text-muted); margin-left: 5px;">–ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏:</div>
            <input type="text" id="order_location" class="form-input" placeholder="–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏">

            <div style="margin-bottom: 8px; font-size: 12px; color: var(--text-muted); margin-left: 5px;">–£–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –í–∞—Å:</div>
            <select id="order_time" class="form-input">
                <option value="6:00 - 12:00">6:00 - 12:00</option>
                <option value="14:00 - 20:00">14:00 - 20:00</option>
            </select>
        </div>
        <button class="checkout-btn" onclick="openPaymentSheet()">–ö –æ–ø–ª–∞—Ç–µ</button>
    </div>

    <!-- –û–ø–ª–∞—Ç–∞ -->
    <div class="bottom-sheet" id="paymentSheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="font-size: 18px;">–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h2>
            <i data-lucide="x" onclick="closeSheets()" style="cursor:pointer"></i>
        </div>
        <div style="text-align: center; flex-grow:1; overflow-y: auto;">
            <div style="font-size: 13px; color: var(--text-muted)">–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É Ozon –ë–∞–Ω–∫–∞:</div>
            <div class="price-tag" id="finalPrice">0 ‚ÇΩ</div>
            <div class="payment-info">
                <div style="font-weight: 700; margin-bottom: 12px; font-size: 14px; text-transform: uppercase; color: var(--brand-color)">Ozon –ë–∞–Ω–∫</div>
                <div class="copy-info-row">
                    <span style="font-family: monospace; font-size: 15px; font-weight: 600;">2204 3209 2444 1944</span>
                    <span class="copy-btn" onclick="copyText('2204320924441944')">–ö–û–ü–ò–†–û–í–ê–¢–¨</span>
                </div>
                <div style="font-size: 12px; margin: 15px 0 10px 0; color: var(--text-muted);">–£–ö–ê–ñ–ò–¢–ï –í –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ö–õ–Æ–ß:</div>
                <div class="copy-info-row" style="background: rgba(0,255,136,0.1); border: 1px solid var(--brand-color);">
                    <span class="payment-key" id="order_key">---</span>
                    <span class="copy-btn" onclick="copyGeneratedKey()">–ö–û–ü–ò–†–û–í–ê–¢–¨</span>
                </div>
                <div style="font-size: 12px; margin-top: 15px; color: var(--text-main);">–ü–æ–ª—É—á–∞—Ç–µ–ª—å: <b>–ò–≤–∞–Ω –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á –†.</b></div>
            </div>
        </div>
        <button class="checkout-btn" id="finishBtn" style="background: var(--success); color: white; margin-top: 10px;" onclick="finishOrder()">–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)</button>
    </div>

    <!-- –§–æ—Ä–º–∞ –ê–¥–º–∏–Ω–∞ -->
    <div class="bottom-sheet" id="adminForm">
        <h2 style="margin-bottom:20px; font-size: 18px;">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h2>
        <input type="text" id="p_name" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <input type="number" id="p_price" class="form-input" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)">
        <select id="p_cat" class="form-input">
            <option value="–û–¥–Ω–æ—Ä–∞–∑–∫–∏">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</option>
            <option value="–ñ–∏–¥–∫–æ—Å—Ç–∏">–ñ–∏–¥–∫–æ—Å—Ç–∏</option>
            <option value="Pod-—Å–∏—Å—Ç–µ–º—ã">Pod-—Å–∏—Å—Ç–µ–º—ã</option>
            <option value="–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</option>
        </select>
        <div class="file-upload-container">
            <i data-lucide="image" size="24" style="color:var(--brand-color)"></i>
            <div style="font-size: 13px; margin-top: 5px; color:var(--text-muted)" id="uploadText">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏</div>
            <img id="imagePreview" class="file-upload-preview">
            <input type="file" id="p_file" accept="image/*" onchange="handleImageSelect(event)">
        </div>
        <button class="checkout-btn" id="saveProductBtn" onclick="adminAddProduct()">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const MY_ADMIN_ID = 1262669099;
        
        let products = [];
        let cart = {};
        let activeCategory = '–í—Å–µ';
        let isAdminMode = false;
        let currentThemeIndex = 0;
        const themes = ['toxic', 'ice', 'magma'];
        let selectedBase64 = '';
        let currentOrderKey = '';
        let isUsingCloud = false;

        const initialSeed = [
            { id: 's1', category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', name: 'HQD Cuvie Plus (1200)', price: 450, img: 'https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200' },
            { id: 's2', category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', name: 'Elf Bar BC5000', price: 850, img: 'https://images.unsplash.com/photo-1621217743588-3351ecf7b46d?w=200' },
            { id: 's3', category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', name: 'Lost Mary BM5000', price: 790, img: 'https://images.unsplash.com/photo-1552819056-421622b3818f?w=200' },
            { id: 's4', category: '–û–¥–Ω–æ—Ä–∞–∑–∫–∏', name: 'Waka SoPro 10000', price: 1350, img: 'https://images.unsplash.com/photo-1542385151-efd9000785a0?w=200' },
            { id: 's5', category: '–ñ–∏–¥–∫–æ—Å—Ç–∏', name: 'Husky Ice 30ml', price: 450, img: 'https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200' },
            { id: 's6', category: '–ñ–∏–¥–∫–æ—Å—Ç–∏', name: 'Maxwell\'s Shoria 30ml', price: 650, img: 'https://images.unsplash.com/photo-1621217743588-3351ecf7b46d?w=200' },
            { id: 's7', category: '–ñ–∏–¥–∫–æ—Å—Ç–∏', name: 'Boshki Strong 30ml', price: 490, img: 'https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200' },
            { id: 's8', category: 'Pod-—Å–∏—Å—Ç–µ–º—ã', name: 'Vaporesso XROS 3', price: 2850, img: 'https://images.unsplash.com/photo-1552819056-421622b3818f?w=200' },
            { id: 's9', category: 'Pod-—Å–∏—Å—Ç–µ–º—ã', name: 'Charon Baby Plus', price: 2400, img: 'https://images.unsplash.com/photo-1614264624108-01127027e8ea?w=200' },
            { id: 's10', category: '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', name: '–ö–∞—Ä—Ç—Ä–∏–¥–∂ XROS 0.6', price: 350, img: 'https://images.unsplash.com/photo-1542385151-efd9000785a0?w=200' },
            { id: 's11', category: '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', name: '–ò—Å–ø–∞—Ä–∏—Ç–µ–ª—å PnP-VM1', price: 250, img: 'https://images.unsplash.com/photo-1614264624108-01127027e8ea?w=200' }
        ];

        function checkAdminAccess() {
            // –ò—â–µ–º ID –≤ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞
            let userId = tg.initDataUnsafe?.user?.id;
            
            // –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –ø—Ä–æ–±—É–µ–º –≤—ã—Ç–∞—â–∏—Ç—å –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL –≤—Ä—É—á–Ω—É—é
            if (!userId) {
                try {
                    const params = new URLSearchParams(window.location.hash.substring(1));
                    const userStr = params.get('user');
                    if (userStr) userId = JSON.parse(userStr).id;
                } catch(e) {}
            }

            if (userId && String(userId) === String(MY_ADMIN_ID)) {
                document.getElementById('adminBtn').style.display = 'flex';
                return true;
            }
            return false;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ä–∞–∑—É
        products = [...initialSeed];
        renderAll();

        window.addEventListener('vape-auth-ready', () => {
            const { auth, fs, db, appId } = window.VapeDB;
            const isAdmin = checkAdminAccess();

            const q = fs.query(fs.collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'));
            fs.onSnapshot(q, (snapshot) => {
                const dbItems = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                
                // –ï—Å–ª–∏ –æ–±–ª–∞–∫–æ –æ—Ç–¥–∞–ª–æ –•–û–¢–Ø –ë–´ –û–î–ò–ù —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –º—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –æ–±–ª–∞–∫–µ.
                // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π, –Ω–æ –º—ã –ü–ï–†–ï–®–õ–ò –≤ –æ–±–ª–∞–∫–æ (—É–∂–µ —É–¥–∞–ª–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä) ‚Äî –º—ã –≤ –æ–±–ª–∞–∫–µ.
                if (dbItems.length > 0 || isUsingCloud) {
                    isUsingCloud = true;
                    products = dbItems;
                    document.getElementById('adminSetup').style.display = 'none';
                } else {
                    // –ë–∞–∑–∞ –ü–£–°–¢–ê –∏ –º—ã –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ–±–ª–∞–∫–æ–º.
                    products = [...initialSeed];
                    if(isAdmin) document.getElementById('adminSetup').style.display = 'block';
                }
                renderAll();
            });
        });

        [100, 1000, 3000].forEach(ms => setTimeout(checkAdminAccess, ms));

        function renderAll() { renderCategories(); renderProducts(); lucide.createIcons(); }

        function renderCategories() {
            let cats = [...new Set(products.map(p => p.category))];
            if (cats.length === 0) cats = ['–û–¥–Ω–æ—Ä–∞–∑–∫–∏', '–ñ–∏–¥–∫–æ—Å—Ç–∏', 'Pod-—Å–∏—Å—Ç–µ–º—ã', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'];
            if (!cats.includes('–í—Å–µ')) cats.unshift('–í—Å–µ');
            const container = document.getElementById('categories');
            if(container) container.innerHTML = cats.map(cat => `<button class="category-btn ${cat === activeCategory ? 'active' : ''}" onclick="setCategory('${cat}')">${cat}</button>`).join('');
        }

        function renderProducts() {
            const filtered = activeCategory === '–í—Å–µ' ? products : products.filter(p => p.category === activeCategory);
            const container = document.getElementById('products');
            if(!container) return;
            if (filtered.length === 0) {
                container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:40px; color:var(--text-muted)">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>`;
                return;
            }
            container.innerHTML = filtered.map(p => {
                const id = p.docId || p.id;
                return `
                <div class="product-card">
                    <button class="delete-card-btn" onclick="deleteItem('${id}', ${!!p.docId})"><i data-lucide="trash-2" size="14"></i></button>
                    <img src="${p.img}" class="product-img" onerror="this.src='https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200'">
                    <div class="product-info">
                        <span class="product-name">${p.name}</span>
                        <span class="product-price">${p.price} ‚ÇΩ</span>
                    </div>
                    <button class="add-btn" onclick="addToCart('${id}')">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        window.setCategory = (cat) => { tg.HapticFeedback.selectionChanged(); activeCategory = cat; renderAll(); };
        window.toggleTheme = () => {
            tg.HapticFeedback.impactOccurred('medium');
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            document.body.className = `theme-${themes[currentThemeIndex]} ${isAdminMode ? 'admin-mode' : ''}`;
        };
        window.toggleAdminMode = () => {
            isAdminMode = !isAdminMode;
            document.body.classList.toggle('admin-mode', isAdminMode);
            document.getElementById('adminBtn').classList.toggle('active', isAdminMode);
            document.getElementById('addBtn').style.display = isAdminMode ? 'flex' : 'none';
            renderAll();
        };

        window.openAdminForm = () => { document.getElementById('adminForm').classList.add('active'); document.getElementById('overlay').classList.add('active'); };

        window.handleImageSelect = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedBase64 = e.target.result;
                document.getElementById('imagePreview').src = selectedBase64;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        // –ü–ï–†–ï–ù–û–° –°–¢–ê–†–¢–û–í–û–ì–û –°–ü–ò–°–ö–ê –í –û–ë–õ–ê–ö–û
        window.seedDatabase = async () => {
            if (!window.VapeDB || !confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –≤ –æ–±–ª–∞–∫–æ?")) return;
            const { db, fs, appId } = window.VapeDB;
            const setupBtn = document.getElementById('adminSetup');
            setupBtn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            try {
                for (const p of initialSeed) {
                    await fs.addDoc(fs.collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), { 
                        name: p.name, price: p.price, category: p.category, img: p.img, createdAt: Date.now() 
                    });
                }
                isUsingCloud = true;
                setupBtn.style.display = 'none';
                tg.HapticFeedback.notificationOccurred('success');
            } catch(e) { console.error(e); }
        };

        window.adminAddProduct = async () => {
            if (!window.VapeDB) return;
            const { db, fs, appId } = window.VapeDB;
            const name = document.getElementById('p_name').value;
            const price = Number(document.getElementById('p_price').value);
            const category = document.getElementById('p_cat').value;
            const img = selectedBase64 || 'https://images.unsplash.com/photo-1574521409219-948cca49f565?w=200';
            if (!name || !price) return;
            
            isUsingCloud = true; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –æ–±–ª–∞–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
            try {
                await fs.addDoc(fs.collection(db, 'artifacts', appId, 'public', 'data', 'vape_items'), { name, price, category, img, createdAt: Date.now() });
                resetAdminForm(); closeSheets();
                tg.HapticFeedback.notificationOccurred('success');
            } catch (e) { console.error(e); }
        };

        function resetAdminForm() {
            document.getElementById('p_name').value = ''; document.getElementById('p_price').value = ''; 
            document.getElementById('imagePreview').style.display = 'none'; selectedBase64 = '';
        }

        window.deleteItem = async (id, isFromDB) => {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?")) return;
            tg.HapticFeedback.impactOccurred('medium');
            
            if (isFromDB && window.VapeDB) {
                const { db, fs, appId } = window.VapeDB;
                try {
                    await fs.deleteDoc(fs.doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', id));
                } catch (e) { console.error(e); }
            } else {
                // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Å–µ—Å—Å–∏–∏ –¥–ª—è seed-—Ç–æ–≤–∞—Ä–æ–≤
                products = products.filter(p => p.id !== id);
                renderAll();
            }
        };

        window.addToCart = (id) => {
            const p = products.find(x => (x.docId || x.id) === id);
            if (!p) return;
            tg.HapticFeedback.notificationOccurred('success');
            if (cart[id]) cart[id].qty++;
            else cart[id] = { ...p, qty: 1 };
            updateCartUI();
        };

        window.updateCartUI = () => {
            const items = Object.values(cart);
            const count = items.reduce((a, b) => a + b.qty, 0);
            const total = items.reduce((a, b) => a + (b.price * b.qty), 0);
            const fab = document.getElementById('cartFab');
            if(fab) fab.classList.toggle('visible', count > 0 && !isAdminMode);
            document.getElementById('cartCount').innerText = `${count} –¢–û–í.`;
            document.getElementById('cartTotal').innerText = `${total} ‚ÇΩ`;
            const list = document.getElementById('cartList');
            if(!list) return;
            if (items.length === 0) { list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted)">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>`; }
            else {
                list.innerHTML = items.map(item => {
                    const id = item.docId || item.id;
                    return `
                    <div style="display:flex; align-items:center; gap:12px; background:var(--glass); padding:10px; border-radius:18px; margin-bottom:10px;">
                        <img src="${item.img}" style="width:40px; height:40px; border-radius:10px; object-fit:cover;">
                        <div style="flex-grow:1; min-width:0">
                            <div style="font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${item.name}</div>
                            <div style="color:var(--brand-color); font-weight:700">${item.price * item.qty} ‚ÇΩ</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:12px;">
                            <button onclick="changeQty('${id}', -1)" style="background:none; border:none; color:white; display:flex;"><i data-lucide="minus" size="14"></i></button>
                            <span style="font-size:14px; min-width:15px; text-align:center">${item.qty}</span>
                            <button onclick="changeQty('${id}', 1)" style="background:none; border:none; color:white; display:flex;"><i data-lucide="plus" size="14"></i></button>
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            }
        };

        window.changeQty = (id, delta) => {
            tg.HapticFeedback.impactOccurred('light');
            if (cart[id]) { cart[id].qty += delta; if (cart[id].qty <= 0) delete cart[id]; updateCartUI(); }
        };

        window.openOrderForm = () => { closeSheets(); document.getElementById('orderSheet').classList.add('active'); document.getElementById('overlay').classList.add('active'); };
        window.openPaymentSheet = () => {
            const name = document.getElementById('order_name').value;
            const phone = document.getElementById('order_phone').value;
            const contact = document.getElementById('order_contact').value;
            const loc = document.getElementById('order_location').value;
            if (!name || !phone || !contact || !loc) { tg.HapticFeedback.notificationOccurred('error'); return; }
            const total = Object.values(cart).reduce((a, b) => a + (b.price * b.qty), 0);
            document.getElementById('finalPrice').innerText = `${total} ‚ÇΩ`;
            currentOrderKey = 'VX-' + Math.floor(100 + Math.random() * 900);
            document.getElementById('order_key').innerText = currentOrderKey;
            closeSheets();
            document.getElementById('paymentSheet').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        };

        window.copyText = (text) => {
            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el); tg.HapticFeedback.notificationOccurred('success');
        };
        window.copyGeneratedKey = () => copyText(currentOrderKey);

        window.finishOrder = () => {
            const btn = document.getElementById('finishBtn');
            btn.disabled = true; btn.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
            const total = Object.values(cart).reduce((a, b) => a + (b.price * b.qty), 0);
            const itemsText = Object.values(cart).map(i => `${i.name} (x${i.qty})`).join(', ');

            const orderDetails = {
                action: "NEW_ORDER",
                order_key: currentOrderKey,
                items: itemsText,
                total: total + " ‚ÇΩ",
                client: {
                    name: document.getElementById('order_name').value,
                    phone: document.getElementById('order_phone').value,
                    username_or_contact: document.getElementById('order_contact').value,
                    place: document.getElementById('order_location').value,
                    time: document.getElementById('order_time').value
                },
                timestamp: new Date().toLocaleString()
            };
            
            tg.sendData(JSON.stringify(orderDetails)); 
            setTimeout(() => tg.close(), 500);
        };

        window.toggleCart = (s) => { closeSheets(); if(s) { document.getElementById('cartSheet').classList.add('active'); document.getElementById('overlay').classList.add('active'); document.body.style.overflow = 'hidden'; } };
        window.closeSheets = () => { ['cartSheet', 'orderSheet', 'paymentSheet', 'adminForm'].forEach(id => { const el = document.getElementById(id); if(el) el.classList.remove('active'); }); document.getElementById('overlay').classList.remove('active'); document.body.style.overflow = ''; };

    </script>
</body>
</html>
