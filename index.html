<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Vape Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --primary: #00FF41;
            --primary-glow: rgba(0, 255, 65, 0.3);
        }

        body {
            background-color: #000000;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-x: hidden;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .primary-text { color: var(--primary); }
        .primary-bg { background-color: var(--primary); }
        .primary-shadow { box-shadow: 0 0 20px var(--primary-glow); }

        .bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
        }
        .bottom-sheet.open { transform: translateY(0); }

        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, deleteDoc, addDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Config ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vape-store-premium';

        const ADMIN_ID = 1262669099;
        const ADMIN_USERNAME = "Tru5tNoBody";

        const THEMES = [
            { name: 'Toxic Green', color: '#00FF41', glow: 'rgba(0, 255, 65, 0.3)' },
            { name: 'Ice Blue', color: '#00D1FF', glow: 'rgba(0, 209, 255, 0.3)' },
            { name: 'Magma Orange', color: '#FF4D00', glow: 'rgba(255, 77, 0, 0.3)' }
        ];

        const SEED_DATA = [
            { name: "HQD Cuvie Plus", price: 850, emoji: "üíé", category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", desc: "1200 –∑–∞—Ç—è–∂–µ–∫, —á–µ—Ä–Ω–∏–∫–∞-–º–∞–ª–∏–Ω–∞" },
            { name: "Elf Bar BC5000", price: 1250, emoji: "üîã", category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", desc: "5000 –∑–∞—Ç—è–∂–µ–∫, –∑–∞—Ä—è–¥–∫–∞ Type-C" },
            { name: "Lost Mary OS5000", price: 1100, emoji: "‚òÅÔ∏è", category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", desc: "–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞—Ä—è–¥–∞, —Å–æ—á–Ω—ã–µ –≤–∫—É—Å—ã" },
            { name: "Vaporesso XROS 3", price: 3200, emoji: "üõ†Ô∏è", category: "–ü–æ–¥-—Å–∏—Å—Ç–µ–º—ã", desc: "–õ—É—á—à–∞—è –≤–∫—É—Å–æ–ø–µ—Ä–µ–¥–∞—á–∞ 2024" },
            { name: "Santi Pod Kit", price: 2100, emoji: "‚ö°", category: "–ü–æ–¥-—Å–∏—Å—Ç–µ–º—ã", desc: "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ –º–æ—â–Ω—ã–π" },
            { name: "Maxwells Shoria", price: 650, emoji: "üß™", category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", desc: "–ú—è—Ç–∞, —Ö–≤–æ—è –∏ –ª–µ—Å–Ω—ã–µ —è–≥–æ–¥—ã" },
            { name: "Husky Double Ice", price: 550, emoji: "üê∫", category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", desc: "–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π —Ö–æ–ª–æ–¥" },
            { name: "Boshki Original", price: 600, emoji: "üå≤", category: "–ñ–∏–¥–∫–æ—Å—Ç–∏", desc: "–•–≤–æ–π–Ω—ã–π –º–∏–∫—Å —Å –∫–æ–ª–æ–π" },
            { name: "–ò—Å–ø–∞—Ä–∏—Ç–µ–ª—å XROS", price: 350, emoji: "üì¶", category: "–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏", desc: "0.6 / 0.8 / 1.0 Ohm" },
            { name: "–ö–∞—Ä—Ç—Ä–∏–¥–∂ Charon", price: 300, emoji: "üîå", category: "–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏", desc: "–û—Ä–∏–≥–∏–Ω–∞–ª, –¥–æ–ª–≥–∏–π —Å—Ä–æ–∫ —Å–ª—É–∂–±—ã" },
            { name: "Waka PA10000", price: 1950, emoji: "üî•", category: "–û–¥–Ω–æ—Ä–∞–∑–∫–∏", desc: "10000 –∑–∞—Ç—è–∂–µ–∫, Boost mode" }
        ];

        // --- 3D Background Engine ---
        const initThreeBackground = (color) => {
            const canvas = document.getElementById('bg-canvas');
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 3000; i++) {
                vertices.push(THREE.MathUtils.randFloatSpread(15)); // x
                vertices.push(THREE.MathUtils.randFloatSpread(15)); // y
                vertices.push(THREE.MathUtils.randFloatSpread(15)); // z
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            const material = new THREE.PointsMaterial({ 
                color: new THREE.Color(color), 
                size: 0.04, 
                transparent: true, 
                opacity: 0.6 
            });
            const points = new THREE.Points(geometry, material);
            scene.add(points);

            function animate() {
                requestAnimationFrame(animate);
                points.rotation.y += 0.001;
                points.rotation.x += 0.0005;
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            return { scene, points, material };
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [products, setProducts] = useState(SEED_DATA); // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ
            const [cart, setCart] = useState({});
            const [activeCategory, setActiveCategory] = useState("–í—Å–µ");
            const [themeIndex, setThemeIndex] = useState(0);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isCartOpen, setIsCartOpen] = useState(false);
            const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const threeRef = useRef(null);

            const tg = window.Telegram?.WebApp;

            useEffect(() => {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 3D —Ñ–æ–Ω–∞
                threeRef.current = initThreeBackground(THEMES[0].color);

                if (tg) {
                    tg.expand();
                    const userId = tg.initDataUnsafe?.user?.id;
                    const username = tg.initDataUnsafe?.user?.username;
                    if (userId === ADMIN_ID || username === ADMIN_USERNAME) {
                        setIsAdmin(true);
                    }
                }

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error(e); }
                };

                initAuth();
                onAuthStateChanged(auth, setUser);

                setTimeout(() => setIsLoading(false), 2000);
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'vape_items');
                return onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setProducts(items);
                    } else if (isAdmin) {
                        // –ï—Å–ª–∏ –ø—É—Å—Ç–æ –∏ –∑–∞—à–µ–ª –∞–¥–º–∏–Ω - —Å–∏–¥–∏–º –±–∞–∑—É
                        SEED_DATA.forEach(item => addDoc(q, item));
                    }
                });
            }, [user, isAdmin]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const categories = useMemo(() => ["–í—Å–µ", ...new Set(products.map(p => p.category))], [products]);
            const filteredProducts = products.filter(p => activeCategory === "–í—Å–µ" || p.category === activeCategory);

            const toggleTheme = () => {
                const next = (themeIndex + 1) % THEMES.length;
                setThemeIndex(next);
                const theme = THEMES[next];
                document.documentElement.style.setProperty('--primary', theme.color);
                document.documentElement.style.setProperty('--primary-glow', theme.glow);
                if (threeRef.current) threeRef.current.material.color.set(theme.color);
                if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            };

            const addToCart = (id) => {
                setCart(prev => ({ ...prev, [id]: (prev[id] || 0) + 1 }));
                if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            };

            const removeFromCart = (id) => {
                setCart(prev => {
                    const next = { ...prev };
                    if (next[id] > 1) next[id] -= 1;
                    else delete next[id];
                    return next;
                });
            };

            const totalAmount = Object.entries(cart).reduce((sum, [id, qty]) => {
                const p = products.find(x => x.id === id || x.name === id); // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö –±–µ–∑ ID
                return sum + (p ? p.price * qty : 0);
            }, 0);

            const cartCount = Object.values(cart).reduce((a, b) => a + b, 0);

            const handleCheckout = () => {
                const orderId = `VX-${Math.floor(1000 + Math.random() * 9000)}`;
                const itemsStr = Object.entries(cart).map(([id, qty]) => {
                    const p = products.find(x => x.id === id || x.name === id);
                    return `${p.name} x${qty}`;
                }).join(', ');

                const orderData = {
                    orderId,
                    items: itemsStr,
                    total: totalAmount,
                    customer: document.getElementById('name-input')?.value || 'Guest'
                };

                if (tg) tg.sendData(JSON.stringify(orderData));
                else alert(`–ó–∞–∫–∞–∑ ${orderId} –æ—Ñ–æ—Ä–º–ª–µ–Ω!`);
                
                setIsCheckoutOpen(false);
                setCart({});
            };

            if (isLoading) return React.createElement('div', { className: 'fixed inset-0 bg-black flex flex-col items-center justify-center z-[100]' },
                React.createElement('div', { className: 'w-16 h-16 border-4 border-t-green-500 border-white/10 rounded-full animate-spin mb-4' }),
                React.createElement('div', { className: 'text-xs uppercase tracking-[0.3em] font-bold primary-text animate-pulse' }, 'Premium Vape Store')
            );

            return React.createElement('div', { className: 'p-4 pb-32 min-h-screen' },
                // Header
                React.createElement('header', { className: 'flex justify-between items-center mb-6 glass p-4 rounded-2xl sticky top-4 z-40' },
                    React.createElement('div', null,
                        React.createElement('h1', { className: 'text-xl font-black italic leading-none' }, 'PREMIUM STORE'),
                        React.createElement('div', { className: `text-[9px] uppercase tracking-widest mt-1 ${isAdmin ? 'primary-text' : 'opacity-40'}` }, 
                            isAdmin ? '‚óè ADMIN ACCESS' : 'Official Catalog'
                        )
                    ),
                    React.createElement('div', { className: 'flex gap-2' },
                        isAdmin && React.createElement('button', { onClick: () => alert('–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ'), className: 'w-10 h-10 glass rounded-xl flex items-center justify-center' }, 
                            React.createElement('i', { 'data-lucide': 'shield', className: 'w-5 h-5 primary-text' })),
                        React.createElement('button', { onClick: toggleTheme, className: 'w-10 h-10 glass rounded-xl flex items-center justify-center' }, 
                            React.createElement('i', { 'data-lucide': 'palette', className: 'w-5 h-5' }))
                    )
                ),

                // Categories
                React.createElement('div', { className: 'flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2' },
                    categories.map(cat => React.createElement('button', {
                        key: cat,
                        onClick: () => setActiveCategory(cat),
                        className: `px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all ${activeCategory === cat ? 'primary-bg text-black primary-shadow' : 'glass opacity-60'}`
                    }, cat))
                ),

                // Product Grid
                React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
                    filteredProducts.map(p => React.createElement('div', { 
                        key: p.id || p.name,
                        className: 'glass rounded-[30px] p-4 flex flex-col h-full relative fade-in'
                    },
                        isAdmin && React.createElement('button', {
                            onClick: () => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vape_items', p.id)),
                            className: 'absolute top-2 right-2 p-1.5 bg-red-500/20 text-red-500 rounded-full'
                        }, React.createElement('i', { 'data-lucide': 'trash-2', className: 'w-3 h-3' })),

                        React.createElement('div', { className: 'text-4xl mb-4 text-center' }, p.emoji),
                        React.createElement('div', { className: 'flex-grow mb-4' },
                            React.createElement('div', { className: 'text-[9px] uppercase tracking-widest opacity-40 mb-1' }, p.category),
                            React.createElement('h3', { className: 'font-bold text-sm leading-tight' }, p.name),
                            React.createElement('p', { className: 'text-[10px] opacity-50 mt-1 line-clamp-2' }, p.desc)
                        ),
                        React.createElement('div', { className: 'mt-auto pt-2' },
                            React.createElement('div', { className: 'text-lg font-black mb-2' }, `${p.price} ‚ÇΩ`),
                            React.createElement('button', {
                                onClick: () => addToCart(p.id || p.name),
                                className: 'w-full py-2.5 primary-bg text-black text-[10px] font-black uppercase rounded-xl active:scale-95 transition-transform'
                            }, '–í –∫–æ—Ä–∑–∏–Ω—É')
                        )
                    ))
                ),

                // Cart FAB
                cartCount > 0 && React.createElement('div', { className: 'fixed bottom-8 left-4 right-4 z-50' },
                    React.createElement('button', {
                        onClick: () => setIsCartOpen(true),
                        className: 'w-full py-4 primary-bg text-black rounded-2xl flex justify-between px-6 items-center primary-shadow animate-pulse-soft'
                    },
                        React.createElement('div', { className: 'flex gap-3 items-center' },
                            React.createElement('i', { 'data-lucide': 'shopping-cart', className: 'w-5 h-5' }),
                            React.createElement('span', { className: 'font-black uppercase tracking-tighter' }, '–ö–æ—Ä–∑–∏–Ω–∞')
                        ),
                        React.createElement('div', { className: 'flex items-center gap-2' },
                            React.createElement('span', { className: 'bg-black/20 px-2 rounded-md text-xs' }, cartCount),
                            React.createElement('span', { className: 'font-black text-xl' }, `${totalAmount} ‚ÇΩ`)
                        )
                    )
                ),

                // Bottom Sheet Cart
                React.createElement('div', { 
                    className: `fixed inset-0 bg-black/80 z-[60] transition-opacity ${isCartOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}` ,
                    onClick: () => setIsCartOpen(false)
                },
                    React.createElement('div', { 
                        className: `bottom-sheet fixed bottom-0 left-0 right-0 glass rounded-t-[40px] p-6 max-h-[80vh] overflow-y-auto ${isCartOpen ? 'open' : ''}`,
                        onClick: e => e.stopPropagation()
                    },
                        React.createElement('div', { className: 'w-12 h-1 bg-white/20 rounded-full mx-auto mb-6' }),
                        React.createElement('h2', { className: 'text-2xl font-black italic mb-6' }, '–ö–û–†–ó–ò–ù–ê'),
                        
                        React.createElement('div', { className: 'flex flex-col gap-3 mb-8' },
                            Object.entries(cart).map(([id, qty]) => {
                                const p = products.find(x => x.id === id || x.name === id);
                                if (!p) return null;
                                return React.createElement('div', { key: id, className: 'flex items-center justify-between glass p-3 rounded-2xl' },
                                    React.createElement('div', null,
                                        React.createElement('div', { className: 'text-sm font-bold' }, p.name),
                                        React.createElement('div', { className: 'text-xs primary-text' }, `${p.price} ‚ÇΩ`)
                                    ),
                                    React.createElement('div', { className: 'flex items-center gap-3' },
                                        React.createElement('button', { onClick: () => removeFromCart(id), className: 'w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center' }, '-'),
                                        React.createElement('span', { className: 'font-bold' }, qty),
                                        React.createElement('button', { onClick: () => addToCart(id), className: 'w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center' }, '+')
                                    )
                                );
                            })
                        ),

                        React.createElement('button', {
                            onClick: () => { setIsCartOpen(false); setIsCheckoutOpen(true); },
                            className: 'w-full py-4 primary-bg text-black font-black uppercase rounded-2xl'
                        }, '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑')
                    )
                ),

                // Checkout Modal
                isCheckoutOpen && React.createElement('div', { className: 'fixed inset-0 bg-black z-[70] p-6 fade-in' },
                    React.createElement('button', { onClick: () => setIsCheckoutOpen(false), className: 'mb-8 opacity-40' }, '‚Üê –û—Ç–º–µ–Ω–∞'),
                    React.createElement('h2', { className: 'text-3xl font-black italic mb-2' }, '–û–ü–õ–ê–¢–ê'),
                    React.createElement('div', { className: 'glass p-6 rounded-3xl mb-6' },
                        React.createElement('div', { className: 'text-xs opacity-50 mb-1' }, '–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞'),
                        React.createElement('div', { className: 'text-4xl font-black primary-text mb-6' }, `${totalAmount} ‚ÇΩ`),
                        React.createElement('div', { className: 'space-y-4' },
                            React.createElement('input', { id: 'name-input', placeholder: '–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?', className: 'w-full glass p-4 rounded-xl outline-none' }),
                            React.createElement('div', { className: 'bg-white/5 p-4 rounded-2xl border border-dashed border-white/20' },
                                React.createElement('div', { className: 'text-[10px] opacity-40 uppercase mb-2' }, '–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (Ozon)'),
                                React.createElement('div', { className: 'font-mono text-lg' }, '2204 3209 2444 1944'),
                                React.createElement('div', { className: 'text-xs mt-1' }, '–ò–≤–∞–Ω –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á –†.')
                            )
                        )
                    ),
                    React.createElement('button', {
                        onClick: handleCheckout,
                        className: 'w-full py-4 primary-bg text-black font-black uppercase rounded-2xl primary-shadow'
                    }, '–Ø –æ–ø–ª–∞—Ç–∏–ª')
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
